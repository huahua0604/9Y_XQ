import{_ as at,g as st,r as w,u as nt,i as b,k as ot,c as l,b as d,a,t as o,n as j,f as S,d as lt,v as it,F as A,p as ct,o as i}from"./index-8DduXNQB.js";import{g as rt,u as dt,b as ut,r as mt,d as vt,e as bt,f as ft,h as yt}from"./demand-BZcbHWDK.js";import{h as N}from"./axios-mYoW4PSg.js";function pt(f){return N.get(`/api/files/${f}/meta`).then(u=>u.data)}function M(f,u="inline"){return N.get(`/api/files/${f}/${u}`,{responseType:"blob"})}function _t(f){return N.delete(`/api/files/${f}`).then(u=>u.data)}const wt={key:0,class:"container my-4"},Et={class:"d-flex align-items-center justify-content-between mb-3"},ht={class:"d-flex align-items-center gap-2"},Dt={class:"h5 mb-0"},gt={key:0,class:"text-body-secondary small"},At={class:"card shadow-sm mb-3"},Tt={class:"card-body"},kt={class:"row g-3"},It={class:"col-12 col-md-6"},Ct={class:"badge text-bg-info"},xt={class:"col-12 col-md-6"},Rt={class:"col-6 col-md-3"},Mt={class:"col-6 col-md-3"},Nt={class:"col-12 col-md-6"},Lt={class:"col-12 col-md-6"},Ut={class:"card shadow-sm mb-3"},Ot={class:"card-body"},$t={class:"mb-0 text-wrap",style:{"white-space":"pre-wrap"}},Bt={class:"card shadow-sm mb-3"},Pt={class:"card-body"},Vt={class:"input-group"},Ht=["disabled"],jt={class:"card shadow-sm mb-3"},St={class:"card-body"},Ft={class:"mb-2"},Wt={class:"d-flex flex-wrap gap-2"},Jt={class:"card shadow-sm"},zt={class:"card-header fw-semibold d-flex align-items-center justify-content-between"},qt={class:"badge text-bg-light"},Gt={class:"card-body"},Kt={class:"list-group"},Qt={class:"d-flex flex-wrap align-items-center gap-2"},Xt={class:"fw-semibold"},Yt={class:"text-body-secondary small"},Zt={class:"text-body-secondary small"},te={key:0,class:"badge text-bg-secondary ms-2"},ee={key:0,class:"mt-1"},ae={class:"ms-2 d-flex gap-2"},se=["onClick"],ne=["onClick"],oe=["onClick"],le=["onClick"],ie={__name:"DemandDetail",setup(f){const u=st(),m=Number(u.params.id),n=w(null),c=w(""),y=w([]),T=w([]),E=w(!1),k=nt(),L=b(()=>k.user?.roles?.includes("ADMIN")),U=b(()=>k.user?.roles?.includes("REVIEWER")),O=b(()=>k.employeeId);b(()=>n.value?.history??[]);function F(t){const e=Array.from(t.target.files||[]);y.value=e.length?e:null}async function W(){if(!(!y.value||y.value.length===0)){E.value=!0;try{for(const t of y.value)await dt(m,t);window.location.reload()}finally{y.value=null,E.value=!1,I.value&&(I.value.value="")}}}const I=w(null);function C(t){return t?String(t).replace("T"," ").slice(0,19):""}function J(t){switch((t||"").toUpperCase()){case"DRAFT":return"text-bg-secondary";case"SUBMITTED":return"text-bg-info";case"ADMIN_APPROVED":case"IN_REVIEW":return"text-bg-primary";case"RETURNED":return"text-bg-warning";case"REJECTED":return"text-bg-danger";case"APPROVED":case"DONE":return"text-bg-success";default:return"text-bg-secondary"}}function z(t){switch(t){case"DRAFT":return"草稿";case"SUBMITTED":return"待主任审批";case"ADMIN_APPROVED":return"主任同意";case"ADMIN_REJECTED":return"主任驳回";case"REVIEW_APPROVED":return"科室同意";case"REVIEW_REJECTED":return"科室驳回";case"COMPLETED":return"已完成";default:return t||"未知"}}async function $(t){if(!c.value.trim()){alert("请填写审批意见");return}t==="admin"?await ut(m,c.value.trim()):await mt(m,c.value.trim()),c.value="",await p()}async function B(t){if(!c.value.trim()){alert("请填写驳回理由");return}t==="admin"?await vt(m,c.value.trim()):await bt(m,c.value.trim()),c.value="",await p()}async function P(){c.value.trim()&&(await ft(m,c.value.trim()),c.value="",await p())}async function q(){for(const t of T.value)try{URL.revokeObjectURL(t.src)}catch{}if(T.value=[],!!n.value?.attachments?.length){for(const t of n.value.attachments)if(!x.value.has(Number(t.id))&&(t.contentType||"").startsWith("image/"))try{const e=await M(t.id,"inline"),s=e.headers?.["content-type"]||t.contentType,r=new Blob([e.data],{type:s}),_=URL.createObjectURL(r);T.value.push({id:t.id,name:t.originalFilename,src:_})}catch(e){console.warn("跳过无效图片附件",t.id,e?.response?.status);continue}}}async function p(){n.value=await rt(m),await q()}const V=b(()=>{const t=new Set;for(const e of n.value?.history||[])e.action==="COMMENT_DELETED"&&e.commentId!=null&&t.add(`C:${e.commentId}`),e.action==="ATTACHMENT_DELETED"&&e.attachmentId!=null&&t.add(`A:${e.attachmentId}`);return t});function h(t){return t.action==="COMMENT_ADDED"&&t.commentId!=null?V.value.has(`C:${t.commentId}`):t.action==="ATTACHMENT_ADDED"&&t.attachmentId!=null?V.value.has(`A:${t.attachmentId}`):!1}function G(t){return t?.action==="COMMENT_ADDED"&&t?.commentId!=null&&t?.actorEmpId===O.value}function K(t){return t?.action==="ATTACHMENT_ADDED"&&t?.attachmentId!=null&&t?.actorEmpId===O.value}async function Q(t){if(confirm("确定删除该附件？"))try{await _t(t.attachmentId);try{x.value.add(Number(t.attachmentId))}catch{}await p()}catch(e){alert(e?.response?.data?.message||"删除失败")}}const X=b(()=>(n.value?.history||[]).filter(e=>e.action!=="COMMENT_DELETED"&&e.action!=="ATTACHMENT_DELETED"));async function Y(t){if(confirm("确定删除这条评论？"))try{await yt(t.commentId),await p()}catch(e){alert(e?.response?.data?.message||"删除失败")}}const x=b(()=>{const t=new Set,e=n.value?.history||[];for(const s of e)s.action==="ATTACHMENT_DELETED"&&s.attachmentId!=null&&t.add(Number(s.attachmentId));return t});function Z(t){return t?.action==="ATTACHMENT_ADDED"&&t?.attachmentId!=null&&!x.value.has(Number(t.attachmentId))}const D={};async function H(t){if(!D[t])try{D[t]=await pt(t)}catch{D[t]={}}return D[t]||{}}async function tt(t){const e=t.attachmentId,s=window.open("","_blank");try{const r=await H(e),_=await M(e,"inline"),g=_.headers?.["content-type"]||r.contentType||"application/octet-stream",v=new Blob([_.data],{type:g}),R=URL.createObjectURL(v);s?s.location.href=R:window.open(R,"_blank"),setTimeout(()=>URL.revokeObjectURL(R),60*1e3)}catch(r){s&&s.close(),alert(r?.response?.data?.message||"预览失败或附件已被删除")}}async function et(t){const e=t.attachmentId;try{const s=await H(e),r=await M(e,"download"),_=new Blob([r.data],{type:r.headers?.["content-type"]||"application/octet-stream"}),g=URL.createObjectURL(_),v=document.createElement("a");v.href=g,v.download=s.name||`file-${e}`,document.body.appendChild(v),v.click(),v.remove(),setTimeout(()=>URL.revokeObjectURL(g),10*1e3)}catch(s){alert(s?.response?.data?.message||"下载失败或附件已被删除")}}return ot(p),(t,e)=>n.value?(i(),l("div",wt,[a("div",Et,[a("div",ht,[a("h2",Dt,"#"+o(n.value.id)+" "+o(n.value.title),1),a("span",{class:j(["badge",J(n.value.status)])},o(z(n.value.status)),3)]),n.value.submittedAt||n.value.createdAt?(i(),l("div",gt," 最近更新："+o(C(n.value.submittedAt||n.value.createdAt)),1)):d("",!0)]),a("div",At,[e[11]||(e[11]=a("div",{class:"card-header fw-semibold"},"基本信息",-1)),a("div",Tt,[a("div",kt,[a("div",It,[e[5]||(e[5]=a("div",{class:"text-body-secondary small mb-1"},"申请类型",-1)),a("div",null,[a("span",Ct,o(n.value.category||"未分类"),1)])]),a("div",xt,[e[6]||(e[6]=a("div",{class:"text-body-secondary small mb-1"},"影响范围",-1)),a("div",null,o(n.value.impactScope||"-"),1)]),a("div",Rt,[e[7]||(e[7]=a("div",{class:"text-body-secondary small mb-1"},"联系电话",-1)),a("div",null,o(n.value.contactPhone||"-"),1)]),a("div",Mt,[e[8]||(e[8]=a("div",{class:"text-body-secondary small mb-1"},"地点/科室",-1)),a("div",null,o(n.value.location||"-"),1)]),a("div",Nt,[e[9]||(e[9]=a("div",{class:"text-body-secondary small mb-1"},"提交人",-1)),a("div",null,o(n.value.createdByName)+"("+o(n.value.createdByDept)+"/"+o(n.value.createdByEmpId)+")",1)]),a("div",Lt,[e[10]||(e[10]=a("div",{class:"text-body-secondary small mb-1"},"提交时间",-1)),a("div",null,o(C(n.value.submittedAt||n.value.createdAt)),1)])])])]),a("div",Ut,[e[12]||(e[12]=a("div",{class:"card-header fw-semibold"},"需求详情",-1)),a("div",Ot,[a("pre",$t,o(n.value.description),1)])]),a("div",Bt,[e[14]||(e[14]=a("div",{class:"card-header fw-semibold"},"附件",-1)),a("div",Pt,[e[13]||(e[13]=a("div",{class:"alert alert-light border py-2 mb-3",role:"alert"},[S(" 新上传的附件会出现在下方 "),a("b",null,"流转历史"),S(" 中；如需删除，请在流转历史中点击该条记录的“删除”。（仅允许删除本人上传的附件） ")],-1)),a("div",Vt,[a("input",{type:"file",class:"form-control",ref_key:"fileInput",ref:I,multiple:"",onChange:F},null,544),a("button",{class:"btn btn-primary",onClick:W,disabled:!y.value||E.value},o(E.value?"上传中…":"上传附件"),9,Ht)])])]),a("div",jt,[e[15]||(e[15]=a("div",{class:"card-header fw-semibold"},"意见",-1)),a("div",St,[a("div",Ft,[lt(a("textarea",{class:"form-control",rows:"4","onUpdate:modelValue":e[0]||(e[0]=s=>c.value=s),placeholder:"填写意见..."},null,512),[[it,c.value]])]),a("div",Wt,[L.value?(i(),l(A,{key:0},[n.value.status==="SUBMITTED"?(i(),l("button",{key:0,class:"btn btn-success",onClick:e[1]||(e[1]=s=>$("admin"))},"主任同意")):d("",!0),n.value.status==="SUBMITTED"?(i(),l("button",{key:1,class:"btn btn-danger",onClick:e[2]||(e[2]=s=>B("admin"))},"主任驳回")):d("",!0)],64)):d("",!0),U.value?(i(),l(A,{key:1},[n.value.status==="ADMIN_APPROVED"?(i(),l("button",{key:0,class:"btn btn-success",onClick:e[3]||(e[3]=s=>$("reviewer"))},"科室同意")):d("",!0),n.value.status==="ADMIN_APPROVED"?(i(),l("button",{key:1,class:"btn btn-danger",onClick:e[4]||(e[4]=s=>B("reviewer"))},"科室驳回")):d("",!0)],64)):d("",!0),L.value||U.value?(i(),l("button",{key:2,class:"btn btn-outline-secondary",onClick:P},"仅发表意见")):(i(),l("button",{key:3,class:"btn btn-primary",onClick:P},"发布"))])])]),a("div",Jt,[a("div",zt,[e[16]||(e[16]=a("span",null,"流转历史",-1)),a("span",qt,o(n.value.history?.length||0),1)]),a("div",Gt,[a("ul",Kt,[(i(!0),l(A,null,ct(X.value,s=>(i(),l("li",{key:s.id??s.occurredAt+"-"+s.action,class:j(["list-group-item d-flex justify-content-between align-items-start",{"text-decoration-line-through opacity-75":h(s)}])},[a("div",null,[a("div",Qt,[a("span",Xt,o(s.actorName),1),a("span",Yt,"("+o(s.actorEmpId)+")",1),a("span",Zt," @ "+o(C(s.occurredAt)),1),h(s)?(i(),l("span",te,"已删除")):d("",!0)]),s.note?(i(),l("div",ee,o(s.note),1)):d("",!0)]),a("div",ae,[Z(s)?(i(),l(A,{key:0},[a("button",{class:"btn btn-sm btn-outline-primary",onClick:r=>tt(s)},"预览",8,se),a("button",{class:"btn btn-sm btn-outline-secondary",onClick:r=>et(s)},"下载",8,ne)],64)):d("",!0),G(s)&&!h(s)?(i(),l("button",{key:1,class:"btn btn-sm btn-outline-danger",onClick:r=>Y(s)},"删除",8,oe)):K(s)&&!h(s)?(i(),l("button",{key:2,class:"btn btn-sm btn-outline-danger",onClick:r=>Q(s)},"删除",8,le)):d("",!0)])],2))),128))])])])])):d("",!0)}},ue=at(ie,[["__scopeId","data-v-d7fa50cb"]]);export{ue as default};
