import{_ as nt,u as ot,r as p,i as D,k as rt,c as d,a as s,d as V,v as it,b as at,f as lt,n as h,m as ct,F as ut,p as dt,h as ft,o as f,t as E,w as Et}from"./index-BCFNTfTT.js";import{d as N,i as pt}from"./isoWeek-D1M7nHiN.js";import{a as yt,g as _t}from"./demand-Bm2CkUI9.js";import"./axios-CP6D1eTq.js";const mt={class:"container my-4"},gt={class:"d-flex align-items-center justify-content-between mb-3"},vt={class:"d-flex align-items-center gap-2"},bt=["disabled"],Dt={key:0,class:"spinner-border spinner-border-sm me-1","aria-hidden":"true"},ht={class:"card shadow-sm"},Nt={class:"card-body pb-2"},Tt={class:"d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3"},xt={class:"nav nav-pills gap-2 mb-0"},Ot={class:"nav-item"},wt={class:"nav-item"},Mt={class:"d-flex align-items-center gap-2"},kt={key:0,class:"d-flex align-items-center gap-2 text-muted py-4 justify-content-center"},Rt={key:1},St={key:0,class:"table-responsive"},Ct={class:"table table-hover table-striped align-middle mb-0"},At=["onClick"],Wt={class:"text-body-secondary"},It={class:"fw-semibold"},Ut={class:"text-truncate",style:{"max-width":"220px"}},Vt={class:"d-flex flex-column"},Kt={class:"text-body-secondary"},Ft={class:"text-nowrap"},Pt={class:"text-nowrap"},Bt=["onClick"],Jt={key:1,class:"alert alert-light border d-flex align-items-center m-0",role:"alert"},Lt={__name:"Inbox",setup($t){N.extend(pt);const K=ft(),w=ot(),T=p([]),y=p(!1),_=p("todo"),g=p(""),v=p(""),x=p({}),M=D(()=>w.user?.roles||w.roles||[]),F=D(()=>M.value.includes("ADMIN")),P=D(()=>M.value.includes("REVIEWER"));function B(e){return e?e.replace("T"," ").slice(0,19):""}function k(e){K.push(`/demands/${e.id}`)}function J(e){const t=String(e||"").trim();return t==="临时"?"text-bg-primary":t==="周报"?"text-bg-info":t==="月报"?"text-bg-warning":"text-bg-secondary"}function L(e){const t=String(e||"");return t.includes("周报")||t.includes("月报")}function $(e){return String(e||"").includes("周报")}function H(e){return String(e||"").includes("月报")}function j(e){const t=String(e??"").trim();if(!t)return null;if(t.startsWith("{"))try{const r=JSON.parse(t);if(r&&typeof r.key=="string"&&r.key)return r.key}catch{}const n=t.match(/\b(\d{4})-W(\d{1,2})\b/);if(n)return`${n[1]}-W${String(n[2]).padStart(2,"0")}`;const o=t.match(/\b(\d{4})-(\d{1,2})\b/);return o?`${o[1]}-${String(o[2]).padStart(2,"0")}`:null}function z(e){const t=String(e||"").toUpperCase(),n=/(UNMARK|UNDO|UNSET|CANCEL|REVOKE|ROLLBACK)/.test(t)||/^UN/.test(t),o=/WEEK/.test(t)||/W(\d{1,2})\b/.test(t),r=/MONTH/.test(t)||/\b\d{4}-\d{1,2}\b/.test(t);return{raw:t,isUndo:n,isWeek:o,isMonth:r}}function R(e){const t=/^(\d{4})-W(\d{1,2})$/.exec(String(e||""));if(!t)return null;const n=Number(t[1]),o=Number(t[2]);return{year:n,week:o,sort:n*100+o}}function S(e){const t=/^(\d{4})-(\d{1,2})$/.exec(String(e||""));if(!t)return null;const n=Number(t[1]),o=Number(t[2]);return{year:n,month:o,sort:n*100+o}}function Y(e,t){if(!e||e.size===0)return!1;const n=t.isoWeekYear(),o=t.isoWeek();let r=null,l=-1/0;for(const[a]of e.entries()){const i=R(a);if(!i)continue;(i.year<n||i.year===n&&i.week<=o)&&i.sort>l&&(l=i.sort,r=a)}if(!r)for(const[a]of e.entries()){const i=R(a);i&&i.sort>l&&(l=i.sort,r=a)}return r?!!e.get(r):!1}function q(e,t){if(!e||e.size===0)return!1;const n=t.year(),o=t.month()+1;let r=null,l=-1/0;for(const[a]of e.entries()){const i=S(a);if(!i)continue;(i.year<n||i.year===n&&i.month<=o)&&i.sort>l&&(l=i.sort,r=a)}if(!r)for(const[a]of e.entries()){const i=S(a);i&&i.sort>l&&(l=i.sort,r=a)}return r?!!e.get(r):!1}function O(e){const t=x.value[e.id];return t||String(e&&e.status||"")}function G(e){const t=String(O(e));switch(t){case"WEEK_DONE":return"上周已完成";case"WEEK_NOT_DONE":return"上周未完成";case"MONTH_DONE":return"上月已完成";case"MONTH_NOT_DONE":return"上月未完成";case"COMPLETED":return"已完成";case"DRAFT":return"草稿";case"SUBMITTED":return"待主任审批";case"ADMIN_APPROVED":return"主任同意";case"ADMIN_REJECTED":return"主任驳回";case"REVIEW_APPROVED":return"科室同意";case"REVIEW_REJECTED":return"科室驳回";case"RETURNED":return"退回修改";case"REJECTED":return"已拒绝";default:return t||"未知"}}function Q(e){switch(String(O(e)).toUpperCase()){case"DRAFT":return"text-bg-secondary";case"SUBMITTED":return"text-bg-info";case"ADMIN_APPROVED":case"IN_REVIEW":return"text-bg-primary";case"RETURNED":return"text-bg-warning";case"ADMIN_REJECTED":case"REVIEW_REJECTED":case"REJECTED":return"text-bg-danger";case"COMPLETED":case"WEEK_DONE":case"MONTH_DONE":return"text-bg-success";case"WEEK_NOT_DONE":case"MONTH_NOT_DONE":return"text-bg-secondary";default:return"text-bg-secondary"}}function X(e){const t=String(O(e)).toUpperCase();return["COMPLETED","WEEK_DONE","MONTH_DONE"].includes(t)?"done":["ADMIN_REJECTED","REVIEW_REJECTED","REJECTED"].includes(t)?"rejected":(["SUBMITTED","ADMIN_APPROVED","IN_REVIEW","RETURNED","WEEK_NOT_DONE","MONTH_NOT_DONE","DRAFT"].includes(t),"processing")}function Z(e){const t=String(e?.status||""),n=F.value&&t==="SUBMITTED",o=P.value&&t==="ADMIN_APPROVED";return n||o}async function tt(){const e=T.value.filter(o=>L(o.category)),t={};if(!e.length){x.value=t;return}const n=N();for(const o of e)try{const r=await _t(o.id),l=String(r?.category||o.category||""),a=String(r?.status||o.status||""),i=$(l),b=H(l);if(!i&&!b){t[o.id]=a;continue}if(["DRAFT","SUBMITTED","ADMIN_APPROVED","ADMIN_REJECTED","REVIEW_REJECTED","RETURNED"].includes(a)){t[o.id]=a;continue}const et=(Array.isArray(r?.history)?r.history:[]).slice().sort((c,u)=>{const m=N(c?.occurredAt).valueOf()||0,st=N(u?.occurredAt).valueOf()||0;return m-st}),I=new Map,U=new Map;for(const c of et){const u=z(c?.action);if(!u.isWeek&&!u.isMonth)continue;const m=j(c?.note)||(typeof c?.key=="string"?c.key:null);m&&(u.isWeek&&I.set(m,!u.isUndo),u.isMonth&&U.set(m,!u.isUndo))}if(i){const c=Y(I,n);t[o.id]=c?"WEEK_DONE":"WEEK_NOT_DONE"}else if(b){const c=q(U,n);t[o.id]=c?"MONTH_DONE":"MONTH_NOT_DONE"}else t[o.id]=a}catch{t[o.id]=String(o&&o.status||"")}x.value=t}async function C(){y.value=!0;try{T.value=await yt(),await tt()}finally{y.value=!1}}function A(e){_.value!==e&&(_.value=e)}const W=D(()=>{let e=T.value.slice();if(_.value==="todo"&&(e=e.filter(Z)),g.value&&(e=e.filter(t=>X(t)===g.value)),v.value){const t=v.value.toLowerCase();e=e.filter(n=>String(n.title||"").toLowerCase().includes(t)||String(n.createdByName||"").toLowerCase().includes(t))}return e});return rt(C),(e,t)=>(f(),d("div",mt,[s("div",gt,[t[5]||(t[5]=s("h2",{class:"h4 mb-0"},"审批收件箱",-1)),s("div",vt,[V(s("input",{"onUpdate:modelValue":t[0]||(t[0]=n=>v.value=n),placeholder:"按标题/提交人搜索…",class:"form-control form-control-sm",style:{"min-width":"120px","flex-shrink":"1"}},null,512),[[it,v.value,void 0,{trim:!0}]]),s("button",{class:"btn btn-sm btn-primary",style:{"white-space":"nowrap"},onClick:C,disabled:y.value},[y.value?(f(),d("span",Dt)):at("",!0),t[4]||(t[4]=lt(" 刷新 ",-1))],8,bt)])]),s("div",ht,[s("div",Nt,[s("div",Tt,[s("ul",xt,[s("li",Ot,[s("button",{class:h(["nav-link",{active:_.value==="todo"}]),onClick:t[1]||(t[1]=n=>A("todo"))}," 待我审批 ",2)]),s("li",wt,[s("button",{class:h(["nav-link",{active:_.value==="all"}]),onClick:t[2]||(t[2]=n=>A("all"))}," 全部 ",2)])]),s("div",Mt,[t[7]||(t[7]=s("label",{class:"form-label mb-0"},"状态：",-1)),V(s("select",{class:"form-select form-select-sm w-auto","onUpdate:modelValue":t[3]||(t[3]=n=>g.value=n)},[...t[6]||(t[6]=[s("option",{value:""},"全部",-1),s("option",{value:"processing"},"流程中",-1),s("option",{value:"rejected"},"驳回",-1),s("option",{value:"done"},"已完成",-1)])],512),[[ct,g.value]])])]),y.value?(f(),d("div",kt,[...t[8]||(t[8]=[s("div",{class:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"},null,-1),s("span",null,"加载中…",-1)])])):(f(),d("div",Rt,[W.value.length?(f(),d("div",St,[s("table",Ct,[t[9]||(t[9]=s("thead",{class:"table-light"},[s("tr",null,[s("th",{style:{width:"90px"}},"ID"),s("th",null,"标题"),s("th",{style:{width:"120px"}},"申请类型"),s("th",{style:{width:"140px"}},"状态"),s("th",{style:{width:"120px"}},"提交人"),s("th",{style:{width:"180px"}},"时间"),s("th",{style:{width:"90px"}},"操作")])],-1)),s("tbody",null,[(f(!0),d(ut,null,dt(W.value,n=>(f(),d("tr",{key:n.id,class:"cursor-pointer",onClick:o=>k(n)},[s("td",Wt,"#"+E(n.id),1),s("td",It,[s("div",Ut,E(n.title),1)]),s("td",null,[s("span",{class:h(["badge",J(n.category)])},E(n.category||"未分类"),3)]),s("td",null,[s("span",{class:h(["badge",Q(n)])},E(G(n)),3)]),s("td",null,[s("div",Vt,[s("span",null,E(n.createdByName),1),s("small",Kt,E(n.createdByDept),1)])]),s("td",Ft,E(B(n.submittedAt||n.createdAt)),1),s("td",Pt,[s("button",{class:"btn btn-sm btn-outline-primary",onClick:Et(o=>k(n),["stop"])}," 查看 ",8,Bt)])],8,At))),128))])])])):(f(),d("div",Jt,[...t[10]||(t[10]=[s("i",{class:"bi bi-inbox me-2","aria-hidden":"true"},null,-1),s("div",null,"暂无数据",-1)])]))]))])])]))}},Qt=nt(Lt,[["__scopeId","data-v-906f32df"]]);export{Qt as default};
