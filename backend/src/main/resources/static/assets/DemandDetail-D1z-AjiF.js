import{_ as mt,g as ft,r as g,u as vt,i as y,A as U,k as yt,B as bt,c as i,b as k,a,t as v,n as q,f as $e,d as de,v as kt,F as w,p as B,l as Ie,w as Q,o as c}from"./index-L6f31KK7.js";import{d as p,i as pt}from"./isoWeek-D1M7nHiN.js";import{g as ht,u as wt,b as Et,r as Dt,d as gt,e as _t,f as At,m as Mt,h as Tt,i as Nt,j as Ct,k as Ot,n as $t,o as It}from"./demand-DBZ5Xo_c.js";import{h as fe}from"./axios-DQV6b0rz.js";function St(O){return fe.get(`/api/files/${O}/meta`).then(T=>T.data)}function me(O,T="inline"){return fe.get(`/api/files/${O}/${T}`,{responseType:"blob"})}function Wt(O){return fe.delete(`/api/files/${O}`).then(T=>T.data)}const Rt={key:0,class:"container my-4"},xt={class:"d-flex align-items-center justify-content-between mb-3"},Ut={class:"d-flex align-items-center gap-2"},Pt={class:"h5 mb-0"},Lt={key:0,class:"text-body-secondary small"},Kt={class:"card shadow-sm mb-3"},Ht={class:"card-body"},Vt={class:"row g-3"},Bt={class:"col-12 col-md-6"},Ft={class:"badge text-bg-info"},jt={class:"col-12 col-md-6"},Jt={class:"col-6 col-md-3"},Yt={class:"col-6 col-md-3"},zt={class:"col-12 col-md-6"},Gt={class:"col-12 col-md-6"},qt={class:"card shadow-sm mb-3"},Qt={class:"card-body"},Xt={class:"mb-0 text-wrap",style:{"white-space":"pre-wrap"}},Zt={class:"card shadow-sm mb-3"},en={class:"card-body"},tn={class:"input-group"},nn=["disabled"],sn={class:"card shadow-sm mb-3"},an={class:"card-header fw-semibold d-flex align-items-center justify-content-between"},on={key:0,class:"text-body-secondary"},ln={class:"card-body"},rn={class:"mb-2"},cn={class:"d-flex flex-wrap gap-2 align-items-center"},un={class:"card shadow-sm"},dn={class:"card-header fw-semibold d-flex align-items-center justify-content-between flex-wrap gap-2"},mn={class:"d-flex align-items-center gap-2 flex-wrap"},fn={class:"btn-group btn-group-sm",role:"group","aria-label":"分组"},vn=["onClick"],yn={class:"form-check form-check-sm ms-1"},bn={class:"form-check form-check-sm ms-1"},kn={class:"dropdown"},pn={class:"btn btn-sm btn-outline-primary dropdown-toggle",type:"button","data-bs-toggle":"dropdown"},hn={class:"dropdown-menu dropdown-menu-end weeks-menu"},wn=["onClick"],En={key:2,class:"btn btn-outline-secondary btn-sm",disabled:""},Dn={class:"dropdown"},gn={class:"btn btn-sm btn-outline-primary dropdown-toggle",type:"button","data-bs-toggle":"dropdown"},_n={class:"dropdown-menu dropdown-menu-end months-menu"},An=["onClick"],Mn={key:2,class:"btn btn-outline-secondary btn-sm",disabled:""},Tn={class:"card-body"},Nn={key:0,class:"small text-body-secondary fw-semibold mb-1 mt-2"},Cn={class:"badge text-bg-light ms-1"},On={class:"list-group mb-2"},$n={class:"d-flex flex-wrap align-items-center gap-2"},In={class:"fw-semibold"},Sn={class:"text-body-secondary small"},Wn={class:"text-body-secondary small"},Rn={key:0,class:"badge text-bg-secondary ms-2"},xn={class:"ms-2 d-flex gap-2"},Un=["onClick"],Pn=["onClick"],Ln=["onClick"],Kn=["onClick"],Hn={key:0,class:"text-body-secondary small"},Se="historyViewPrefs/v2",Vn={__name:"DemandDetail",setup(O){p.extend(pt);const T=ft(),E=Number(T.params.id),r=g(null),h=g(""),$=g([]),X=g([]),F=g(!1),Z=vt(),I=y(()=>Z.user?.roles?.includes("ADMIN")),S=y(()=>Z.user?.roles?.includes("REVIEWER")),j=y(()=>Z.employeeId),P=g(!1),N=y(()=>{const e=r.value?.category||"";return e.includes("周报")||e.includes("月报")}),ee=y(()=>(r.value?.category||"").includes("周报")),te=y(()=>(r.value?.category||"").includes("月报")),ve=y(()=>ee.value?[{key:"none",label:"不分组"},{key:"week",label:"按周"}]:te.value?[{key:"none",label:"不分组"},{key:"month",label:"按月"}]:[{key:"none",label:"不分组"},{key:"week",label:"按周"},{key:"month",label:"按月"}]),We=y(()=>!N.value&&r.value?.status==="REVIEW_APPROVED"),Re=y(()=>!N.value&&r.value?.status==="COMPLETED"),f=g("week"),A=g("all"),C=g(!1);U(ve,e=>{e.map(n=>n.key).includes(f.value)||(f.value=e[0]?.key||"none")},{immediate:!0});const d=g(""),m=g(""),ye=g(!1);function xe(){if(ye.value)return;const e=(r.value?.category||"").toString();e.includes("周报")?(f.value="week",A.value="all"):e.includes("月报")&&(f.value="month",A.value="all"),ye.value=!0}function Ue(e){const t=Array.from(e.target.files||[]);$.value=t.length?t:null}function Pe(e){const t=String(e||"").trim();if(f.value==="week"&&m.value){const n=m.value,s=M(n);return JSON.stringify({key:n,label:s,filename:t})}if(f.value==="month"&&d.value){const n=d.value,s=M(n);return JSON.stringify({key:n,label:s,filename:t})}return t}function Le(){if(f.value==="week"&&m.value){const e=W(m.value);if(e)return p().year(e.year).month(0).date(4).isoWeek(e.week).startOf("isoWeek").hour(12).minute(0).second(0).format("YYYY-MM-DDTHH:mm:ss")}if(f.value==="month"&&d.value){const e=R(d.value);if(e)return p().year(e.year).month(e.month-1).date(15).hour(12).minute(0).second(0).format("YYYY-MM-DDTHH:mm:ss")}return""}async function Ke(){if(!(!$.value||$.value.length===0)){F.value=!0;try{for(const e of $.value){const t=Pe(e?.name),n=Le();await wt(E,e,{note:t,occurredAt:n})}await D()}catch(e){console.error("附件上传失败",e),alert(e?.response?.data?.message||e?.message||"附件上传失败")}finally{$.value=null,F.value=!1,ne.value&&(ne.value.value="")}}}const ne=g(null);function se(e){return e?String(e).replace("T"," ").slice(0,19):""}function He(e){switch((e||"").toUpperCase()){case"DRAFT":return"text-bg-secondary";case"SUBMITTED":return"text-bg-info";case"ADMIN_APPROVED":case"IN_REVIEW":return"text-bg-primary";case"RETURNED":return"text-bg-warning";case"REJECTED":return"text-bg-danger";case"APPROVED":case"DONE":return"text-bg-success";case"COMPLETED":return"text-bg-success";case"WEEK_DONE":case"MONTH_DONE":return"text-bg-success";case"WEEK_NOT_DONE":case"MONTH_NOT_DONE":return"text-bg-secondary";default:return"text-bg-secondary"}}function be(e){switch(e){case"DRAFT":return"草稿";case"SUBMITTED":return"待主任审批";case"ADMIN_APPROVED":return"主任同意";case"ADMIN_REJECTED":return"主任驳回";case"REVIEW_APPROVED":return"科室同意";case"REVIEW_REJECTED":return"科室驳回";case"COMPLETED":return"已完成";case"WEEK_DONE":return"上周已完成";case"WEEK_NOT_DONE":return"上周未完成";case"MONTH_DONE":return"上月已完成";case"MONTH_NOT_DONE":return"上月未完成";default:return e||"未知"}}async function ke(e){if(!h.value.trim()){alert("请填写审批意见");return}e==="admin"?await Et(E,h.value.trim()):await Dt(E,h.value.trim()),h.value="",await D()}async function pe(e){if(!h.value.trim()){alert("请填写驳回理由");return}e==="admin"?await gt(E,h.value.trim()):await _t(E,h.value.trim()),h.value="",await D()}function Ve(e){const t=e.trim();if(!t)return"";if(N.value){if(f.value==="week"&&m.value){const n=m.value,s=M(n);return JSON.stringify({key:n,label:s,text:t})}if(f.value==="month"&&d.value){const n=d.value,s=M(n);return JSON.stringify({key:n,label:s,text:t})}}return t}async function he(){const e=h.value.trim();if(!e)return;const t=Ve(e);await At(E,t),h.value="",await D()}async function Be(){await Mt(E,h.value.trim()||""),h.value="",await D()}async function Fe(){await Tt(E,h.value.trim()||""),h.value="",await D()}function ae(){const e=p().subtract(1,"week"),t=`${e.isoWeekYear()}-W${String(e.isoWeek()).padStart(2,"0")}`,n=e.startOf("isoWeek"),s=e.endOf("isoWeek"),o=`${e.isoWeekYear()}年第${e.isoWeek()}周（${n.format("MM/DD")}~${s.format("MM/DD")}）`;return{key:t,label:o}}function oe(){if(m.value){const e=H.value.find(t=>t.key===m.value);return{key:m.value,label:e?.label||m.value}}return ae()}function le(){if(d.value){const s=K.value.find(o=>o.key===d.value);return{key:d.value,label:s?.label||d.value}}const e=p().subtract(1,"month"),t=`${e.year()}-${String(e.month()+1).padStart(2,"0")}`,n=`${e.year()}年${String(e.month()+1).padStart(2,"0")}月`;return{key:t,label:n}}async function je(){const{key:e,label:t}=oe();await Nt(E,e,t),await D()}async function Je(){const{key:e,label:t}=oe();await Ct(E,e,t),await D()}async function Ye(){const{key:e,label:t}=le();await Ot(E,e,t),await D()}async function ze(){const{key:e,label:t}=le();await $t(E,e,t),await D()}async function Ge(){for(const e of X.value)try{URL.revokeObjectURL(e.src)}catch{}if(X.value=[],!!r.value?.attachments?.length){for(const e of r.value.attachments)if(!ie.value.has(Number(e.id))&&(e.contentType||"").startsWith("image/"))try{const t=await me(e.id,"inline"),n=t.headers?.["content-type"]||e.contentType,s=new Blob([t.data],{type:n}),o=URL.createObjectURL(s);X.value.push({id:e.id,name:e.originalFilename,src:o})}catch(t){console.warn("跳过无效图片附件",e.id,t?.response?.status);continue}}}async function D(){r.value=await ht(E),await Ge()}const we=y(()=>{const e=new Set;for(const t of r.value?.history||[])t.action==="COMMENT_DELETED"&&t.commentId!=null&&e.add(`C:${t.commentId}`),t.action==="ATTACHMENT_DELETED"&&t.attachmentId!=null&&e.add(`A:${t.attachmentId}`);return e});function L(e){return e.action==="COMMENT_ADDED"&&e.commentId!=null?we.value.has(`C:${e.commentId}`):e.action==="ATTACHMENT_ADDED"&&e.attachmentId!=null?we.value.has(`A:${e.attachmentId}`):!1}function qe(e){return e?.action==="COMMENT_ADDED"&&e?.commentId!=null&&e?.actorEmpId===j.value}function Qe(e){return e?.action==="ATTACHMENT_ADDED"&&e?.attachmentId!=null&&e?.actorEmpId===j.value}async function Xe(e){if(confirm("确定删除该附件？"))try{await Wt(e.attachmentId);try{ie.value.add(Number(e.attachmentId))}catch{}await D()}catch(t){alert(t?.response?.data?.message||"删除失败")}}const re=y(()=>(r.value?.history||[]).filter(t=>!(t.action==="COMMENT_DELETED"||t.action==="ATTACHMENT_DELETED"||!P.value&&L(t))));async function Ze(e){if(confirm("确定删除这条评论？"))try{await It(e.commentId),await D()}catch(t){alert(t?.response?.data?.message||"删除失败")}}const ie=y(()=>{const e=new Set,t=r.value?.history||[];for(const n of t)n.action==="ATTACHMENT_DELETED"&&n.attachmentId!=null&&e.add(Number(n.attachmentId));return e});function et(e){return e?.action==="ATTACHMENT_ADDED"&&e?.attachmentId!=null&&!ie.value.has(Number(e.attachmentId))}const J={};async function Ee(e){if(!J[e])try{J[e]=await St(e)}catch{J[e]={}}return J[e]||{}}async function tt(e){const t=e.attachmentId,n=window.open("","_blank");try{const s=await Ee(t),o=await me(t,"inline"),l=o.headers?.["content-type"]||s.contentType||"application/octet-stream",u=new Blob([o.data],{type:l}),b=URL.createObjectURL(u);n?n.location.href=b:window.open(b,"_blank"),setTimeout(()=>URL.revokeObjectURL(b),60*1e3)}catch(s){n&&n.close(),alert(s?.response?.data?.message||"预览失败或附件已被删除")}}async function nt(e){const t=e.attachmentId;try{const n=await Ee(t),s=await me(t,"download"),o=new Blob([s.data],{type:s.headers?.["content-type"]||"application/octet-stream"}),l=URL.createObjectURL(o),u=document.createElement("a");u.href=l,u.download=n.name||`file-${t}`,document.body.appendChild(u),u.click(),u.remove(),setTimeout(()=>URL.revokeObjectURL(l),10*1e3)}catch(n){alert(n?.response?.data?.message||"下载失败或附件已被删除")}}function Y(e){const t=p(e);return{y:t.isoWeekYear(),w:t.isoWeek()}}const K=y(()=>{const e=new Map;for(const t of re.value){if(C.value&&t.action!=="ATTACHMENT_ADDED")continue;const n=V(t);!n||!R(n.key)||e.has(n.key)||e.set(n.key,{key:n.key,label:n.label,sort:n.sort})}return[...e.values()].sort((t,n)=>n.sort-t.sort)}),H=y(()=>{const e=new Map;for(const t of re.value){if(C.value&&t.action!=="ATTACHMENT_ADDED")continue;const n=V(t);!n||!W(n.key)||e.has(n.key)||e.set(n.key,{key:n.key,label:n.label,sort:n.sort})}return[...e.values()].sort((t,n)=>n.sort-t.sort)}),st=y(()=>d.value?`月份：${K.value.find(e=>e.key===d.value)?.label||d.value}`:"选择月份"),at=y(()=>m.value?`周次：${H.value.find(e=>e.key===m.value)?.label||m.value}`:"选择周");function De(e){d.value=e,e&&(A.value="all"),m.value=""}function ge(e){m.value=e,e&&(A.value="all"),d.value=""}function _e(){const e=H.value;if(!e.length)return"";const{key:t}=ae(),n=W(t);if(!n)return e[0].key;const s=n.sort;let o=e[0],l=Math.abs((e[0].sort??0)-s);for(const u of e){const b=Math.abs((u.sort??0)-s);b<l&&(o=u,l=b)}return o.key}function Ae(){const e=K.value;if(!e.length)return"";const t=p().subtract(1,"month"),n=`${t.year()}-${String(t.month()+1).padStart(2,"0")}`,s=R(n);if(!s)return e[0].key;const o=s.sort;let l=e[0],u=Math.abs((e[0].sort??0)-o);for(const b of e){const _=Math.abs((b.sort??0)-o);_<u&&(l=b,u=_)}return l.key}U(f,e=>{if(e==="none"){d.value="",m.value="";return}if(e==="week"&&(d.value="",!m.value)){const t=_e();t&&(m.value=t)}if(e==="month"&&(m.value="",!d.value)){const t=Ae();t&&(d.value=t)}});const Me=y(()=>{const e=re.value,t=p(),{y:n,w:s}=Y(t),{y:o,w:l}=Y(t.subtract(1,"week"));return e.filter(u=>{if(C.value&&u.action!=="ATTACHMENT_ADDED")return!1;const b=V(u);if(f.value==="week"&&m.value&&(!b||b.key!==m.value)||f.value==="month"&&d.value&&(!b||b.key!==d.value))return!1;const _=p(u.occurredAt);if(!_.isValid())return!1;switch(A.value){case"thisWeek":{const{y:x,w:ue}=Y(_);return x===n&&ue===s}case"lastWeek":{const{y:x,w:ue}=Y(_);return x===o&&ue===l}case"thisMonth":return _.year()===t.year()&&_.month()===t.month();case"lastMonth":{const x=t.subtract(1,"month");return _.year()===x.year()&&_.month()===x.month()}default:return!0}})}),ot=y(()=>{const e=Me.value;if(f.value==="week"){const n=new Map;for(const o of e){const l=V(o);l&&(n.has(l.key)||n.set(l.key,{key:l.key,label:l.label,sort:l.sort,items:[]}),n.get(l.key).items.push(o))}const s=[...n.values()].sort((o,l)=>l.sort-o.sort);return s.forEach(o=>o.items.sort((l,u)=>p(u.occurredAt).valueOf()-p(l.occurredAt).valueOf())),s}if(f.value==="month"){const n=new Map;for(const o of e){const l=V(o);l&&(n.has(l.key)||n.set(l.key,{...l,items:[]}),n.get(l.key).items.push(o))}const s=[...n.values()].sort((o,l)=>l.sort-o.sort);return s.forEach(o=>o.items.sort((l,u)=>p(u.occurredAt).valueOf()-p(l.occurredAt).valueOf())),s}return[{key:"all",label:"全部",items:e.slice().sort((n,s)=>p(s.occurredAt).valueOf()-p(n.occurredAt).valueOf())}]});yt(async()=>{try{const e=JSON.parse(localStorage.getItem(Se)||"{}");e.viewGrouping&&(f.value=e.viewGrouping),e.timeFilter&&(A.value=e.timeFilter),typeof e.onlyAttachments=="boolean"&&(C.value=e.onlyAttachments),typeof e.selectedMonthKey=="string"&&(d.value=e.selectedMonthKey),typeof e.selectedWeekKey=="string"&&(m.value=e.selectedWeekKey),typeof e.showDeleted=="boolean"&&(P.value=e.showDeleted)}catch{}await D(),await bt(),xe()}),U([f,A,C,d,m,P],([e,t,n,s,o,l])=>{localStorage.setItem(Se,JSON.stringify({viewGrouping:e,timeFilter:t,onlyAttachments:n,selectedMonthKey:s,selectedWeekKey:o,showDeleted:l}))}),U(H,e=>{if(f.value==="week"){if(!m.value&&e.length){const t=_e();t&&(m.value=t);return}m.value&&(e.some(n=>n.key===m.value)||(m.value=""))}}),U(K,e=>{if(f.value==="month"){if(!d.value&&e.length){const t=Ae();t&&(d.value=t);return}d.value&&(e.some(n=>n.key===d.value)||(d.value=""))}}),U(A,e=>{e!=="all"&&(d.value="",m.value="")});function ce(e){if(!e||typeof e!="string")return null;try{const t=JSON.parse(e);return t&&typeof t=="object"?t:null}catch{return null}}function lt(e){const t=ce(e);if(t?.label)return String(t.label);const n=/"label"\s*:\s*"([^"]+)"/.exec(e||"");return n?n[1]:(e||"").trim()}function z(e){const t=String(e||"").toUpperCase(),n=/(UNMARK|UNDO|UNSET|CANCEL|REVOKE|ROLLBACK)/.test(t)||/^UN/.test(t),s=/WEEK/.test(t)||/W(\d{1,2})/.test(t),o=/MONTH/.test(t)||/-?\d{4}-\d{1,2}/.test(t),l=!s&&!o&&/(COMPLETE|COMPLETED|DONE|FINISH|FINISHED)/.test(t);return{raw:t,isUndo:n,isWeek:s,isMonth:o,isOverall:l}}function rt(e){const t=z(e?.action,e?.note),n=t.isOverall||t.isWeek||t.isMonth;return n&&t.isUndo?"text-danger fw-semibold":n&&!t.isUndo?"text-success fw-semibold":""}function it(e){return(r.value?.attachments||[]).find(n=>String(n.id)===String(e))?.originalFilename||`附件 #${e}`}function ct(e){const t=z(e?.action),n=(e?.note||"").trim(),s=lt(n)||e?.key||"";if(t.isWeek)return t.isUndo?`撤销${s?`${s}`:""}已完成`:`确认${s?`${s}`:""}已完成`;if(t.isMonth)return t.isUndo?`撤销${s?`${s}`:""}已完成`:`确认${s?`${s}`:""}已完成`;if(t.isOverall)return t.isUndo?`撤销完成${s?`：${s}`:""}`:`确认完成${s?`：${s}`:""}`;switch(t.raw){case"CREATE_DRAFT":return"保存草稿";case"SUBMIT":return"用户提交";case"ADMIN_APPROVE":return n?`主任同意：${n}`:"主任同意";case"ADMIN_REJECT":return n?`主任驳回：${n}`:"主任驳回";case"REVIEW_APPROVE":return n?`科室同意：${n}`:"科室同意";case"REVIEW_REJECT":return n?`科室驳回：${n}`:"科室驳回";case"COMMENT_ADDED":{const l=ce(n);return l&&l.text?l.text:n?`${n}`:"发表意见"}case"ATTACHMENT_ADDED":{const l=ce(n),u=l?.filename||(e?.attachmentId?it(e.attachmentId):"")||"附件";return l?.label&&`${l.label}`,`上传附件：${u}`}}return/(APPROVE)/.test(t.raw)&&/(ADMIN|DIRECTOR)/.test(t.raw)?n?`主任同意：${n}`:"主任同意":/(REJECT)/.test(t.raw)&&/(ADMIN|DIRECTOR)/.test(t.raw)?n?`主任驳回：${n}`:"主任驳回":/(APPROVE|PASS)/.test(t.raw)&&/(REVIEW|DEPT|SECTION)/.test(t.raw)?n?`科室同意：${n}`:"科室同意":/(REJECT)/.test(t.raw)&&/(REVIEW|DEPT|SECTION)/.test(t.raw)?n?`科室驳回：${n}`:"科室驳回":s||n||"（系统记录）"}function Te(e){const t=String(e??"").trim();if(!t)return null;if(t.startsWith("{"))try{const o=JSON.parse(t);if(o&&typeof o.key=="string"&&o.key)return o.key}catch{}const n=t.match(/\b(\d{4})-W(\d{1,2})\b/);if(n)return`${n[1]}-W${String(n[2]).padStart(2,"0")}`;const s=t.match(/\b(\d{4})-(\d{1,2})\b/);return s?`${s[1]}-${String(s[2]).padStart(2,"0")}`:null}function M(e){const t=W(e);if(t){const o=p().year(t.year).month(0).date(4).isoWeek(t.week).startOf("isoWeek"),l=o.endOf("isoWeek");return`${t.year}年第${t.week}周（${o.format("MM/DD")}~${l.format("MM/DD")}）`}const n=R(e);return n?`${n.year}年${String(n.month).padStart(2,"0")}月`:e}function V(e){const t=z(e?.action),n=Te(e?.note)||(typeof e?.key=="string"?e.key.trim():"");if(n){const o=W(n);if(o)return{key:n,label:M(n),sort:o.sort};const l=R(n);if(l)return{key:n,label:M(n),sort:l.sort}}if(t.isWeek||t.isMonth)return null;const s=p(e?.occurredAt);if(!s.isValid())return null;if(f.value==="week"){const o=s.isoWeekYear(),l=s.isoWeek(),u=`${o}-W${String(l).padStart(2,"0")}`,b=W(u);return b?{key:u,label:M(u),sort:b.sort}:null}if(f.value==="month"){const o=s.year(),l=s.month()+1,u=`${o}-${String(l).padStart(2,"0")}`,b=R(u);return b?{key:u,label:M(u),sort:b.sort}:null}return null}const G=y(()=>{const t=[...Array.isArray(r.value?.history)?r.value.history:[]].sort((o,l)=>{const u=p(o?.occurredAt).valueOf()||0,b=p(l?.occurredAt).valueOf()||0;return u-b}),n=new Map,s=new Map;for(const o of t){const l=z(o?.action);if(!l.isWeek&&!l.isMonth)continue;const u=Te(o?.note)||(typeof o?.key=="string"?o.key:null);u&&(l.isWeek&&n.set(u,!l.isUndo),l.isMonth&&s.set(u,!l.isUndo))}return{weekState:n,monthState:s}});function W(e){const t=/^(\d{4})-W(\d{1,2})$/.exec(e||"");if(!t)return null;const n=Number(t[1]),s=Number(t[2]);return{year:n,week:s,sort:n*100+s}}function R(e){const t=/^(\d{4})-(\d{1,2})$/.exec(e||"");if(!t)return null;const n=Number(t[1]),s=Number(t[2]);return{year:n,month:s,sort:n*100+s}}const ut=y(()=>{const e=G.value.weekState;if(!e||e.size===0)return!1;const{key:t}=ae();return!!e.get(t)}),dt=y(()=>{const e=G.value.monthState;if(!e||e.size===0)return!1;const t=p().subtract(1,"month"),n=`${t.year()}-${String(t.month()+1).padStart(2,"0")}`;return!!e.get(n)}),Ne=y(()=>{const e=String(r.value?.status||"");return!N.value||["DRAFT","SUBMITTED","ADMIN_APPROVED","ADMIN_REJECTED","REVIEW_REJECTED","RETURNED"].includes(e)?e:ee.value?ut.value?"WEEK_DONE":"WEEK_NOT_DONE":te.value?dt.value?"MONTH_DONE":"MONTH_NOT_DONE":e}),Ce=y(()=>{const e=oe().key;return!!G.value.weekState.get(e)}),Oe=y(()=>{const e=le().key;return!!G.value.monthState.get(e)});return(e,t)=>r.value?(c(),i("div",Rt,[a("div",xt,[a("div",Ut,[a("h2",Pt,"#"+v(r.value.id)+" "+v(r.value.title),1),a("span",{class:q(["badge",He(Ne.value)])},v(be(Ne.value)),3)]),r.value.submittedAt||r.value.createdAt?(c(),i("div",Lt," 最近更新："+v(se(r.value.submittedAt||r.value.createdAt)),1)):k("",!0)]),a("div",Kt,[t[15]||(t[15]=a("div",{class:"card-header fw-semibold"},"基本信息",-1)),a("div",Ht,[a("div",Vt,[a("div",Bt,[t[9]||(t[9]=a("div",{class:"text-body-secondary small mb-1"},"申请类型",-1)),a("div",null,[a("span",Ft,v(r.value.category||"未分类"),1)])]),a("div",jt,[t[10]||(t[10]=a("div",{class:"text-body-secondary small mb-1"},"影响范围",-1)),a("div",null,v(r.value.impactScope||"-"),1)]),a("div",Jt,[t[11]||(t[11]=a("div",{class:"text-body-secondary small mb-1"},"联系电话",-1)),a("div",null,v(r.value.contactPhone||"-"),1)]),a("div",Yt,[t[12]||(t[12]=a("div",{class:"text-body-secondary small mb-1"},"地点/科室",-1)),a("div",null,v(r.value.location||"-"),1)]),a("div",zt,[t[13]||(t[13]=a("div",{class:"text-body-secondary small mb-1"},"提交人",-1)),a("div",null,v(r.value.createdByName)+"("+v(r.value.createdByDept)+"/"+v(r.value.createdByEmpId)+")",1)]),a("div",Gt,[t[14]||(t[14]=a("div",{class:"text-body-secondary small mb-1"},"提交时间",-1)),a("div",null,v(se(r.value.submittedAt||r.value.createdAt)),1)])])])]),a("div",qt,[t[16]||(t[16]=a("div",{class:"card-header fw-semibold"},"需求详情",-1)),a("div",Qt,[a("pre",Xt,v(r.value.description),1)])]),a("div",Zt,[t[18]||(t[18]=a("div",{class:"card-header fw-semibold"},"附件",-1)),a("div",en,[t[17]||(t[17]=a("div",{class:"alert alert-light border py-2 mb-3",role:"alert"},[$e(" 新上传的附件会出现在下方流转历史，"),a("b",null,"（周报或月报注意时间选取，默认为最新一周或最新一月）")],-1)),a("div",tn,[a("input",{type:"file",class:"form-control",ref_key:"fileInput",ref:ne,multiple:"",onChange:Ue},null,544),a("button",{class:"btn btn-primary",onClick:Ke,disabled:!$.value||F.value},v(F.value?"上传中…":"上传附件"),9,nn)])])]),a("div",sn,[a("div",an,[t[19]||(t[19]=a("span",null,"意见与审批",-1)),I.value||S.value?(c(),i("small",on," 当前状态："+v(be(r.value.status)),1)):k("",!0)]),a("div",ln,[a("div",rn,[de(a("textarea",{class:"form-control",rows:"4","onUpdate:modelValue":t[0]||(t[0]=n=>h.value=n),placeholder:"填写意见（周报或月报需要注意时间选取，默认为最新一周或最新一月）"},null,512),[[kt,h.value]])]),a("div",cn,[I.value?(c(),i(w,{key:0},[r.value.status==="SUBMITTED"?(c(),i("button",{key:0,class:"btn btn-success btn-sm",onClick:t[1]||(t[1]=n=>ke("admin"))},"主任同意")):k("",!0),r.value.status==="SUBMITTED"?(c(),i("button",{key:1,class:"btn btn-danger btn-sm",onClick:t[2]||(t[2]=n=>pe("admin"))},"主任驳回")):k("",!0)],64)):k("",!0),S.value?(c(),i(w,{key:1},[r.value.status==="ADMIN_APPROVED"?(c(),i("button",{key:0,class:"btn btn-success btn-sm",onClick:t[3]||(t[3]=n=>ke("reviewer"))},"科室同意")):k("",!0),r.value.status==="ADMIN_APPROVED"?(c(),i("button",{key:1,class:"btn btn-danger btn-sm",onClick:t[4]||(t[4]=n=>pe("reviewer"))},"科室驳回")):k("",!0)],64)):k("",!0),I.value||S.value?(c(),i("button",{key:2,class:"btn btn-outline-secondary btn-sm",onClick:he},"仅发表意见")):(c(),i("button",{key:3,class:"btn btn-primary btn-sm",onClick:he},"发布")),t[20]||(t[20]=a("div",{class:"vr mx-2 d-none d-sm-block"},null,-1)),!N.value&&(I.value||S.value)?(c(),i(w,{key:4},[We.value?(c(),i("button",{key:0,class:"btn btn-success btn-sm",onClick:Be},"标记为已完成")):k("",!0),Re.value?(c(),i("button",{key:1,class:"btn btn-danger btn-sm",onClick:Fe},"撤销已完成")):k("",!0)],64)):k("",!0)])])]),a("div",un,[a("div",dn,[t[25]||(t[25]=a("span",null,"流转历史",-1)),a("div",mn,[a("div",fn,[(c(!0),i(w,null,B(ve.value,n=>(c(),i("button",{key:n.key,type:"button",class:q(["btn btn-outline-secondary",{active:f.value===n.key}]),onClick:s=>f.value=n.key},v(n.label),11,vn))),128))]),a("div",yn,[de(a("input",{class:"form-check-input",type:"checkbox",id:"onlyAtt","onUpdate:modelValue":t[5]||(t[5]=n=>C.value=n)},null,512),[[Ie,C.value]]),t[21]||(t[21]=a("label",{class:"form-check-label small",for:"onlyAtt"},"仅附件",-1))]),a("div",bn,[de(a("input",{class:"form-check-input",type:"checkbox",id:"showDeleted","onUpdate:modelValue":t[6]||(t[6]=n=>P.value=n)},null,512),[[Ie,P.value]]),t[22]||(t[22]=a("label",{class:"form-check-label small",for:"showDeleted"},"包含已删除",-1))]),f.value==="week"?(c(),i(w,{key:0},[a("div",kn,[a("button",pn,v(at.value),1),a("ul",hn,[a("li",null,[a("a",{class:"dropdown-item",href:"#",onClick:t[7]||(t[7]=Q(n=>ge(""),["prevent"]))},"（全部周）")]),t[23]||(t[23]=a("li",null,[a("hr",{class:"dropdown-divider"})],-1)),(c(!0),i(w,null,B(H.value,n=>(c(),i("li",{key:n.key},[a("a",{class:"dropdown-item",href:"#",onClick:Q(s=>ge(n.key),["prevent"])},v(n.label),9,wn)]))),128))])]),N.value&&ee.value&&(I.value||S.value||j.value===r.value.createdByEmpId)?(c(),i(w,{key:0},[m.value&&!Ce.value?(c(),i("button",{key:0,class:"btn btn-success btn-sm",onClick:je}," 确认该周完成 ")):m.value&&Ce.value?(c(),i("button",{key:1,class:"btn btn-danger btn-sm",onClick:Je}," 撤销该周完成 ")):(c(),i("button",En," 请先选择周次 "))],64)):k("",!0)],64)):k("",!0),f.value==="month"?(c(),i(w,{key:1},[a("div",Dn,[a("button",gn,v(st.value),1),a("ul",_n,[a("li",null,[a("a",{class:"dropdown-item",href:"#",onClick:t[8]||(t[8]=Q(n=>De(""),["prevent"]))},"（全部月份）")]),t[24]||(t[24]=a("li",null,[a("hr",{class:"dropdown-divider"})],-1)),(c(!0),i(w,null,B(K.value,n=>(c(),i("li",{key:n.key},[a("a",{class:"dropdown-item",href:"#",onClick:Q(s=>De(n.key),["prevent"])},v(n.label),9,An)]))),128))])]),N.value&&te.value&&(I.value||S.value||j.value===r.value.createdByEmpId)?(c(),i(w,{key:0},[d.value&&!Oe.value?(c(),i("button",{key:0,class:"btn btn-success btn-sm",onClick:Ye}," 确认该月完成 ")):d.value&&Oe.value?(c(),i("button",{key:1,class:"btn btn-danger btn-sm",onClick:ze}," 撤销该月完成 ")):(c(),i("button",Mn," 请先选择月份 "))],64)):k("",!0)],64)):k("",!0)])]),a("div",Tn,[(c(!0),i(w,null,B(ot.value,n=>(c(),i(w,{key:n.key},[f.value!=="none"?(c(),i("div",Nn,[$e(v(n.label)+" ",1),a("span",Cn,v(n.items.length),1)])):k("",!0),a("ul",On,[(c(!0),i(w,null,B(n.items,s=>(c(),i("li",{key:s.id??s.occurredAt+"-"+s.action,class:q(["list-group-item d-flex justify-content-between align-items-start",{"text-decoration-line-through opacity-75":L(s)}])},[a("div",null,[a("div",$n,[a("span",In,v(s.actorName),1),a("span",Sn,"("+v(s.actorEmpId)+")",1),a("span",Wn," @ "+v(se(s.occurredAt)),1),L(s)?(c(),i("span",Rn,"已删除")):k("",!0)]),a("div",{class:q(["mt-1",rt(s)])},v(ct(s)),3)]),a("div",xn,[et(s)?(c(),i(w,{key:0},[a("button",{class:"btn btn-sm btn-outline-primary",onClick:o=>tt(s)},"预览",8,Un),a("button",{class:"btn btn-sm btn-outline-secondary",onClick:o=>nt(s)},"下载",8,Pn)],64)):k("",!0),qe(s)&&!L(s)?(c(),i("button",{key:1,class:"btn btn-sm btn-outline-danger",onClick:o=>Ze(s)},"删除",8,Ln)):Qe(s)&&!L(s)?(c(),i("button",{key:2,class:"btn btn-sm btn-outline-danger",onClick:o=>Xe(s)},"删除",8,Kn)):k("",!0)])],2))),128))])],64))),128)),Me.value.length===0?(c(),i("div",Hn,"没有符合条件的记录。")):k("",!0)])])])):k("",!0)}},Yn=mt(Vn,[["__scopeId","data-v-2aa6d9b8"]]);export{Yn as default};
