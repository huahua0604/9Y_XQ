import{_ as z,u as q,r as E,i as w,k as G,c,a as s,q as Y,s as Q,x as X,n as h,d as Z,m as tt,F as et,p as st,o as l,f as nt,t as u}from"./index-CzakBmrc.js";import{d as m,i as rt}from"./isoWeek-D1M7nHiN.js";import{l as at,a as ot,g as it}from"./demand-CZzwyWDn.js";import"./axios-C6hvs-Du.js";const ct={class:"container my-4"},lt={class:"d-flex align-items-center justify-content-between mb-3"},ut={class:"card shadow-sm"},dt={class:"card-body pb-2"},Et={class:"d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3"},ft={class:"nav nav-pills gap-2 mb-0"},pt={class:"nav-item"},_t={class:"d-flex align-items-center gap-2"},gt={key:0,class:"d-flex align-items-center gap-2 text-muted py-4"},Dt={key:1},mt={key:0,class:"table-responsive"},yt={class:"table table-hover table-striped align-middle mb-0"},Nt=["onClick"],bt={class:"text-body-secondary"},vt={class:"fw-semibold"},ht={class:"text-truncate",style:{"max-width":"220px"}},Tt={class:"d-flex flex-column"},Ot={class:"text-body-secondary"},Mt={class:"text-nowrap"},xt={key:1,class:"alert alert-light border d-flex align-items-center m-0",role:"alert"},Rt={__name:"DemandList",setup(St){m.extend(rt);const f=q(),p=E("mine"),y=E([]),N=E(!1),_=E(""),b=E({});w(()=>(f.user&&f.user.roles||[]).includes("ADMIN")||(f.user&&f.user.roles||[]).includes("REVIEWER"));function k(e){return e?e.replace("T"," ").slice(0,19):""}function C(e){const t=String(e||"").trim();return t==="临时"?"text-bg-primary":t==="周报"?"text-bg-info":t==="月报"?"text-bg-warning":"text-bg-secondary"}function A(e){const t=String(e||"");return t.includes("周报")||t.includes("月报")}function W(e){return String(e||"").includes("周报")}function I(e){return String(e||"").includes("月报")}function U(e){const t=String(e??"").trim();if(!t)return null;if(t.startsWith("{"))try{const a=JSON.parse(t);if(a&&typeof a.key=="string"&&a.key)return a.key}catch{}const r=t.match(/\b(\d{4})-W(\d{1,2})\b/);if(r)return`${r[1]}-W${String(r[2]).padStart(2,"0")}`;const n=t.match(/\b(\d{4})-(\d{1,2})\b/);return n?`${n[1]}-${String(n[2]).padStart(2,"0")}`:null}function V(e){const t=String(e||"").toUpperCase(),r=/(UNMARK|UNDO|UNSET|CANCEL|REVOKE|ROLLBACK)/.test(t)||/^UN/.test(t),n=/WEEK/.test(t)||/W(\d{1,2})\b/.test(t),a=/MONTH/.test(t)||/\b\d{4}-\d{1,2}\b/.test(t),g=!n&&!a&&/(COMPLETE|COMPLETED|DONE|FINISH|FINISHED)/.test(t);return{raw:t,isUndo:r,isWeek:n,isMonth:a,isOverall:g}}function P(e,t){if(!e||e.size===0)return!1;const r=t.subtract(1,"week"),n=`${r.isoWeekYear()}-W${String(r.isoWeek()).padStart(2,"0")}`;return!!e.get(n)}function K(e,t){if(!e||e.size===0)return!1;const r=t.subtract(1,"month"),n=`${r.year()}-${String(r.month()+1).padStart(2,"0")}`;return!!e.get(n)}function v(e){const t=b.value[e.id];return t||String(e&&e.status||"")}function B(e){switch(String(v(e)).toUpperCase()){case"DRAFT":return"text-bg-secondary";case"SUBMITTED":return"text-bg-info";case"ADMIN_APPROVED":case"IN_REVIEW":return"text-bg-primary";case"RETURNED":return"text-bg-warning";case"ADMIN_REJECTED":case"REVIEW_REJECTED":case"REJECTED":return"text-bg-danger";case"COMPLETED":case"WEEK_DONE":case"MONTH_DONE":return"text-bg-success";case"WEEK_NOT_DONE":case"MONTH_NOT_DONE":return"text-bg-secondary";default:return"text-bg-secondary"}}function F(e){const t=String(v(e));switch(t){case"WEEK_DONE":return"上周已完成";case"WEEK_NOT_DONE":return"上周未完成";case"MONTH_DONE":return"上月已完成";case"MONTH_NOT_DONE":return"上月未完成";case"COMPLETED":return"已完成";case"DRAFT":return"草稿";case"SUBMITTED":return"待主任审批";case"ADMIN_APPROVED":return"主任同意";case"ADMIN_REJECTED":return"主任驳回";case"REVIEW_APPROVED":return"科室同意";case"REVIEW_REJECTED":return"科室驳回";case"RETURNED":return"退回修改";case"REJECTED":return"已拒绝";default:return t||"未知"}}function J(e){const t=String(v(e)).toUpperCase();return["COMPLETED","WEEK_DONE","MONTH_DONE"].includes(t)?"done":["ADMIN_REJECTED","REVIEW_REJECTED","REJECTED"].includes(t)?"rejected":(["SUBMITTED","ADMIN_APPROVED","IN_REVIEW","RETURNED","WEEK_NOT_DONE","MONTH_NOT_DONE","DRAFT"].includes(t),"processing")}async function L(){const e=y.value.filter(n=>A(n.category)),t={};if(!e.length){b.value=t;return}const r=m();for(const n of e)try{const a=await it(n.id),g=String(a?.category||n.category||""),D=String(a?.status||n.status||""),M=W(g),x=I(g);if(!M&&!x){t[n.id]=D;continue}if(["DRAFT","SUBMITTED","ADMIN_APPROVED","ADMIN_REJECTED","REVIEW_REJECTED","RETURNED"].includes(D)){t[n.id]=D;continue}const H=(Array.isArray(a?.history)?a.history:[]).slice().sort((o,i)=>{const d=m(o?.occurredAt).valueOf()||0,j=m(i?.occurredAt).valueOf()||0;return d-j}),R=new Map,S=new Map;for(const o of H){const i=V(o?.action);if(!i.isWeek&&!i.isMonth)continue;const d=U(o?.note)||(typeof o?.key=="string"?o.key:null);d&&(i.isWeek&&R.set(d,!i.isUndo),i.isMonth&&S.set(d,!i.isUndo))}if(M){const o=P(R,r);t[n.id]=o?"WEEK_DONE":"WEEK_NOT_DONE"}else if(x){const o=K(S,r);t[n.id]=o?"MONTH_DONE":"MONTH_NOT_DONE"}else t[n.id]=D}catch{t[n.id]=String(n&&n.status||"")}b.value=t}async function T(){N.value=!0;try{y.value=p.value==="mine"?await at():await ot(),await L()}finally{N.value=!1}}function $(e){p.value!==e&&(p.value=e,T())}const O=w(()=>{let e=y.value.slice();return _.value&&(e=e.filter(t=>J(t)===_.value)),e});return G(T),(e,t)=>{const r=X("router-link");return l(),c("div",ct,[s("div",lt,[t[3]||(t[3]=s("h2",{class:"h4 mb-0"},"需求列表",-1)),Y(r,{class:"btn btn-primary",to:"/demands/new"},{default:Q(()=>[...t[2]||(t[2]=[s("span",{class:"me-1"},"+",-1),nt(" 新建需求 ",-1)])]),_:1})]),s("div",ut,[s("div",dt,[s("div",Et,[s("ul",ft,[s("li",pt,[s("button",{class:h(["nav-link",{active:p.value==="mine"}]),onClick:t[0]||(t[0]=n=>$("mine"))}," 我的 ",2)])]),s("div",_t,[t[5]||(t[5]=s("label",{class:"form-label mb-0"},"状态：",-1)),Z(s("select",{class:"form-select form-select-sm w-auto","onUpdate:modelValue":t[1]||(t[1]=n=>_.value=n)},[...t[4]||(t[4]=[s("option",{value:""},"全部",-1),s("option",{value:"processing"},"流程中",-1),s("option",{value:"rejected"},"驳回",-1),s("option",{value:"done"},"已完成",-1)])],512),[[tt,_.value]])])]),N.value?(l(),c("div",gt,[...t[6]||(t[6]=[s("div",{class:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"},null,-1),s("span",null,"加载中…",-1)])])):(l(),c("div",Dt,[O.value.length?(l(),c("div",mt,[s("table",yt,[t[7]||(t[7]=s("thead",{class:"table-light"},[s("tr",null,[s("th",{style:{width:"90px"}},"ID"),s("th",null,"标题"),s("th",{style:{width:"120px"}},"申请类型"),s("th",{style:{width:"120px"}},"状态"),s("th",{style:{width:"120px"}},"提交人"),s("th",{style:{width:"180px"}},"提交时间")])],-1)),s("tbody",null,[(l(!0),c(et,null,st(O.value,n=>(l(),c("tr",{key:n.id,class:"cursor-pointer",onClick:a=>e.$router.push(`/demands/${n.id}`)},[s("td",bt,"#"+u(n.id),1),s("td",vt,[s("div",ht,u(n.title),1)]),s("td",null,[s("span",{class:h(["badge",C(n.category)])},u(n.category||"未分类"),3)]),s("td",null,[s("span",{class:h(["badge",B(n)])},u(F(n)),3)]),s("td",null,[s("div",Tt,[s("span",null,u(n.createdByName),1),s("small",Ot,u(n.createdByDept),1)])]),s("td",Mt,u(k(n.submittedAt||n.createdAt)),1)],8,Nt))),128))])])])):(l(),c("div",xt,[...t[8]||(t[8]=[s("i",{class:"bi bi-inbox me-2","aria-hidden":"true"},null,-1),s("div",null,"暂无数据",-1)])]))]))])])])}}},Ut=z(Rt,[["__scopeId","data-v-a60f4ae4"]]);export{Ut as default};
