import{_ as q,u as G,r as p,i as C,k as Q,c as d,a as n,q as X,s as Z,x as tt,n as O,d as et,m as st,F as nt,p as rt,o as E,f as ot,t as f}from"./index-BCFNTfTT.js";import{d as N,i as it}from"./isoWeek-D1M7nHiN.js";import{l as at,a as ct,g as lt}from"./demand-Bm2CkUI9.js";import"./axios-CP6D1eTq.js";const ut={class:"container my-4"},dt={class:"d-flex align-items-center justify-content-between mb-3"},Et={class:"card shadow-sm"},ft={class:"card-body pb-2"},yt={class:"d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3"},pt={class:"nav nav-pills gap-2 mb-0"},_t={class:"nav-item"},gt={class:"d-flex align-items-center gap-2"},mt={key:0,class:"d-flex align-items-center gap-2 text-muted py-4"},Dt={key:1},Nt={key:0,class:"table-responsive"},bt={class:"table table-hover table-striped align-middle mb-0"},ht=["onClick"],vt={class:"text-body-secondary"},Tt={class:"fw-semibold"},Ot={class:"text-truncate",style:{"max-width":"220px"}},Mt={class:"d-flex flex-column"},xt={class:"text-body-secondary"},Rt={class:"text-nowrap"},kt={key:1,class:"alert alert-light border d-flex align-items-center m-0",role:"alert"},wt={__name:"DemandList",setup(St){N.extend(it);const _=G(),g=p("mine"),b=p([]),h=p(!1),m=p(""),v=p({});C(()=>(_.user&&_.user.roles||[]).includes("ADMIN")||(_.user&&_.user.roles||[]).includes("REVIEWER"));function W(e){return e?e.replace("T"," ").slice(0,19):""}function A(e){const t=String(e||"").trim();return t==="临时"?"text-bg-primary":t==="周报"?"text-bg-info":t==="月报"?"text-bg-warning":"text-bg-secondary"}function I(e){const t=String(e||"");return t.includes("周报")||t.includes("月报")}function U(e){return String(e||"").includes("周报")}function V(e){return String(e||"").includes("月报")}function K(e){const t=String(e??"").trim();if(!t)return null;if(t.startsWith("{"))try{const r=JSON.parse(t);if(r&&typeof r.key=="string"&&r.key)return r.key}catch{}const i=t.match(/\b(\d{4})-W(\d{1,2})\b/);if(i)return`${i[1]}-W${String(i[2]).padStart(2,"0")}`;const s=t.match(/\b(\d{4})-(\d{1,2})\b/);return s?`${s[1]}-${String(s[2]).padStart(2,"0")}`:null}function F(e){const t=String(e||"").toUpperCase(),i=/(UNMARK|UNDO|UNSET|CANCEL|REVOKE|ROLLBACK)/.test(t)||/^UN/.test(t),s=/WEEK/.test(t)||/W(\d{1,2})\b/.test(t),r=/MONTH/.test(t)||/\b\d{4}-\d{1,2}\b/.test(t),c=!s&&!r&&/(COMPLETE|COMPLETED|DONE|FINISH|FINISHED)/.test(t);return{raw:t,isUndo:i,isWeek:s,isMonth:r,isOverall:c}}function M(e){const t=/^(\d{4})-W(\d{1,2})$/.exec(String(e||""));if(!t)return null;const i=Number(t[1]),s=Number(t[2]);return{year:i,week:s,sort:i*100+s}}function x(e){const t=/^(\d{4})-(\d{1,2})$/.exec(String(e||""));if(!t)return null;const i=Number(t[1]),s=Number(t[2]);return{year:i,month:s,sort:i*100+s}}function P(e,t){if(!e||e.size===0)return!1;const i=t.isoWeekYear(),s=t.isoWeek();let r=null,c=-1/0;for(const[a]of e.entries()){const o=M(a);if(!o)continue;(o.year<i||o.year===i&&o.week<=s)&&o.sort>c&&(c=o.sort,r=a)}if(!r)for(const[a]of e.entries()){const o=M(a);o&&o.sort>c&&(c=o.sort,r=a)}return r?!!e.get(r):!1}function B(e,t){if(!e||e.size===0)return!1;const i=t.year(),s=t.month()+1;let r=null,c=-1/0;for(const[a]of e.entries()){const o=x(a);if(!o)continue;(o.year<i||o.year===i&&o.month<=s)&&o.sort>c&&(c=o.sort,r=a)}if(!r)for(const[a]of e.entries()){const o=x(a);o&&o.sort>c&&(c=o.sort,r=a)}return r?!!e.get(r):!1}function T(e){const t=v.value[e.id];return t||String(e&&e.status||"")}function J(e){switch(String(T(e)).toUpperCase()){case"DRAFT":return"text-bg-secondary";case"SUBMITTED":return"text-bg-info";case"ADMIN_APPROVED":case"IN_REVIEW":return"text-bg-primary";case"RETURNED":return"text-bg-warning";case"ADMIN_REJECTED":case"REVIEW_REJECTED":case"REJECTED":return"text-bg-danger";case"COMPLETED":case"WEEK_DONE":case"MONTH_DONE":return"text-bg-success";case"WEEK_NOT_DONE":case"MONTH_NOT_DONE":return"text-bg-secondary";default:return"text-bg-secondary"}}function L(e){const t=String(T(e));switch(t){case"WEEK_DONE":return"上周已完成";case"WEEK_NOT_DONE":return"上周未完成";case"MONTH_DONE":return"上月已完成";case"MONTH_NOT_DONE":return"上月未完成";case"COMPLETED":return"已完成";case"DRAFT":return"草稿";case"SUBMITTED":return"待主任审批";case"ADMIN_APPROVED":return"主任同意";case"ADMIN_REJECTED":return"主任驳回";case"REVIEW_APPROVED":return"科室同意";case"REVIEW_REJECTED":return"科室驳回";case"RETURNED":return"退回修改";case"REJECTED":return"已拒绝";default:return t||"未知"}}function H(e){const t=String(T(e)).toUpperCase();return["COMPLETED","WEEK_DONE","MONTH_DONE"].includes(t)?"done":["ADMIN_REJECTED","REVIEW_REJECTED","REJECTED"].includes(t)?"rejected":(["SUBMITTED","ADMIN_APPROVED","IN_REVIEW","RETURNED","WEEK_NOT_DONE","MONTH_NOT_DONE","DRAFT"].includes(t),"processing")}async function $(){const e=b.value.filter(s=>I(s.category)),t={};if(!e.length){v.value=t;return}const i=N();for(const s of e)try{const r=await lt(s.id),c=String(r?.category||s.category||""),a=String(r?.status||s.status||""),o=U(c),D=V(c);if(!o&&!D){t[s.id]=a;continue}if(["DRAFT","SUBMITTED","ADMIN_APPROVED","ADMIN_REJECTED","REVIEW_REJECTED","RETURNED"].includes(a)){t[s.id]=a;continue}const z=(Array.isArray(r?.history)?r.history:[]).slice().sort((l,u)=>{const y=N(l?.occurredAt).valueOf()||0,Y=N(u?.occurredAt).valueOf()||0;return y-Y}),w=new Map,S=new Map;for(const l of z){const u=F(l?.action);if(!u.isWeek&&!u.isMonth)continue;const y=K(l?.note)||(typeof l?.key=="string"?l.key:null);y&&(u.isWeek&&w.set(y,!u.isUndo),u.isMonth&&S.set(y,!u.isUndo))}if(o){const l=P(w,i);t[s.id]=l?"WEEK_DONE":"WEEK_NOT_DONE"}else if(D){const l=B(S,i);t[s.id]=l?"MONTH_DONE":"MONTH_NOT_DONE"}else t[s.id]=a}catch{t[s.id]=String(s&&s.status||"")}v.value=t}async function R(){h.value=!0;try{b.value=g.value==="mine"?await at():await ct(),await $()}finally{h.value=!1}}function j(e){g.value!==e&&(g.value=e,R())}const k=C(()=>{let e=b.value.slice();return m.value&&(e=e.filter(t=>H(t)===m.value)),e});return Q(R),(e,t)=>{const i=tt("router-link");return E(),d("div",ut,[n("div",dt,[t[3]||(t[3]=n("h2",{class:"h4 mb-0"},"需求列表",-1)),X(i,{class:"btn btn-primary",to:"/demands/new"},{default:Z(()=>[...t[2]||(t[2]=[n("span",{class:"me-1"},"+",-1),ot(" 新建需求 ",-1)])]),_:1})]),n("div",Et,[n("div",ft,[n("div",yt,[n("ul",pt,[n("li",_t,[n("button",{class:O(["nav-link",{active:g.value==="mine"}]),onClick:t[0]||(t[0]=s=>j("mine"))}," 我的 ",2)])]),n("div",gt,[t[5]||(t[5]=n("label",{class:"form-label mb-0"},"状态：",-1)),et(n("select",{class:"form-select form-select-sm w-auto","onUpdate:modelValue":t[1]||(t[1]=s=>m.value=s)},[...t[4]||(t[4]=[n("option",{value:""},"全部",-1),n("option",{value:"processing"},"流程中",-1),n("option",{value:"rejected"},"驳回",-1),n("option",{value:"done"},"已完成",-1)])],512),[[st,m.value]])])]),h.value?(E(),d("div",mt,[...t[6]||(t[6]=[n("div",{class:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"},null,-1),n("span",null,"加载中…",-1)])])):(E(),d("div",Dt,[k.value.length?(E(),d("div",Nt,[n("table",bt,[t[7]||(t[7]=n("thead",{class:"table-light"},[n("tr",null,[n("th",{style:{width:"90px"}},"ID"),n("th",null,"标题"),n("th",{style:{width:"120px"}},"申请类型"),n("th",{style:{width:"120px"}},"状态"),n("th",{style:{width:"120px"}},"提交人"),n("th",{style:{width:"180px"}},"提交时间")])],-1)),n("tbody",null,[(E(!0),d(nt,null,rt(k.value,s=>(E(),d("tr",{key:s.id,class:"cursor-pointer",onClick:r=>e.$router.push(`/demands/${s.id}`)},[n("td",vt,"#"+f(s.id),1),n("td",Tt,[n("div",Ot,f(s.title),1)]),n("td",null,[n("span",{class:O(["badge",A(s.category)])},f(s.category||"未分类"),3)]),n("td",null,[n("span",{class:O(["badge",J(s)])},f(L(s)),3)]),n("td",null,[n("div",Mt,[n("span",null,f(s.createdByName),1),n("small",xt,f(s.createdByDept),1)])]),n("td",Rt,f(W(s.submittedAt||s.createdAt)),1)],8,ht))),128))])])])):(E(),d("div",kt,[...t[8]||(t[8]=[n("i",{class:"bi bi-inbox me-2","aria-hidden":"true"},null,-1),n("div",null,"暂无数据",-1)])]))]))])])])}}},Kt=q(wt,[["__scopeId","data-v-fb203369"]]);export{Kt as default};
