import{_ as et,u as st,r as u,i as m,k as nt,c as l,a as s,d as I,v as ot,b as rt,f as it,n as b,m as at,F as lt,p as ct,h as dt,o as c,t as d,w as ut}from"./index-L6f31KK7.js";import{d as y,i as Et}from"./isoWeek-D1M7nHiN.js";import{a as ft,g as pt}from"./demand-DBZ5Xo_c.js";import"./axios-DQV6b0rz.js";const _t={class:"container my-4"},gt={class:"d-flex align-items-center justify-content-between mb-3"},vt={class:"d-flex align-items-center gap-2"},mt=["disabled"],bt={key:0,class:"spinner-border spinner-border-sm me-1","aria-hidden":"true"},yt={class:"card shadow-sm"},Dt={class:"card-body pb-2"},ht={class:"d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3"},Nt={class:"nav nav-pills gap-2 mb-0"},Tt={class:"nav-item"},xt={class:"nav-item"},Ot={class:"d-flex align-items-center gap-2"},wt={key:0,class:"d-flex align-items-center gap-2 text-muted py-4 justify-content-center"},Mt={key:1},Rt={key:0,class:"table-responsive"},kt={class:"table table-hover table-striped align-middle mb-0"},St=["onClick"],Ct={class:"text-body-secondary"},At={class:"fw-semibold"},Wt={class:"text-truncate",style:{"max-width":"220px"}},It={class:"d-flex flex-column"},Ut={class:"text-body-secondary"},Vt={class:"text-nowrap"},Pt={class:"text-nowrap"},Bt=["onClick"],Kt={key:1,class:"alert alert-light border d-flex align-items-center m-0",role:"alert"},$t={__name:"Inbox",setup(Ft){y.extend(Et);const U=dt(),T=st(),D=u([]),E=u(!1),f=u("todo"),_=u(""),g=u(""),h=u({}),x=m(()=>T.user?.roles||T.roles||[]),V=m(()=>x.value.includes("ADMIN")),P=m(()=>x.value.includes("REVIEWER"));function B(e){return e?e.replace("T"," ").slice(0,19):""}function O(e){U.push(`/demands/${e.id}`)}function K(e){const t=String(e||"").trim();return t==="临时"?"text-bg-primary":t==="周报"?"text-bg-info":t==="月报"?"text-bg-warning":"text-bg-secondary"}function $(e){const t=String(e||"");return t.includes("周报")||t.includes("月报")}function F(e){return String(e||"").includes("周报")}function J(e){return String(e||"").includes("月报")}function L(e){const t=String(e??"").trim();if(!t)return null;if(t.startsWith("{"))try{const r=JSON.parse(t);if(r&&typeof r.key=="string"&&r.key)return r.key}catch{}const n=t.match(/\b(\d{4})-W(\d{1,2})\b/);if(n)return`${n[1]}-W${String(n[2]).padStart(2,"0")}`;const o=t.match(/\b(\d{4})-(\d{1,2})\b/);return o?`${o[1]}-${String(o[2]).padStart(2,"0")}`:null}function H(e){const t=String(e||"").toUpperCase(),n=/(UNMARK|UNDO|UNSET|CANCEL|REVOKE|ROLLBACK)/.test(t)||/^UN/.test(t),o=/WEEK/.test(t)||/W(\d{1,2})\b/.test(t),r=/MONTH/.test(t)||/\b\d{4}-\d{1,2}\b/.test(t);return{raw:t,isUndo:n,isWeek:o,isMonth:r}}function j(e,t){if(!e||e.size===0)return!1;const n=t.subtract(1,"week"),o=`${n.isoWeekYear()}-W${String(n.isoWeek()).padStart(2,"0")}`;return!!e.get(o)}function z(e,t){if(!e||e.size===0)return!1;const n=t.subtract(1,"month"),o=`${n.year()}-${String(n.month()+1).padStart(2,"0")}`;return!!e.get(o)}function N(e){const t=h.value[e.id];return t||String(e&&e.status||"")}function q(e){const t=String(N(e));switch(t){case"WEEK_DONE":return"上周已完成";case"WEEK_NOT_DONE":return"上周未完成";case"MONTH_DONE":return"上月已完成";case"MONTH_NOT_DONE":return"上月未完成";case"COMPLETED":return"已完成";case"DRAFT":return"草稿";case"SUBMITTED":return"待主任审批";case"ADMIN_APPROVED":return"主任同意";case"ADMIN_REJECTED":return"主任驳回";case"REVIEW_APPROVED":return"科室同意";case"REVIEW_REJECTED":return"科室驳回";case"RETURNED":return"退回修改";case"REJECTED":return"已拒绝";default:return t||"未知"}}function G(e){switch(String(N(e)).toUpperCase()){case"DRAFT":return"text-bg-secondary";case"SUBMITTED":return"text-bg-info";case"ADMIN_APPROVED":case"IN_REVIEW":return"text-bg-primary";case"RETURNED":return"text-bg-warning";case"ADMIN_REJECTED":case"REVIEW_REJECTED":case"REJECTED":return"text-bg-danger";case"COMPLETED":case"WEEK_DONE":case"MONTH_DONE":return"text-bg-success";case"WEEK_NOT_DONE":case"MONTH_NOT_DONE":return"text-bg-secondary";default:return"text-bg-secondary"}}function Y(e){const t=String(N(e)).toUpperCase();return["COMPLETED","WEEK_DONE","MONTH_DONE"].includes(t)?"done":["ADMIN_REJECTED","REVIEW_REJECTED","REJECTED"].includes(t)?"rejected":(["SUBMITTED","ADMIN_APPROVED","IN_REVIEW","RETURNED","WEEK_NOT_DONE","MONTH_NOT_DONE","DRAFT"].includes(t),"processing")}function Q(e){const t=String(e?.status||""),n=V.value&&t==="SUBMITTED",o=P.value&&t==="ADMIN_APPROVED";return n||o}async function X(){const e=D.value.filter(o=>$(o.category)),t={};if(!e.length){h.value=t;return}const n=y();for(const o of e)try{const r=await pt(o.id),k=String(r?.category||o.category||""),v=String(r?.status||o.status||""),S=F(k),C=J(k);if(!S&&!C){t[o.id]=v;continue}if(["DRAFT","SUBMITTED","ADMIN_APPROVED","ADMIN_REJECTED","REVIEW_REJECTED","RETURNED"].includes(v)){t[o.id]=v;continue}const Z=(Array.isArray(r?.history)?r.history:[]).slice().sort((i,a)=>{const p=y(i?.occurredAt).valueOf()||0,tt=y(a?.occurredAt).valueOf()||0;return p-tt}),A=new Map,W=new Map;for(const i of Z){const a=H(i?.action);if(!a.isWeek&&!a.isMonth)continue;const p=L(i?.note)||(typeof i?.key=="string"?i.key:null);p&&(a.isWeek&&A.set(p,!a.isUndo),a.isMonth&&W.set(p,!a.isUndo))}if(S){const i=j(A,n);t[o.id]=i?"WEEK_DONE":"WEEK_NOT_DONE"}else if(C){const i=z(W,n);t[o.id]=i?"MONTH_DONE":"MONTH_NOT_DONE"}else t[o.id]=v}catch{t[o.id]=String(o&&o.status||"")}h.value=t}async function w(){E.value=!0;try{D.value=await ft(),await X()}finally{E.value=!1}}function M(e){f.value!==e&&(f.value=e)}const R=m(()=>{let e=D.value.slice();if(f.value==="todo"&&(e=e.filter(Q)),_.value&&(e=e.filter(t=>Y(t)===_.value)),g.value){const t=g.value.toLowerCase();e=e.filter(n=>String(n.title||"").toLowerCase().includes(t)||String(n.createdByName||"").toLowerCase().includes(t))}return e});return nt(w),(e,t)=>(c(),l("div",_t,[s("div",gt,[t[5]||(t[5]=s("h2",{class:"h4 mb-0"},"审批收件箱",-1)),s("div",vt,[I(s("input",{"onUpdate:modelValue":t[0]||(t[0]=n=>g.value=n),placeholder:"按标题/提交人搜索…",class:"form-control form-control-sm",style:{"min-width":"120px","flex-shrink":"1"}},null,512),[[ot,g.value,void 0,{trim:!0}]]),s("button",{class:"btn btn-sm btn-primary",style:{"white-space":"nowrap"},onClick:w,disabled:E.value},[E.value?(c(),l("span",bt)):rt("",!0),t[4]||(t[4]=it(" 刷新 ",-1))],8,mt)])]),s("div",yt,[s("div",Dt,[s("div",ht,[s("ul",Nt,[s("li",Tt,[s("button",{class:b(["nav-link",{active:f.value==="todo"}]),onClick:t[1]||(t[1]=n=>M("todo"))}," 待我审批 ",2)]),s("li",xt,[s("button",{class:b(["nav-link",{active:f.value==="all"}]),onClick:t[2]||(t[2]=n=>M("all"))}," 全部 ",2)])]),s("div",Ot,[t[7]||(t[7]=s("label",{class:"form-label mb-0"},"状态：",-1)),I(s("select",{class:"form-select form-select-sm w-auto","onUpdate:modelValue":t[3]||(t[3]=n=>_.value=n)},[...t[6]||(t[6]=[s("option",{value:""},"全部",-1),s("option",{value:"processing"},"流程中",-1),s("option",{value:"rejected"},"驳回",-1),s("option",{value:"done"},"已完成",-1)])],512),[[at,_.value]])])]),E.value?(c(),l("div",wt,[...t[8]||(t[8]=[s("div",{class:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"},null,-1),s("span",null,"加载中…",-1)])])):(c(),l("div",Mt,[R.value.length?(c(),l("div",Rt,[s("table",kt,[t[9]||(t[9]=s("thead",{class:"table-light"},[s("tr",null,[s("th",{style:{width:"90px"}},"ID"),s("th",null,"标题"),s("th",{style:{width:"120px"}},"申请类型"),s("th",{style:{width:"140px"}},"状态"),s("th",{style:{width:"120px"}},"提交人"),s("th",{style:{width:"180px"}},"时间"),s("th",{style:{width:"90px"}},"操作")])],-1)),s("tbody",null,[(c(!0),l(lt,null,ct(R.value,n=>(c(),l("tr",{key:n.id,class:"cursor-pointer",onClick:o=>O(n)},[s("td",Ct,"#"+d(n.id),1),s("td",At,[s("div",Wt,d(n.title),1)]),s("td",null,[s("span",{class:b(["badge",K(n.category)])},d(n.category||"未分类"),3)]),s("td",null,[s("span",{class:b(["badge",G(n)])},d(q(n)),3)]),s("td",null,[s("div",It,[s("span",null,d(n.createdByName),1),s("small",Ut,d(n.createdByDept),1)])]),s("td",Vt,d(B(n.submittedAt||n.createdAt)),1),s("td",Pt,[s("button",{class:"btn btn-sm btn-outline-primary",onClick:ut(o=>O(n),["stop"])}," 查看 ",8,Bt)])],8,St))),128))])])])):(c(),l("div",Kt,[...t[10]||(t[10]=[s("i",{class:"bi bi-inbox me-2","aria-hidden":"true"},null,-1),s("div",null,"暂无数据",-1)])]))]))])])]))}},Gt=et($t,[["__scopeId","data-v-5f9d545f"]]);export{Gt as default};
