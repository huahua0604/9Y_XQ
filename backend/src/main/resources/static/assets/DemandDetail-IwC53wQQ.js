import{_ as $t,g as It,r as p,u as xt,i as b,A as O,k as Wt,B as Rt,c as i,b as f,a,t as d,F as w,d as q,v as Ae,n as le,f as Fe,p as Q,l as je,w as re,o as c}from"./index-D2zoEI6E.js";import{h as ie}from"./axios-_2TVRCvm.js";import{d as h,i as Pt}from"./isoWeek-D1M7nHiN.js";import{g as Ut,b as Lt,u as Vt,d as Kt,r as Ht,e as Bt,f as Ft,h as jt,m as Jt,i as Yt,j as zt,k as Gt,n as qt,o as Qt,p as Xt}from"./demand-bu92ORQQ.js";function Zt(P){return ie.get(`/api/files/${P}/meta`).then(S=>S.data)}function Me(P,S="inline"){return ie.get(`/api/files/${P}/${S}`,{responseType:"blob"})}function en(P){return ie.delete(`/api/files/${P}`).then(S=>S.data)}const tn={key:0,class:"container my-4"},nn={class:"d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2"},sn={class:"d-flex align-items-center gap-2 flex-wrap"},an={class:"d-flex align-items-center gap-2"},on={key:0,class:"h5 mb-0"},ln={class:"text-body-secondary small"},rn=["disabled"],cn={key:0,class:"d-flex align-items-center gap-1"},un=["disabled"],dn=["disabled"],vn={key:0,class:"text-body-secondary small"},mn={class:"card shadow-sm mb-3"},fn={class:"card-body"},yn={class:"row g-3"},bn={class:"col-12 col-md-6"},kn={class:"badge text-bg-info"},pn={class:"col-12 col-md-6"},hn={class:"col-6 col-md-3"},wn={class:"col-6 col-md-3"},En={class:"col-12 col-md-6"},_n={class:"col-12 col-md-6"},gn={class:"card shadow-sm mb-3"},Dn={class:"card-body"},Tn={class:"mb-0 text-wrap",style:{"white-space":"pre-wrap"}},An={class:"card shadow-sm mb-3"},Mn={class:"card-body"},Cn={class:"input-group"},Nn=["disabled"],On={class:"card shadow-sm mb-3"},Sn={class:"card-header fw-semibold d-flex align-items-center justify-content-between"},$n={key:0,class:"text-body-secondary"},In={class:"card-body"},xn={class:"mb-2"},Wn={class:"d-flex flex-wrap gap-2 align-items-center"},Rn=["disabled"],Pn={key:0,class:"text-muted"},Un={key:0,class:"mt-2"},Ln={class:"border rounded p-2"},Vn={class:"small text-muted mb-1"},Kn={class:"mt-2 d-flex gap-2"},Hn=["disabled"],Bn=["disabled"],Fn={key:0,class:"alert alert-success py-1 mt-2 mb-0"},jn={key:1,class:"alert alert-danger py-1 mt-2 mb-0"},Jn={class:"card shadow-sm"},Yn={class:"card-header fw-semibold d-flex align-items-center justify-content-between flex-wrap gap-2"},zn={class:"d-flex align-items-center gap-2 flex-wrap"},Gn={class:"btn-group btn-group-sm",role:"group","aria-label":"分组"},qn=["onClick"],Qn={class:"form-check form-check-sm ms-1"},Xn={class:"form-check form-check-sm ms-1"},Zn={class:"dropdown"},es={class:"btn btn-sm btn-outline-primary dropdown-toggle",type:"button","data-bs-toggle":"dropdown"},ts={class:"dropdown-menu dropdown-menu-end weeks-menu"},ns=["onClick"],ss={key:2,class:"btn btn-outline-secondary btn-sm",disabled:""},as={class:"dropdown"},os={class:"btn btn-sm btn-outline-primary dropdown-toggle",type:"button","data-bs-toggle":"dropdown"},ls={class:"dropdown-menu dropdown-menu-end months-menu"},rs=["onClick"],is={key:2,class:"btn btn-outline-secondary btn-sm",disabled:""},cs={class:"card-body"},us={key:0,class:"small text-body-secondary fw-semibold mb-1 mt-2"},ds={class:"badge text-bg-light ms-1"},vs={class:"list-group mb-2"},ms={class:"d-flex flex-wrap align-items-center gap-2"},fs={class:"fw-semibold"},ys={class:"text-body-secondary small"},bs={class:"text-body-secondary small"},ks={key:0,class:"badge text-bg-secondary ms-2"},ps={class:"ms-2 d-flex gap-2"},hs=["onClick"],ws=["onClick"],Es=["onClick"],_s=["onClick"],gs={key:0,class:"text-body-secondary small"},Je="historyViewPrefs/v2",Ds={__name:"DemandDetail",setup(P){h.extend(Pt);const S=It(),_=Number(S.params.id),r=p(null),F=p(!1),X=p(""),U=p(!1),E=p(""),L=p([]),ce=p([]),Z=p(!1),ue=xt(),T=b(()=>ue.user?.roles?.includes("ADMIN")),A=b(()=>ue.user?.roles?.includes("REVIEWER")),ee=b(()=>ue.employeeId),j=p(!1),$=b(()=>{const e=r.value?.category||"";return e.includes("周报")||e.includes("月报")}),de=b(()=>(r.value?.category||"").includes("周报")),ve=b(()=>(r.value?.category||"").includes("月报")),Ce=b(()=>de.value?[{key:"none",label:"不分组"},{key:"week",label:"按周"}]:ve.value?[{key:"none",label:"不分组"},{key:"month",label:"按月"}]:[{key:"none",label:"不分组"},{key:"week",label:"按周"},{key:"month",label:"按月"}]),Ye=b(()=>!$.value&&r.value?.status==="REVIEW_APPROVED"),ze=b(()=>!$.value&&r.value?.status==="COMPLETED"),y=p("week"),M=p("all"),I=p(!1);O(Ce,e=>{e.map(n=>n.key).includes(y.value)||(y.value=e[0]?.key||"none")},{immediate:!0});const v=p(""),m=p(""),Ne=p(!1);function Ge(){if(Ne.value)return;const e=(r.value?.category||"").toString();e.includes("周报")?(y.value="week",M.value="all"):e.includes("月报")&&(y.value="month",M.value="all"),Ne.value=!0}function qe(e){const t=Array.from(e.target.files||[]);L.value=t.length?t:null}function Qe(e){const t=String(e||"").trim();if(y.value==="week"&&m.value){const n=m.value,s=C(n);return JSON.stringify({key:n,label:s,filename:t})}if(y.value==="month"&&v.value){const n=v.value,s=C(n);return JSON.stringify({key:n,label:s,filename:t})}return t}function Xe(){if(y.value==="week"&&m.value){const e=V(m.value);if(e)return h().year(e.year).month(0).date(4).isoWeek(e.week).startOf("isoWeek").hour(12).minute(0).second(0).format("YYYY-MM-DDTHH:mm:ss")}if(y.value==="month"&&v.value){const e=K(v.value);if(e)return h().year(e.year).month(e.month-1).date(15).hour(12).minute(0).second(0).format("YYYY-MM-DDTHH:mm:ss")}return""}async function Ze(){if(!(!L.value||L.value.length===0)){Z.value=!0;try{for(const e of L.value){const t=Qe(e?.name),n=Xe();await Vt(_,e,{note:t,occurredAt:n})}await g()}catch(e){console.error("附件上传失败",e),alert(e?.response?.data?.message||e?.message||"附件上传失败")}finally{L.value=null,Z.value=!1,me.value&&(me.value.value="")}}}const me=p(null);function fe(e){return e?String(e).replace("T"," ").slice(0,19):""}function ye(){X.value=r.value?.title||""}function et(){ye(),F.value=!0}function tt(){ye(),F.value=!1}async function nt(){const e=X.value.trim();if(!e){alert("标题不能为空");return}U.value=!0;try{r.value=await Lt(_,e),F.value=!1}catch(t){alert(t?.response?.data?.message||"修改标题失败")}finally{U.value=!1}}function st(e){switch((e||"").toUpperCase()){case"DRAFT":return"text-bg-secondary";case"SUBMITTED":return"text-bg-info";case"ADMIN_APPROVED":case"IN_REVIEW":return"text-bg-primary";case"RETURNED":return"text-bg-warning";case"REJECTED":return"text-bg-danger";case"APPROVED":case"DONE":return"text-bg-success";case"COMPLETED":return"text-bg-success";case"WEEK_DONE":case"MONTH_DONE":return"text-bg-success";case"WEEK_NOT_DONE":case"MONTH_NOT_DONE":return"text-bg-secondary";default:return"text-bg-secondary"}}function be(e){switch(e){case"DRAFT":return"草稿";case"SUBMITTED":return"待主任审批";case"ADMIN_APPROVED":return"主任同意";case"ADMIN_REJECTED":return"主任驳回";case"REVIEW_APPROVED":return"科室同意";case"REVIEW_REJECTED":return"科室驳回";case"COMPLETED":return"已完成";case"WEEK_DONE":return"上周已完成";case"WEEK_NOT_DONE":return"上周未完成";case"MONTH_DONE":return"上月已完成";case"MONTH_NOT_DONE":return"上月未完成";default:return e||"未知"}}async function Oe(e){if(!E.value.trim()){alert("请填写审批意见");return}e==="admin"?await Kt(_,E.value.trim()):await Ht(_,E.value.trim()),E.value="",await g()}async function Se(e){if(!E.value.trim()){alert("请填写驳回理由");return}e==="admin"?await Bt(_,E.value.trim()):await Ft(_,E.value.trim()),E.value="",await g()}function at(e){const t=e.trim();if(!t)return"";if($.value){if(y.value==="week"&&m.value){const n=m.value,s=C(n);return JSON.stringify({key:n,label:s,text:t})}if(y.value==="month"&&v.value){const n=v.value,s=C(n);return JSON.stringify({key:n,label:s,text:t})}}return t}async function $e(){const e=E.value.trim();if(!e)return;const t=at(e);await jt(_,t),E.value="",await g()}async function ot(){await Jt(_,E.value.trim()||""),E.value="",await g()}async function lt(){await Yt(_,E.value.trim()||""),E.value="",await g()}function ke(){const e=h().subtract(1,"week"),t=`${e.isoWeekYear()}-W${String(e.isoWeek()).padStart(2,"0")}`,n=e.startOf("isoWeek"),s=e.endOf("isoWeek"),o=`${e.isoWeekYear()}年第${e.isoWeek()}周（${n.format("MM/DD")}~${s.format("MM/DD")}）`;return{key:t,label:o}}function pe(){if(m.value){const e=z.value.find(t=>t.key===m.value);return{key:m.value,label:e?.label||m.value}}return ke()}function he(){if(v.value){const s=Y.value.find(o=>o.key===v.value);return{key:v.value,label:s?.label||v.value}}const e=h().subtract(1,"month"),t=`${e.year()}-${String(e.month()+1).padStart(2,"0")}`,n=`${e.year()}年${String(e.month()+1).padStart(2,"0")}月`;return{key:t,label:n}}async function rt(){const{key:e,label:t}=pe();await zt(_,e,t),await g()}async function it(){const{key:e,label:t}=pe();await Gt(_,e,t),await g()}async function ct(){const{key:e,label:t}=he();await qt(_,e,t),await g()}async function ut(){const{key:e,label:t}=he();await Qt(_,e,t),await g()}async function dt(){for(const e of ce.value)try{URL.revokeObjectURL(e.src)}catch{}if(ce.value=[],!!r.value?.attachments?.length){for(const e of r.value.attachments)if(!Ee.value.has(Number(e.id))&&(e.contentType||"").startsWith("image/"))try{const t=await Me(e.id,"inline"),n=t.headers?.["content-type"]||e.contentType,s=new Blob([t.data],{type:n}),o=URL.createObjectURL(s);ce.value.push({id:e.id,name:e.originalFilename,src:o})}catch(t){console.warn("跳过无效图片附件",e.id,t?.response?.status);continue}}}async function g(){r.value=await Ut(_),ye(),await dt()}const Ie=b(()=>{const e=new Set;for(const t of r.value?.history||[])t.action==="COMMENT_DELETED"&&t.commentId!=null&&e.add(`C:${t.commentId}`),t.action==="ATTACHMENT_DELETED"&&t.attachmentId!=null&&e.add(`A:${t.attachmentId}`);return e});function J(e){return e.action==="COMMENT_ADDED"&&e.commentId!=null?Ie.value.has(`C:${e.commentId}`):e.action==="ATTACHMENT_ADDED"&&e.attachmentId!=null?Ie.value.has(`A:${e.attachmentId}`):!1}function vt(e){return e?.action==="COMMENT_ADDED"&&e?.commentId!=null&&e?.actorEmpId===ee.value}function mt(e){return e?.action==="ATTACHMENT_ADDED"&&e?.attachmentId!=null&&e?.actorEmpId===ee.value}async function ft(e){if(confirm("确定删除该附件？"))try{await en(e.attachmentId);try{Ee.value.add(Number(e.attachmentId))}catch{}await g()}catch(t){alert(t?.response?.data?.message||"删除失败")}}const we=b(()=>(r.value?.history||[]).filter(t=>!(t.action==="COMMENT_DELETED"||t.action==="ATTACHMENT_DELETED"||!j.value&&J(t))));async function yt(e){if(confirm("确定删除这条评论？"))try{await Xt(e.commentId),await g()}catch(t){alert(t?.response?.data?.message||"删除失败")}}const Ee=b(()=>{const e=new Set,t=r.value?.history||[];for(const n of t)n.action==="ATTACHMENT_DELETED"&&n.attachmentId!=null&&e.add(Number(n.attachmentId));return e});function bt(e){return e?.action==="ATTACHMENT_ADDED"&&e?.attachmentId!=null&&!Ee.value.has(Number(e.attachmentId))}const te={};async function xe(e){if(!te[e])try{te[e]=await Zt(e)}catch{te[e]={}}return te[e]||{}}async function kt(e){const t=e.attachmentId,n=window.open("","_blank");try{const s=await xe(t),o=await Me(t,"inline"),l=o.headers?.["content-type"]||s.contentType||"application/octet-stream",u=new Blob([o.data],{type:l}),k=URL.createObjectURL(u);n?n.location.href=k:window.open(k,"_blank"),setTimeout(()=>URL.revokeObjectURL(k),60*1e3)}catch(s){n&&n.close(),alert(s?.response?.data?.message||"预览失败或附件已被删除")}}async function pt(e){const t=e.attachmentId;try{const n=await xe(t),s=await Me(t,"download"),o=new Blob([s.data],{type:s.headers?.["content-type"]||"application/octet-stream"}),l=URL.createObjectURL(o),u=document.createElement("a");u.href=l,u.download=n.name||`file-${t}`,document.body.appendChild(u),u.click(),u.remove(),setTimeout(()=>URL.revokeObjectURL(l),10*1e3)}catch(n){alert(n?.response?.data?.message||"下载失败或附件已被删除")}}function ne(e){const t=h(e);return{y:t.isoWeekYear(),w:t.isoWeek()}}const Y=b(()=>{const e=new Map;for(const t of we.value){if(I.value&&t.action!=="ATTACHMENT_ADDED")continue;const n=G(t);!n||!K(n.key)||e.has(n.key)||e.set(n.key,{key:n.key,label:n.label,sort:n.sort})}return[...e.values()].sort((t,n)=>n.sort-t.sort)}),z=b(()=>{const e=new Map;for(const t of we.value){if(I.value&&t.action!=="ATTACHMENT_ADDED")continue;const n=G(t);!n||!V(n.key)||e.has(n.key)||e.set(n.key,{key:n.key,label:n.label,sort:n.sort})}return[...e.values()].sort((t,n)=>n.sort-t.sort)}),ht=b(()=>v.value?`月份：${Y.value.find(e=>e.key===v.value)?.label||v.value}`:"选择月份"),wt=b(()=>m.value?`周次：${z.value.find(e=>e.key===m.value)?.label||m.value}`:"选择周");function We(e){v.value=e,e&&(M.value="all"),m.value=""}function Re(e){m.value=e,e&&(M.value="all"),v.value=""}function Pe(){const e=z.value;if(!e.length)return"";const{key:t}=ke(),n=V(t);if(!n)return e[0].key;const s=n.sort;let o=e[0],l=Math.abs((e[0].sort??0)-s);for(const u of e){const k=Math.abs((u.sort??0)-s);k<l&&(o=u,l=k)}return o.key}function Ue(){const e=Y.value;if(!e.length)return"";const t=h().subtract(1,"month"),n=`${t.year()}-${String(t.month()+1).padStart(2,"0")}`,s=K(n);if(!s)return e[0].key;const o=s.sort;let l=e[0],u=Math.abs((e[0].sort??0)-o);for(const k of e){const D=Math.abs((k.sort??0)-o);D<u&&(l=k,u=D)}return l.key}O(y,e=>{if(e==="none"){v.value="",m.value="";return}if(e==="week"&&(v.value="",!m.value)){const t=Pe();t&&(m.value=t)}if(e==="month"&&(m.value="",!v.value)){const t=Ue();t&&(v.value=t)}});const Le=b(()=>{const e=we.value,t=h(),{y:n,w:s}=ne(t),{y:o,w:l}=ne(t.subtract(1,"week"));return e.filter(u=>{if(I.value&&u.action!=="ATTACHMENT_ADDED")return!1;const k=G(u);if(y.value==="week"&&m.value&&(!k||k.key!==m.value)||y.value==="month"&&v.value&&(!k||k.key!==v.value))return!1;const D=h(u.occurredAt);if(!D.isValid())return!1;switch(M.value){case"thisWeek":{const{y:B,w:Te}=ne(D);return B===n&&Te===s}case"lastWeek":{const{y:B,w:Te}=ne(D);return B===o&&Te===l}case"thisMonth":return D.year()===t.year()&&D.month()===t.month();case"lastMonth":{const B=t.subtract(1,"month");return D.year()===B.year()&&D.month()===B.month()}default:return!0}})}),Et=b(()=>{const e=Le.value;if(y.value==="week"){const n=new Map;for(const o of e){const l=G(o);l&&(n.has(l.key)||n.set(l.key,{key:l.key,label:l.label,sort:l.sort,items:[]}),n.get(l.key).items.push(o))}const s=[...n.values()].sort((o,l)=>l.sort-o.sort);return s.forEach(o=>o.items.sort((l,u)=>h(u.occurredAt).valueOf()-h(l.occurredAt).valueOf())),s}if(y.value==="month"){const n=new Map;for(const o of e){const l=G(o);l&&(n.has(l.key)||n.set(l.key,{...l,items:[]}),n.get(l.key).items.push(o))}const s=[...n.values()].sort((o,l)=>l.sort-o.sort);return s.forEach(o=>o.items.sort((l,u)=>h(u.occurredAt).valueOf()-h(l.occurredAt).valueOf())),s}return[{key:"all",label:"全部",items:e.slice().sort((n,s)=>h(s.occurredAt).valueOf()-h(n.occurredAt).valueOf())}]});Wt(async()=>{try{const e=JSON.parse(localStorage.getItem(Je)||"{}");e.viewGrouping&&(y.value=e.viewGrouping),e.timeFilter&&(M.value=e.timeFilter),typeof e.onlyAttachments=="boolean"&&(I.value=e.onlyAttachments),typeof e.selectedMonthKey=="string"&&(v.value=e.selectedMonthKey),typeof e.selectedWeekKey=="string"&&(m.value=e.selectedWeekKey),typeof e.showDeleted=="boolean"&&(j.value=e.showDeleted)}catch{}await g(),await Rt(),Ge()}),O([y,M,I,v,m,j],([e,t,n,s,o,l])=>{localStorage.setItem(Je,JSON.stringify({viewGrouping:e,timeFilter:t,onlyAttachments:n,selectedMonthKey:s,selectedWeekKey:o,showDeleted:l}))}),O(z,e=>{if(y.value==="week"){if(!m.value&&e.length){const t=Pe();t&&(m.value=t);return}m.value&&(e.some(n=>n.key===m.value)||(m.value=""))}}),O(Y,e=>{if(y.value==="month"){if(!v.value&&e.length){const t=Ue();t&&(v.value=t);return}v.value&&(e.some(n=>n.key===v.value)||(v.value=""))}}),O(M,e=>{e!=="all"&&(v.value="",m.value="")});function _e(e){if(!e||typeof e!="string")return null;try{const t=JSON.parse(e);return t&&typeof t=="object"?t:null}catch{return null}}function _t(e){const t=_e(e);if(t?.label)return String(t.label);const n=/"label"\s*:\s*"([^"]+)"/.exec(e||"");return n?n[1]:(e||"").trim()}function se(e){const t=String(e||"").toUpperCase(),n=/(UNMARK|UNDO|UNSET|CANCEL|REVOKE|ROLLBACK)/.test(t)||/^UN/.test(t),s=/WEEK/.test(t)||/W(\d{1,2})/.test(t),o=/MONTH/.test(t)||/-?\d{4}-\d{1,2}/.test(t),l=!s&&!o&&/(COMPLETE|COMPLETED|DONE|FINISH|FINISHED)/.test(t);return{raw:t,isUndo:n,isWeek:s,isMonth:o,isOverall:l}}function gt(e){const t=se(e?.action,e?.note),n=t.isOverall||t.isWeek||t.isMonth;return n&&t.isUndo?"text-danger fw-semibold":n&&!t.isUndo?"text-success fw-semibold":""}function Dt(e){return(r.value?.attachments||[]).find(n=>String(n.id)===String(e))?.originalFilename||`附件 #${e}`}function Tt(e){const t=se(e?.action),n=(e?.note||"").trim(),s=_t(n)||e?.key||"";if(t.isWeek)return t.isUndo?`撤销${s?`${s}`:""}已完成`:`确认${s?`${s}`:""}已完成`;if(t.isMonth)return t.isUndo?`撤销${s?`${s}`:""}已完成`:`确认${s?`${s}`:""}已完成`;if(t.isOverall)return t.isUndo?`撤销完成${s?`：${s}`:""}`:`确认完成${s?`：${s}`:""}`;switch(t.raw){case"CREATE_DRAFT":return"保存草稿";case"SUBMIT":return"用户提交";case"ADMIN_APPROVE":return n?`主任同意：${n}`:"主任同意";case"ADMIN_REJECT":return n?`主任驳回：${n}`:"主任驳回";case"REVIEW_APPROVE":return n?`科室同意：${n}`:"科室同意";case"REVIEW_REJECT":return n?`科室驳回：${n}`:"科室驳回";case"COMMENT_ADDED":{const l=_e(n);return l&&l.text?l.text:n?`${n}`:"发表意见"}case"ATTACHMENT_ADDED":{const l=_e(n),u=l?.filename||(e?.attachmentId?Dt(e.attachmentId):"")||"附件";return l?.label&&`${l.label}`,`上传附件：${u}`}}return/(APPROVE)/.test(t.raw)&&/(ADMIN|DIRECTOR)/.test(t.raw)?n?`主任同意：${n}`:"主任同意":/(REJECT)/.test(t.raw)&&/(ADMIN|DIRECTOR)/.test(t.raw)?n?`主任驳回：${n}`:"主任驳回":/(APPROVE|PASS)/.test(t.raw)&&/(REVIEW|DEPT|SECTION)/.test(t.raw)?n?`科室同意：${n}`:"科室同意":/(REJECT)/.test(t.raw)&&/(REVIEW|DEPT|SECTION)/.test(t.raw)?n?`科室驳回：${n}`:"科室驳回":s||n||"（系统记录）"}function Ve(e){const t=String(e??"").trim();if(!t)return null;if(t.startsWith("{"))try{const o=JSON.parse(t);if(o&&typeof o.key=="string"&&o.key)return o.key}catch{}const n=t.match(/\b(\d{4})-W(\d{1,2})\b/);if(n)return`${n[1]}-W${String(n[2]).padStart(2,"0")}`;const s=t.match(/\b(\d{4})-(\d{1,2})\b/);return s?`${s[1]}-${String(s[2]).padStart(2,"0")}`:null}function C(e){const t=V(e);if(t){const o=h().year(t.year).month(0).date(4).isoWeek(t.week).startOf("isoWeek"),l=o.endOf("isoWeek");return`${t.year}年第${t.week}周（${o.format("MM/DD")}~${l.format("MM/DD")}）`}const n=K(e);return n?`${n.year}年${String(n.month).padStart(2,"0")}月`:e}function G(e){const t=se(e?.action),n=Ve(e?.note)||(typeof e?.key=="string"?e.key.trim():"");if(n){const o=V(n);if(o)return{key:n,label:C(n),sort:o.sort};const l=K(n);if(l)return{key:n,label:C(n),sort:l.sort}}if(t.isWeek||t.isMonth)return null;const s=h(e?.occurredAt);if(!s.isValid())return null;if(y.value==="week"){const o=s.isoWeekYear(),l=s.isoWeek(),u=`${o}-W${String(l).padStart(2,"0")}`,k=V(u);return k?{key:u,label:C(u),sort:k.sort}:null}if(y.value==="month"){const o=s.year(),l=s.month()+1,u=`${o}-${String(l).padStart(2,"0")}`,k=K(u);return k?{key:u,label:C(u),sort:k.sort}:null}return null}const ae=b(()=>{const t=[...Array.isArray(r.value?.history)?r.value.history:[]].sort((o,l)=>{const u=h(o?.occurredAt).valueOf()||0,k=h(l?.occurredAt).valueOf()||0;return u-k}),n=new Map,s=new Map;for(const o of t){const l=se(o?.action);if(!l.isWeek&&!l.isMonth)continue;const u=Ve(o?.note)||(typeof o?.key=="string"?o.key:null);u&&(l.isWeek&&n.set(u,!l.isUndo),l.isMonth&&s.set(u,!l.isUndo))}return{weekState:n,monthState:s}});function V(e){const t=/^(\d{4})-W(\d{1,2})$/.exec(e||"");if(!t)return null;const n=Number(t[1]),s=Number(t[2]);return{year:n,week:s,sort:n*100+s}}function K(e){const t=/^(\d{4})-(\d{1,2})$/.exec(e||"");if(!t)return null;const n=Number(t[1]),s=Number(t[2]);return{year:n,month:s,sort:n*100+s}}const At=b(()=>{const e=ae.value.weekState;if(!e||e.size===0)return!1;const{key:t}=ke();return!!e.get(t)}),Mt=b(()=>{const e=ae.value.monthState;if(!e||e.size===0)return!1;const t=h().subtract(1,"month"),n=`${t.year()}-${String(t.month()+1).padStart(2,"0")}`;return!!e.get(n)}),oe=b(()=>{const e=String(r.value?.status||"");return!$.value||["DRAFT","SUBMITTED","ADMIN_APPROVED","ADMIN_REJECTED","REVIEW_REJECTED","RETURNED"].includes(e)?e:de.value?At.value?"WEEK_DONE":"WEEK_NOT_DONE":ve.value?Mt.value?"MONTH_DONE":"MONTH_NOT_DONE":e}),Ke=b(()=>{const e=pe().key;return!!ae.value.weekState.get(e)}),He=b(()=>{const e=he().key;return!!ae.value.monthState.get(e)}),x=p(!1),W=p(""),ge=p(!1),R=p(!1),H=p(""),N=p(""),Ct=b(()=>{const e=r.value?.contactPhone;return!!e&&e.trim().length>0}),Be=b(()=>{const e=r.value?.title||"",t=be(oe.value);return`您的需求：${e} 状态已更新，当前状态：${t}`});function Nt(){x.value=!0,H.value="",N.value="",ge.value=!1,W.value=Be.value}function De(){x.value=!1,H.value="",N.value=""}function Ot(){x.value?De():Nt()}O([()=>oe.value,()=>r.value?.title],()=>{x.value&&!ge.value&&(W.value=Be.value)});async function St(){if(H.value="",N.value="",!Ct.value){N.value="联系电话为空，无法发送短信";return}const e=(W.value||"").trim();if(!e){N.value="短信内容不能为空";return}try{R.value=!0,await ie.post(`/api/demands/${r.value.id}/sms/notify`,{content:e}),H.value="短信已提交发送",De()}catch(t){N.value=t?.response?.data?.message||t?.message||"短信发送失败"}finally{R.value=!1}}return O(()=>r.value?.id,()=>{De(),W.value="",ge.value=!1,R.value=!1}),(e,t)=>r.value?(c(),i("div",tn,[a("div",nn,[a("div",sn,[a("div",an,[F.value?(c(),i(w,{key:1},[a("span",ln,"#"+d(r.value.id),1),q(a("input",{"onUpdate:modelValue":t[0]||(t[0]=n=>X.value=n),class:"form-control form-control-sm",style:{"min-width":"240px"},disabled:U.value},null,8,rn),[[Ae,X.value]])],64)):(c(),i("h2",on,"#"+d(r.value.id)+" "+d(r.value.title),1)),a("span",{class:le(["badge",st(oe.value)])},d(be(oe.value)),3)]),T.value?(c(),i("div",cn,[F.value?(c(),i(w,{key:1},[a("button",{class:"btn btn-primary btn-sm",onClick:nt,disabled:U.value},d(U.value?"保存中…":"保存"),9,un),a("button",{class:"btn btn-outline-secondary btn-sm",onClick:tt,disabled:U.value}," 取消 ",8,dn)],64)):(c(),i("button",{key:0,class:"btn btn-outline-secondary btn-sm",onClick:et}," 修改标题 "))])):f("",!0)]),r.value.submittedAt||r.value.createdAt?(c(),i("div",vn," 最近更新："+d(fe(r.value.submittedAt||r.value.createdAt)),1)):f("",!0)]),a("div",mn,[t[18]||(t[18]=a("div",{class:"card-header fw-semibold"},"基本信息",-1)),a("div",fn,[a("div",yn,[a("div",bn,[t[12]||(t[12]=a("div",{class:"text-body-secondary small mb-1"},"申请类型",-1)),a("div",null,[a("span",kn,d(r.value.category||"未分类"),1)])]),a("div",pn,[t[13]||(t[13]=a("div",{class:"text-body-secondary small mb-1"},"影响范围",-1)),a("div",null,d(r.value.impactScope||"-"),1)]),a("div",hn,[t[14]||(t[14]=a("div",{class:"text-body-secondary small mb-1"},"联系电话",-1)),a("div",null,d(r.value.contactPhone||"-"),1)]),a("div",wn,[t[15]||(t[15]=a("div",{class:"text-body-secondary small mb-1"},"地点/科室",-1)),a("div",null,d(r.value.location||"-"),1)]),a("div",En,[t[16]||(t[16]=a("div",{class:"text-body-secondary small mb-1"},"提交人",-1)),a("div",null,d(r.value.createdByName)+"("+d(r.value.createdByDept)+"/"+d(r.value.createdByEmpId)+")",1)]),a("div",_n,[t[17]||(t[17]=a("div",{class:"text-body-secondary small mb-1"},"提交时间",-1)),a("div",null,d(fe(r.value.submittedAt||r.value.createdAt)),1)])])])]),a("div",gn,[t[19]||(t[19]=a("div",{class:"card-header fw-semibold"},"需求详情",-1)),a("div",Dn,[a("pre",Tn,d(r.value.description),1)])]),a("div",An,[t[21]||(t[21]=a("div",{class:"card-header fw-semibold"},"附件",-1)),a("div",Mn,[t[20]||(t[20]=a("div",{class:"alert alert-light border py-2 mb-3",role:"alert"},[Fe(" 新上传的附件会出现在下方流转历史，"),a("b",null,"（周报或月报注意时间选取，默认为最新一周或最新一月）")],-1)),a("div",Cn,[a("input",{type:"file",class:"form-control",ref_key:"fileInput",ref:me,multiple:"",onChange:qe},null,544),a("button",{class:"btn btn-primary",onClick:Ze,disabled:!L.value||Z.value},d(Z.value?"上传中…":"上传附件"),9,Nn)])])]),a("div",On,[a("div",Sn,[t[22]||(t[22]=a("span",null,"意见与审批",-1)),T.value||A.value?(c(),i("small",$n," 当前状态："+d(be(r.value.status)),1)):f("",!0)]),a("div",In,[a("div",xn,[q(a("textarea",{class:"form-control",rows:"4","onUpdate:modelValue":t[1]||(t[1]=n=>E.value=n),placeholder:"填写意见（周报或月报需要注意时间选取，默认为最新一周或最新一月）"},null,512),[[Ae,E.value]])]),a("div",Wn,[T.value?(c(),i(w,{key:0},[r.value.status==="SUBMITTED"?(c(),i("button",{key:0,class:"btn btn-success btn-sm",onClick:t[2]||(t[2]=n=>Oe("admin"))},"主任同意")):f("",!0),r.value.status==="SUBMITTED"?(c(),i("button",{key:1,class:"btn btn-danger btn-sm",onClick:t[3]||(t[3]=n=>Se("admin"))},"主任驳回")):f("",!0)],64)):f("",!0),A.value?(c(),i(w,{key:1},[r.value.status==="ADMIN_APPROVED"?(c(),i("button",{key:0,class:"btn btn-success btn-sm",onClick:t[4]||(t[4]=n=>Oe("reviewer"))},"科室同意")):f("",!0),r.value.status==="ADMIN_APPROVED"?(c(),i("button",{key:1,class:"btn btn-danger btn-sm",onClick:t[5]||(t[5]=n=>Se("reviewer"))},"科室驳回")):f("",!0)],64)):f("",!0),T.value||A.value?(c(),i("button",{key:2,class:"btn btn-outline-secondary btn-sm",onClick:$e},"仅发表意见")):(c(),i("button",{key:3,class:"btn btn-primary btn-sm",onClick:$e},"发布")),T.value||A.value?(c(),i(w,{key:4},[a("button",{class:"btn btn-outline-primary btn-sm",disabled:R.value||!r.value?.contactPhone,onClick:Ot},d(x.value?"收起短信":"短信通知"),9,Rn),r.value?.contactPhone?f("",!0):(c(),i("small",Pn," 联系电话为空 "))],64)):f("",!0),t[23]||(t[23]=a("div",{class:"vr mx-2 d-none d-sm-block"},null,-1)),!$.value&&(T.value||A.value)?(c(),i(w,{key:5},[Ye.value?(c(),i("button",{key:0,class:"btn btn-success btn-sm",onClick:ot},"标记为已完成")):f("",!0),ze.value?(c(),i("button",{key:1,class:"btn btn-danger btn-sm",onClick:lt},"撤销已完成")):f("",!0)],64)):f("",!0)]),x.value&&(T.value||A.value)?(c(),i("div",Un,[a("div",Ln,[a("div",Vn," 发送到："+d(r.value?.contactPhone),1),q(a("textarea",{class:"form-control form-control-sm",rows:"2","onUpdate:modelValue":t[6]||(t[6]=n=>W.value=n),placeholder:"短信内容（按模板规则：这里只填变量值，不要带{}）"},null,512),[[Ae,W.value]]),a("div",Kn,[a("button",{class:"btn btn-primary btn-sm",onClick:St,disabled:R.value||!W.value.trim()},d(R.value?"发送中…":"发送短信"),9,Hn),a("button",{class:"btn btn-outline-secondary btn-sm",onClick:t[7]||(t[7]=n=>x.value=!1),disabled:R.value}," 取消 ",8,Bn)]),H.value?(c(),i("div",Fn,d(H.value),1)):f("",!0),N.value?(c(),i("div",jn,d(N.value),1)):f("",!0)])])):f("",!0)])]),a("div",Jn,[a("div",Yn,[t[28]||(t[28]=a("span",null,"流转历史",-1)),a("div",zn,[a("div",Gn,[(c(!0),i(w,null,Q(Ce.value,n=>(c(),i("button",{key:n.key,type:"button",class:le(["btn btn-outline-secondary",{active:y.value===n.key}]),onClick:s=>y.value=n.key},d(n.label),11,qn))),128))]),a("div",Qn,[q(a("input",{class:"form-check-input",type:"checkbox",id:"onlyAtt","onUpdate:modelValue":t[8]||(t[8]=n=>I.value=n)},null,512),[[je,I.value]]),t[24]||(t[24]=a("label",{class:"form-check-label small",for:"onlyAtt"},"仅附件",-1))]),a("div",Xn,[q(a("input",{class:"form-check-input",type:"checkbox",id:"showDeleted","onUpdate:modelValue":t[9]||(t[9]=n=>j.value=n)},null,512),[[je,j.value]]),t[25]||(t[25]=a("label",{class:"form-check-label small",for:"showDeleted"},"包含已删除",-1))]),y.value==="week"?(c(),i(w,{key:0},[a("div",Zn,[a("button",es,d(wt.value),1),a("ul",ts,[a("li",null,[a("a",{class:"dropdown-item",href:"#",onClick:t[10]||(t[10]=re(n=>Re(""),["prevent"]))},"（全部周）")]),t[26]||(t[26]=a("li",null,[a("hr",{class:"dropdown-divider"})],-1)),(c(!0),i(w,null,Q(z.value,n=>(c(),i("li",{key:n.key},[a("a",{class:"dropdown-item",href:"#",onClick:re(s=>Re(n.key),["prevent"])},d(n.label),9,ns)]))),128))])]),$.value&&de.value&&(T.value||A.value||ee.value===r.value.createdByEmpId)?(c(),i(w,{key:0},[m.value&&!Ke.value?(c(),i("button",{key:0,class:"btn btn-success btn-sm",onClick:rt}," 确认该周完成 ")):m.value&&Ke.value?(c(),i("button",{key:1,class:"btn btn-danger btn-sm",onClick:it}," 撤销该周完成 ")):(c(),i("button",ss," 请先选择周次 "))],64)):f("",!0)],64)):f("",!0),y.value==="month"?(c(),i(w,{key:1},[a("div",as,[a("button",os,d(ht.value),1),a("ul",ls,[a("li",null,[a("a",{class:"dropdown-item",href:"#",onClick:t[11]||(t[11]=re(n=>We(""),["prevent"]))},"（全部月份）")]),t[27]||(t[27]=a("li",null,[a("hr",{class:"dropdown-divider"})],-1)),(c(!0),i(w,null,Q(Y.value,n=>(c(),i("li",{key:n.key},[a("a",{class:"dropdown-item",href:"#",onClick:re(s=>We(n.key),["prevent"])},d(n.label),9,rs)]))),128))])]),$.value&&ve.value&&(T.value||A.value||ee.value===r.value.createdByEmpId)?(c(),i(w,{key:0},[v.value&&!He.value?(c(),i("button",{key:0,class:"btn btn-success btn-sm",onClick:ct}," 确认该月完成 ")):v.value&&He.value?(c(),i("button",{key:1,class:"btn btn-danger btn-sm",onClick:ut}," 撤销该月完成 ")):(c(),i("button",is," 请先选择月份 "))],64)):f("",!0)],64)):f("",!0)])]),a("div",cs,[(c(!0),i(w,null,Q(Et.value,n=>(c(),i(w,{key:n.key},[y.value!=="none"?(c(),i("div",us,[Fe(d(n.label)+" ",1),a("span",ds,d(n.items.length),1)])):f("",!0),a("ul",vs,[(c(!0),i(w,null,Q(n.items,s=>(c(),i("li",{key:s.id??s.occurredAt+"-"+s.action,class:le(["list-group-item d-flex justify-content-between align-items-start",{"text-decoration-line-through opacity-75":J(s)}])},[a("div",null,[a("div",ms,[a("span",fs,d(s.actorName),1),a("span",ys,"("+d(s.actorEmpId)+")",1),a("span",bs," @ "+d(fe(s.occurredAt)),1),J(s)?(c(),i("span",ks,"已删除")):f("",!0)]),a("div",{class:le(["mt-1",gt(s)])},d(Tt(s)),3)]),a("div",ps,[bt(s)?(c(),i(w,{key:0},[a("button",{class:"btn btn-sm btn-outline-primary",onClick:o=>kt(s)},"预览",8,hs),a("button",{class:"btn btn-sm btn-outline-secondary",onClick:o=>pt(s)},"下载",8,ws)],64)):f("",!0),vt(s)&&!J(s)?(c(),i("button",{key:1,class:"btn btn-sm btn-outline-danger",onClick:o=>yt(s)},"删除",8,Es)):mt(s)&&!J(s)?(c(),i("button",{key:2,class:"btn btn-sm btn-outline-danger",onClick:o=>ft(s)},"删除",8,_s)):f("",!0)])],2))),128))])],64))),128)),Le.value.length===0?(c(),i("div",gs,"没有符合条件的记录。")):f("",!0)])])])):f("",!0)}},Ns=$t(Ds,[["__scopeId","data-v-3bc3af84"]]);export{Ns as default};
