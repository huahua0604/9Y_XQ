import{_ as lt,g as rt,r as _,u as it,i as v,A as L,k as ct,B as ut,c as u,b as p,a as s,t as m,n as S,f as ne,d as se,v as dt,F as g,l as Ae,w as j,p as J,o as d}from"./index-Dg_DVxb1.js";import{d as E,i as mt}from"./isoWeek-D1M7nHiN.js";import{g as vt,u as ft,b as yt,r as bt,d as pt,e as kt,f as wt,m as Et,h as ht,i as Dt,j as _t,k as gt,n as At,o as Mt}from"./demand-CP8LuukM.js";import{h as oe}from"./axios-Bu_eimxu.js";function Tt(N){return oe.get(`/api/files/${N}/meta`).then(T=>T.data)}function ae(N,T="inline"){return oe.get(`/api/files/${N}/${T}`,{responseType:"blob"})}function Ct(N){return oe.delete(`/api/files/${N}`).then(T=>T.data)}const Nt={key:0,class:"container my-4"},$t={class:"d-flex align-items-center justify-content-between mb-3"},Ot={class:"d-flex align-items-center gap-2"},It={class:"h5 mb-0"},Wt={key:0,class:"text-body-secondary small"},St={class:"card shadow-sm mb-3"},Rt={class:"card-body"},xt={class:"row g-3"},Ut={class:"col-12 col-md-6"},Pt={class:"badge text-bg-info"},Lt={class:"col-12 col-md-6"},Vt={class:"col-6 col-md-3"},Kt={class:"col-6 col-md-3"},Ht={class:"col-12 col-md-6"},Bt={class:"col-12 col-md-6"},Ft={class:"card shadow-sm mb-3"},jt={class:"card-body"},Jt={class:"mb-0 text-wrap",style:{"white-space":"pre-wrap"}},Yt={class:"card shadow-sm mb-3"},zt={class:"card-body"},Gt={class:"input-group"},qt=["disabled"],Qt={class:"card shadow-sm mb-3"},Xt={class:"card-header fw-semibold d-flex align-items-center justify-content-between"},Zt={key:0,class:"text-body-secondary"},en={class:"card-body"},tn={class:"mb-2"},nn={class:"d-flex flex-wrap gap-2 align-items-center"},sn={class:"card shadow-sm"},an={class:"card-header fw-semibold d-flex align-items-center justify-content-between flex-wrap gap-2"},on={class:"d-flex align-items-center gap-2 flex-wrap"},ln={class:"btn-group btn-group-sm",role:"group","aria-label":"分组"},rn={class:"form-check form-check-sm ms-1"},cn={class:"form-check form-check-sm ms-1"},un={class:"dropdown"},dn={class:"btn btn-sm btn-outline-primary dropdown-toggle",type:"button","data-bs-toggle":"dropdown"},mn={class:"dropdown-menu dropdown-menu-end weeks-menu"},vn=["onClick"],fn=["disabled"],yn=["disabled"],bn={class:"dropdown"},pn={class:"btn btn-sm btn-outline-primary dropdown-toggle",type:"button","data-bs-toggle":"dropdown"},kn={class:"dropdown-menu dropdown-menu-end months-menu"},wn=["onClick"],En=["disabled"],hn=["disabled"],Dn={class:"card-body"},_n={key:0,class:"small text-body-secondary fw-semibold mb-1 mt-2"},gn={class:"badge text-bg-light ms-1"},An={class:"list-group mb-2"},Mn={class:"d-flex flex-wrap align-items-center gap-2"},Tn={class:"fw-semibold"},Cn={class:"text-body-secondary small"},Nn={class:"text-body-secondary small"},$n={key:0,class:"badge text-bg-secondary ms-2"},On={class:"ms-2 d-flex gap-2"},In=["onClick"],Wn=["onClick"],Sn=["onClick"],Rn=["onClick"],xn={key:0,class:"text-body-secondary small"},Me="historyViewPrefs/v2",Un={__name:"DemandDetail",setup(N){E.extend(mt);const T=rt(),D=Number(T.params.id),i=_(null),w=_(""),$=_([]),Y=_([]),V=_(!1),z=it(),O=v(()=>z.user?.roles?.includes("ADMIN")),I=v(()=>z.user?.roles?.includes("REVIEWER")),K=v(()=>z.employeeId),H=_(!1),W=v(()=>{const e=i.value?.category||"";return e.includes("周报")||e.includes("月报")}),le=v(()=>(i.value?.category||"").includes("周报")),re=v(()=>(i.value?.category||"").includes("月报")),Te=v(()=>!W.value&&i.value?.status==="REVIEW_APPROVED"),Ce=v(()=>!W.value&&i.value?.status==="COMPLETED"),k=_("week"),M=_("all"),C=_(!1),y=_(""),b=_(""),ie=_(!1);function ce(){return P.value?.[0]?.key||""}function ue(){return U.value?.[0]?.key||""}function Ne(){if(ie.value)return;const e=(i.value?.category||"").toString();e.includes("周报")?(k.value="week",M.value="all",b.value=ce()):e.includes("月报")&&(k.value="month",M.value="all",y.value=ue()),ie.value=!0}function $e(e){const t=Array.from(e.target.files||[]);$.value=t.length?t:null}async function Oe(){if(!(!$.value||$.value.length===0)){V.value=!0;try{for(const e of $.value)await ft(D,e);window.location.reload()}finally{$.value=null,V.value=!1,G.value&&(G.value.value="")}}}const G=_(null);function q(e){return e?String(e).replace("T"," ").slice(0,19):""}function Ie(e){switch((e||"").toUpperCase()){case"DRAFT":return"text-bg-secondary";case"SUBMITTED":return"text-bg-info";case"ADMIN_APPROVED":case"IN_REVIEW":return"text-bg-primary";case"RETURNED":return"text-bg-warning";case"REJECTED":return"text-bg-danger";case"APPROVED":case"DONE":return"text-bg-success";case"COMPLETED":return"text-bg-success";case"WEEK_DONE":case"MONTH_DONE":return"text-bg-success";case"WEEK_NOT_DONE":case"MONTH_NOT_DONE":return"text-bg-secondary";default:return"text-bg-secondary"}}function de(e){switch(e){case"DRAFT":return"草稿";case"SUBMITTED":return"待主任审批";case"ADMIN_APPROVED":return"主任同意";case"ADMIN_REJECTED":return"主任驳回";case"REVIEW_APPROVED":return"科室同意";case"REVIEW_REJECTED":return"科室驳回";case"COMPLETED":return"已完成";case"WEEK_DONE":return"上周已完成";case"WEEK_NOT_DONE":return"上周未完成";case"MONTH_DONE":return"上月已完成";case"MONTH_NOT_DONE":return"上月未完成";default:return e||"未知"}}async function me(e){if(!w.value.trim()){alert("请填写审批意见");return}e==="admin"?await yt(D,w.value.trim()):await bt(D,w.value.trim()),w.value="",await A()}async function ve(e){if(!w.value.trim()){alert("请填写驳回理由");return}e==="admin"?await pt(D,w.value.trim()):await kt(D,w.value.trim()),w.value="",await A()}async function fe(){w.value.trim()&&(await wt(D,w.value.trim()),w.value="",await A())}async function We(){await Et(D,w.value.trim()||""),w.value="",await A()}async function Se(){await ht(D,w.value.trim()||""),w.value="",await A()}function Q(){if(b.value){const l=P.value.find(c=>c.key===b.value);return{key:b.value,label:l?.label||b.value}}const e=E(),t=`${e.isoWeekYear()}-W${String(e.isoWeek()).padStart(2,"0")}`,n=e.startOf("isoWeek"),a=e.endOf("isoWeek"),o=`${e.isoWeekYear()}年第${e.isoWeek()}周（${n.format("MM/DD")}–${a.format("MM/DD")}）`;return{key:t,label:o}}function X(){if(y.value){const a=U.value.find(o=>o.key===y.value);return{key:y.value,label:a?.label||y.value}}const e=E(),t=`${e.year()}-${String(e.month()+1).padStart(2,"0")}`,n=`${e.year()}年${String(e.month()+1).padStart(2,"0")}月`;return{key:t,label:n}}async function Re(){const{key:e,label:t}=Q();await Dt(D,e,t),await A()}async function xe(){const{key:e,label:t}=Q();await _t(D,e,t),await A()}async function Ue(){const{key:e,label:t}=X();await gt(D,e,t),await A()}async function Pe(){const{key:e,label:t}=X();await At(D,e,t),await A()}async function Le(){for(const e of Y.value)try{URL.revokeObjectURL(e.src)}catch{}if(Y.value=[],!!i.value?.attachments?.length){for(const e of i.value.attachments)if(!ee.value.has(Number(e.id))&&(e.contentType||"").startsWith("image/"))try{const t=await ae(e.id,"inline"),n=t.headers?.["content-type"]||e.contentType,a=new Blob([t.data],{type:n}),o=URL.createObjectURL(a);Y.value.push({id:e.id,name:e.originalFilename,src:o})}catch(t){console.warn("跳过无效图片附件",e.id,t?.response?.status);continue}}}async function A(){i.value=await vt(D),await Le()}const ye=v(()=>{const e=new Set;for(const t of i.value?.history||[])t.action==="COMMENT_DELETED"&&t.commentId!=null&&e.add(`C:${t.commentId}`),t.action==="ATTACHMENT_DELETED"&&t.attachmentId!=null&&e.add(`A:${t.attachmentId}`);return e});function R(e){return e.action==="COMMENT_ADDED"&&e.commentId!=null?ye.value.has(`C:${e.commentId}`):e.action==="ATTACHMENT_ADDED"&&e.attachmentId!=null?ye.value.has(`A:${e.attachmentId}`):!1}function Ve(e){return e?.action==="COMMENT_ADDED"&&e?.commentId!=null&&e?.actorEmpId===K.value}function Ke(e){return e?.action==="ATTACHMENT_ADDED"&&e?.attachmentId!=null&&e?.actorEmpId===K.value}async function He(e){if(confirm("确定删除该附件？"))try{await Ct(e.attachmentId);try{ee.value.add(Number(e.attachmentId))}catch{}await A()}catch(t){alert(t?.response?.data?.message||"删除失败")}}const Z=v(()=>(i.value?.history||[]).filter(t=>!(t.action==="COMMENT_DELETED"||t.action==="ATTACHMENT_DELETED"||!H.value&&R(t))));async function Be(e){if(confirm("确定删除这条评论？"))try{await Mt(e.commentId),await A()}catch(t){alert(t?.response?.data?.message||"删除失败")}}const ee=v(()=>{const e=new Set,t=i.value?.history||[];for(const n of t)n.action==="ATTACHMENT_DELETED"&&n.attachmentId!=null&&e.add(Number(n.attachmentId));return e});function Fe(e){return e?.action==="ATTACHMENT_ADDED"&&e?.attachmentId!=null&&!ee.value.has(Number(e.attachmentId))}const B={};async function be(e){if(!B[e])try{B[e]=await Tt(e)}catch{B[e]={}}return B[e]||{}}async function je(e){const t=e.attachmentId,n=window.open("","_blank");try{const a=await be(t),o=await ae(t,"inline"),l=o.headers?.["content-type"]||a.contentType||"application/octet-stream",c=new Blob([o.data],{type:l}),r=URL.createObjectURL(c);n?n.location.href=r:window.open(r,"_blank"),setTimeout(()=>URL.revokeObjectURL(r),60*1e3)}catch(a){n&&n.close(),alert(a?.response?.data?.message||"预览失败或附件已被删除")}}async function Je(e){const t=e.attachmentId;try{const n=await be(t),a=await ae(t,"download"),o=new Blob([a.data],{type:a.headers?.["content-type"]||"application/octet-stream"}),l=URL.createObjectURL(o),c=document.createElement("a");c.href=l,c.download=n.name||`file-${t}`,document.body.appendChild(c),c.click(),c.remove(),setTimeout(()=>URL.revokeObjectURL(l),10*1e3)}catch(n){alert(n?.response?.data?.message||"下载失败或附件已被删除")}}function x(e){const t=E(e);return{y:t.isoWeekYear(),w:t.isoWeek()}}function Ye(e){const t=E(e);return{y:t.year(),m:t.month()+1}}const U=v(()=>{const e=new Map;for(const t of Z.value){if(C.value&&t.action!=="ATTACHMENT_ADDED")continue;const n=E(t.occurredAt);if(!n.isValid())continue;const a=n.year(),o=n.month()+1,l=`${a}-${String(o).padStart(2,"0")}`;e.has(l)||e.set(l,{key:l,label:`${a}年${String(o).padStart(2,"0")}月`,sort:a*100+o})}return Array.from(e.values()).sort((t,n)=>n.sort-t.sort).slice(0,24)}),P=v(()=>{const e=new Map;for(const t of Z.value){if(C.value&&t.action!=="ATTACHMENT_ADDED")continue;const n=E(t.occurredAt);if(!n.isValid())continue;const a=n.isoWeekYear(),o=n.isoWeek(),l=n.startOf("isoWeek"),c=n.endOf("isoWeek"),r=`${a}-W${String(o).padStart(2,"0")}`,f=`${a}年第${o}周（${l.format("MM/DD")}–${c.format("MM/DD")}）`;e.has(r)||e.set(r,{key:r,label:f,sort:a*100+o})}return Array.from(e.values()).sort((t,n)=>n.sort-t.sort).slice(0,60)}),ze=v(()=>y.value?`月份：${U.value.find(e=>e.key===y.value)?.label||y.value}`:"选择月份"),Ge=v(()=>b.value?`周次：${P.value.find(e=>e.key===b.value)?.label||b.value}`:"选择周");function pe(e){y.value=e,e&&(M.value="all"),b.value=""}function ke(e){b.value=e,e&&(M.value="all"),y.value=""}L(k,e=>{if(e==="none"){y.value="",b.value="";return}e==="week"&&(y.value="",b.value||(b.value=ce())),e==="month"&&(b.value="",y.value||(y.value=ue()))});const we=v(()=>{const e=Z.value,t=E(),{y:n,w:a}=x(t),{y:o,w:l}=x(t.subtract(1,"week"));return e.filter(c=>{if(C.value&&c.action!=="ATTACHMENT_ADDED")return!1;const r=E(c.occurredAt);if(!r.isValid())return!1;if(k.value==="month"&&y.value){const{y:f,m:h}=Ye(r);if(`${f}-${String(h).padStart(2,"0")}`!==y.value)return!1}if(k.value==="week"&&b.value){const{y:f,w:h}=x(r);if(`${f}-W${String(h).padStart(2,"0")}`!==b.value)return!1}switch(M.value){case"thisWeek":{const{y:f,w:h}=x(r);return f===n&&h===a}case"lastWeek":{const{y:f,w:h}=x(r);return f===o&&h===l}case"thisMonth":return r.year()===t.year()&&r.month()===t.month();case"lastMonth":{const f=t.subtract(1,"month");return r.year()===f.year()&&r.month()===f.month()}default:return!0}})}),qe=v(()=>{const e=we.value;if(k.value==="none")return[{key:"all",label:"全部",items:e}];const t=new Map;for(const a of e){const o=E(a.occurredAt);let l,c,r;if(k.value==="week"){const f=o.isoWeekYear(),h=o.isoWeek(),at=o.startOf("isoWeek"),ot=o.endOf("isoWeek");l=`${f}-W${String(h).padStart(2,"0")}`,c=`${f}年第${h}周（${at.format("MM/DD")}–${ot.format("MM/DD")}）`,r=f*100+h}else{const f=o.year(),h=o.month()+1;l=`${f}-${String(h).padStart(2,"0")}`,c=`${f}年${String(h).padStart(2,"0")}月`,r=f*100+h}t.has(l)||t.set(l,{key:l,label:c,sort:r,items:[]}),t.get(l).items.push(a)}const n=Array.from(t.values()).sort((a,o)=>o.sort-a.sort);for(const a of n)a.items.sort((o,l)=>E(l.occurredAt).valueOf()-E(o.occurredAt).valueOf());return n});ct(async()=>{try{const e=JSON.parse(localStorage.getItem(Me)||"{}");e.viewGrouping&&(k.value=e.viewGrouping),e.timeFilter&&(M.value=e.timeFilter),typeof e.onlyAttachments=="boolean"&&(C.value=e.onlyAttachments),typeof e.selectedMonthKey=="string"&&(y.value=e.selectedMonthKey),typeof e.selectedWeekKey=="string"&&(b.value=e.selectedWeekKey),typeof e.showDeleted=="boolean"&&(H.value=e.showDeleted)}catch{}await A(),await ut(),Ne()}),L([k,M,C,y,b],([e,t,n,a,o,l])=>{localStorage.setItem(Me,JSON.stringify({viewGrouping:e,timeFilter:t,onlyAttachments:n,selectedMonthKey:a,selectedWeekKey:o,showDeleted:l}))}),L(P,e=>{k.value==="week"&&(e.some(n=>n.key===b.value)||(b.value=e[0]?.key||""))}),L(U,e=>{k.value==="month"&&(e.some(n=>n.key===y.value)||(y.value=e[0]?.key||""))}),L(M,e=>{e!=="all"&&(y.value="",b.value="")});function Qe(e){if(!e||typeof e!="string")return null;try{const t=JSON.parse(e);return t&&typeof t=="object"?t:null}catch{return null}}function Xe(e){const t=Qe(e);if(t?.label)return String(t.label);const n=/"label"\s*:\s*"([^"]+)"/.exec(e||"");return n?n[1]:(e||"").trim()}function te(e){const t=String(e||"").toUpperCase(),n=/(UNMARK|UNDO|UNSET|CANCEL|REVOKE|ROLLBACK)/.test(t)||/^UN/.test(t),a=/WEEK/.test(t)||/W(\d{1,2})/.test(t),o=/MONTH/.test(t)||/-?\d{4}-\d{1,2}/.test(t),l=!a&&!o&&/(COMPLETE|COMPLETED|DONE|FINISH|FINISHED)/.test(t);return{raw:t,isUndo:n,isWeek:a,isMonth:o,isOverall:l}}function Ze(e){const t=te(e?.action,e?.note),n=t.isOverall||t.isWeek||t.isMonth;return n&&t.isUndo?"text-danger fw-semibold":n&&!t.isUndo?"text-success fw-semibold":""}function et(e){const t=te(e?.action),n=(e?.note||"").trim(),a=Xe(n)||e?.key||"";if(t.isWeek)return t.isUndo?`撤销上周完成${a?`：${a}`:""}`:`确认上周完成${a?`：${a}`:""}`;if(t.isMonth)return t.isUndo?`撤销上月完成${a?`：${a}`:""}`:`确认上月完成${a?`：${a}`:""}`;if(t.isOverall)return t.isUndo?`撤销完成${a?`：${a}`:""}`:`确认完成${a?`：${a}`:""}`;switch(t.raw){case"CREATE_DRAFT":return"保存草稿";case"SUBMIT":return"用户提交";case"ADMIN_APPROVE":return n?`主任同意：${n}`:"主任同意";case"ADMIN_REJECT":return n?`主任驳回：${n}`:"主任驳回";case"REVIEW_APPROVE":return n?`科室同意：${n}`:"科室同意";case"REVIEW_REJECT":return n?`科室驳回：${n}`:"科室驳回";case"COMMENT_ADDED":return n?`${n}`:"发表意见"}return/(APPROVE)/.test(t.raw)&&/(ADMIN|DIRECTOR)/.test(t.raw)?n?`主任同意：${n}`:"主任同意":/(REJECT)/.test(t.raw)&&/(ADMIN|DIRECTOR)/.test(t.raw)?n?`主任驳回：${n}`:"主任驳回":/(APPROVE|PASS)/.test(t.raw)&&/(REVIEW|DEPT|SECTION)/.test(t.raw)?n?`科室同意：${n}`:"科室同意":/(REJECT)/.test(t.raw)&&/(REVIEW|DEPT|SECTION)/.test(t.raw)?n?`科室驳回：${n}`:"科室驳回":a||n||"（系统记录）"}function tt(e){const t=String(e??"").trim();if(!t)return null;if(t.startsWith("{"))try{const o=JSON.parse(t);if(o&&typeof o.key=="string"&&o.key)return o.key}catch{}const n=t.match(/\b(\d{4})-W(\d{1,2})\b/);if(n)return`${n[1]}-W${String(n[2]).padStart(2,"0")}`;const a=t.match(/\b(\d{4})-(\d{1,2})\b/);return a?`${a[1]}-${String(a[2]).padStart(2,"0")}`:null}const F=v(()=>{const t=[...Array.isArray(i.value?.history)?i.value.history:[]].sort((o,l)=>{const c=E(o?.occurredAt).valueOf()||0,r=E(l?.occurredAt).valueOf()||0;return c-r}),n=new Map,a=new Map;for(const o of t){const l=te(o?.action);if(!l.isWeek&&!l.isMonth)continue;const c=tt(o?.note)||(typeof o?.key=="string"?o.key:null);c&&(l.isWeek&&n.set(c,!l.isUndo),l.isMonth&&a.set(c,!l.isUndo))}return{weekState:n,monthState:a}});function Ee(e){const t=/^(\d{4})-W(\d{1,2})$/.exec(e||"");if(!t)return null;const n=Number(t[1]),a=Number(t[2]);return{year:n,week:a,sort:n*100+a}}function he(e){const t=/^(\d{4})-(\d{1,2})$/.exec(e||"");if(!t)return null;const n=Number(t[1]),a=Number(t[2]);return{year:n,month:a,sort:n*100+a}}const nt=v(()=>{const e=F.value.weekState;if(!e||e.size===0)return!1;const t=E(),n=t.isoWeekYear(),a=t.isoWeek();let o=null,l=-1/0;for(const[c]of e.entries()){const r=Ee(c);if(!r)continue;(r.year<n||r.year===n&&r.week<=a)&&r.sort>l&&(l=r.sort,o=c)}if(!o)for(const[c]of e.entries()){const r=Ee(c);r&&r.sort>l&&(l=r.sort,o=c)}return o?!!e.get(o):!1}),st=v(()=>{const e=F.value.monthState;if(!e||e.size===0)return!1;const t=E(),n=t.year(),a=t.month()+1;let o=null,l=-1/0;for(const[c]of e.entries()){const r=he(c);if(!r)continue;(r.year<n||r.year===n&&r.month<=a)&&r.sort>l&&(l=r.sort,o=c)}if(!o)for(const[c]of e.entries()){const r=he(c);r&&r.sort>l&&(l=r.sort,o=c)}return o?!!e.get(o):!1}),De=v(()=>{const e=String(i.value?.status||"");return!W.value||["DRAFT","SUBMITTED","ADMIN_APPROVED","ADMIN_REJECTED","REVIEW_REJECTED","RETURNED"].includes(e)?e:le.value?nt.value?"WEEK_DONE":"WEEK_NOT_DONE":re.value?st.value?"MONTH_DONE":"MONTH_NOT_DONE":e}),_e=v(()=>{const e=Q().key;return!!F.value.weekState.get(e)}),ge=v(()=>{const e=X().key;return!!F.value.monthState.get(e)});return(e,t)=>i.value?(d(),u("div",Nt,[s("div",$t,[s("div",Ot,[s("h2",It,"#"+m(i.value.id)+" "+m(i.value.title),1),s("span",{class:S(["badge",Ie(De.value)])},m(de(De.value)),3)]),i.value.submittedAt||i.value.createdAt?(d(),u("div",Wt," 最近更新："+m(q(i.value.submittedAt||i.value.createdAt)),1)):p("",!0)]),s("div",St,[t[18]||(t[18]=s("div",{class:"card-header fw-semibold"},"基本信息",-1)),s("div",Rt,[s("div",xt,[s("div",Ut,[t[12]||(t[12]=s("div",{class:"text-body-secondary small mb-1"},"申请类型",-1)),s("div",null,[s("span",Pt,m(i.value.category||"未分类"),1)])]),s("div",Lt,[t[13]||(t[13]=s("div",{class:"text-body-secondary small mb-1"},"影响范围",-1)),s("div",null,m(i.value.impactScope||"-"),1)]),s("div",Vt,[t[14]||(t[14]=s("div",{class:"text-body-secondary small mb-1"},"联系电话",-1)),s("div",null,m(i.value.contactPhone||"-"),1)]),s("div",Kt,[t[15]||(t[15]=s("div",{class:"text-body-secondary small mb-1"},"地点/科室",-1)),s("div",null,m(i.value.location||"-"),1)]),s("div",Ht,[t[16]||(t[16]=s("div",{class:"text-body-secondary small mb-1"},"提交人",-1)),s("div",null,m(i.value.createdByName)+"("+m(i.value.createdByDept)+"/"+m(i.value.createdByEmpId)+")",1)]),s("div",Bt,[t[17]||(t[17]=s("div",{class:"text-body-secondary small mb-1"},"提交时间",-1)),s("div",null,m(q(i.value.submittedAt||i.value.createdAt)),1)])])])]),s("div",Ft,[t[19]||(t[19]=s("div",{class:"card-header fw-semibold"},"需求详情",-1)),s("div",jt,[s("pre",Jt,m(i.value.description),1)])]),s("div",Yt,[t[21]||(t[21]=s("div",{class:"card-header fw-semibold"},"附件",-1)),s("div",zt,[t[20]||(t[20]=s("div",{class:"alert alert-light border py-2 mb-3",role:"alert"},[ne(" 新上传的附件会出现在下方 "),s("b",null,"流转历史"),ne(" 中；如需删除，请在流转历史中点击该条记录的“删除”。（仅允许删除本人上传的附件） ")],-1)),s("div",Gt,[s("input",{type:"file",class:"form-control",ref_key:"fileInput",ref:G,multiple:"",onChange:$e},null,544),s("button",{class:"btn btn-primary",onClick:Oe,disabled:!$.value||V.value},m(V.value?"上传中…":"上传附件"),9,qt)])])]),s("div",Qt,[s("div",Xt,[t[22]||(t[22]=s("span",null,"意见与审批",-1)),O.value||I.value?(d(),u("small",Zt," 当前状态："+m(de(i.value.status)),1)):p("",!0)]),s("div",en,[s("div",tn,[se(s("textarea",{class:"form-control",rows:"4","onUpdate:modelValue":t[0]||(t[0]=n=>w.value=n),placeholder:"填写意见（用于同意/驳回或仅发表评论；临时/其他的“标记完成/撤销完成”也会把这里当备注传给后端 note）"},null,512),[[dt,w.value]])]),s("div",nn,[O.value?(d(),u(g,{key:0},[i.value.status==="SUBMITTED"?(d(),u("button",{key:0,class:"btn btn-success btn-sm",onClick:t[1]||(t[1]=n=>me("admin"))},"主任同意")):p("",!0),i.value.status==="SUBMITTED"?(d(),u("button",{key:1,class:"btn btn-danger btn-sm",onClick:t[2]||(t[2]=n=>ve("admin"))},"主任驳回")):p("",!0)],64)):p("",!0),I.value?(d(),u(g,{key:1},[i.value.status==="ADMIN_APPROVED"?(d(),u("button",{key:0,class:"btn btn-success btn-sm",onClick:t[3]||(t[3]=n=>me("reviewer"))},"科室同意")):p("",!0),i.value.status==="ADMIN_APPROVED"?(d(),u("button",{key:1,class:"btn btn-danger btn-sm",onClick:t[4]||(t[4]=n=>ve("reviewer"))},"科室驳回")):p("",!0)],64)):p("",!0),O.value||I.value?(d(),u("button",{key:2,class:"btn btn-outline-secondary btn-sm",onClick:fe},"仅发表意见")):(d(),u("button",{key:3,class:"btn btn-primary btn-sm",onClick:fe},"发布")),t[23]||(t[23]=s("div",{class:"vr mx-2 d-none d-sm-block"},null,-1)),!W.value&&(O.value||I.value)?(d(),u(g,{key:4},[Te.value?(d(),u("button",{key:0,class:"btn btn-success btn-sm",onClick:We},"标记为已完成")):p("",!0),Ce.value?(d(),u("button",{key:1,class:"btn btn-outline-danger btn-sm",onClick:Se},"撤销已完成")):p("",!0)],64)):p("",!0)])])]),s("div",sn,[s("div",an,[t[28]||(t[28]=s("span",null,"流转历史",-1)),s("div",on,[s("div",ln,[s("button",{type:"button",class:S(["btn btn-outline-secondary",{active:k.value==="none"}]),onClick:t[5]||(t[5]=n=>k.value="none")},"不分组",2),s("button",{type:"button",class:S(["btn btn-outline-secondary",{active:k.value==="week"}]),onClick:t[6]||(t[6]=n=>k.value="week")},"按周",2),s("button",{type:"button",class:S(["btn btn-outline-secondary",{active:k.value==="month"}]),onClick:t[7]||(t[7]=n=>k.value="month")},"按月",2)]),s("div",rn,[se(s("input",{class:"form-check-input",type:"checkbox",id:"onlyAtt","onUpdate:modelValue":t[8]||(t[8]=n=>C.value=n)},null,512),[[Ae,C.value]]),t[24]||(t[24]=s("label",{class:"form-check-label small",for:"onlyAtt"},"仅附件",-1))]),s("div",cn,[se(s("input",{class:"form-check-input",type:"checkbox",id:"showDeleted","onUpdate:modelValue":t[9]||(t[9]=n=>H.value=n)},null,512),[[Ae,H.value]]),t[25]||(t[25]=s("label",{class:"form-check-label small",for:"showDeleted"},"包含已删除",-1))]),k.value==="week"?(d(),u(g,{key:0},[s("div",un,[s("button",dn,m(Ge.value),1),s("ul",mn,[s("li",null,[s("a",{class:"dropdown-item",href:"#",onClick:t[10]||(t[10]=j(n=>ke(""),["prevent"]))},"（全部周）")]),t[26]||(t[26]=s("li",null,[s("hr",{class:"dropdown-divider"})],-1)),(d(!0),u(g,null,J(P.value,n=>(d(),u("li",{key:n.key},[s("a",{class:"dropdown-item",href:"#",onClick:j(a=>ke(n.key),["prevent"])},m(n.label),9,vn)]))),128))])]),W.value&&le.value&&(O.value||I.value||K.value===i.value.createdByEmpId)?(d(),u(g,{key:0},[s("button",{class:"btn btn-success btn-sm",onClick:Re,disabled:_e.value}," 确认该周完成 ",8,fn),s("button",{class:"btn btn-outline-danger btn-sm",onClick:xe,disabled:!_e.value}," 撤销该周完成 ",8,yn)],64)):p("",!0)],64)):p("",!0),k.value==="month"?(d(),u(g,{key:1},[s("div",bn,[s("button",pn,m(ze.value),1),s("ul",kn,[s("li",null,[s("a",{class:"dropdown-item",href:"#",onClick:t[11]||(t[11]=j(n=>pe(""),["prevent"]))},"（全部月份）")]),t[27]||(t[27]=s("li",null,[s("hr",{class:"dropdown-divider"})],-1)),(d(!0),u(g,null,J(U.value,n=>(d(),u("li",{key:n.key},[s("a",{class:"dropdown-item",href:"#",onClick:j(a=>pe(n.key),["prevent"])},m(n.label),9,wn)]))),128))])]),W.value&&re.value&&(O.value||I.value||K.value===i.value.createdByEmpId)?(d(),u(g,{key:0},[s("button",{class:"btn btn-success btn-sm",onClick:Ue,disabled:ge.value}," 确认该月完成 ",8,En),s("button",{class:"btn btn-outline-danger btn-sm",onClick:Pe,disabled:!ge.value}," 撤销该月完成 ",8,hn)],64)):p("",!0)],64)):p("",!0)])]),s("div",Dn,[(d(!0),u(g,null,J(qe.value,n=>(d(),u(g,{key:n.key},[k.value!=="none"?(d(),u("div",_n,[ne(m(n.label)+" ",1),s("span",gn,m(n.items.length),1)])):p("",!0),s("ul",An,[(d(!0),u(g,null,J(n.items,a=>(d(),u("li",{key:a.id??a.occurredAt+"-"+a.action,class:S(["list-group-item d-flex justify-content-between align-items-start",{"text-decoration-line-through opacity-75":R(a)}])},[s("div",null,[s("div",Mn,[s("span",Tn,m(a.actorName),1),s("span",Cn,"("+m(a.actorEmpId)+")",1),s("span",Nn," @ "+m(q(a.occurredAt)),1),R(a)?(d(),u("span",$n,"已删除")):p("",!0)]),s("div",{class:S(["mt-1",Ze(a)])},m(et(a)),3)]),s("div",On,[Fe(a)?(d(),u(g,{key:0},[s("button",{class:"btn btn-sm btn-outline-primary",onClick:o=>je(a)},"预览",8,In),s("button",{class:"btn btn-sm btn-outline-secondary",onClick:o=>Je(a)},"下载",8,Wn)],64)):p("",!0),Ve(a)&&!R(a)?(d(),u("button",{key:1,class:"btn btn-sm btn-outline-danger",onClick:o=>Be(a)},"删除",8,Sn)):Ke(a)&&!R(a)?(d(),u("button",{key:2,class:"btn btn-sm btn-outline-danger",onClick:o=>He(a)},"删除",8,Rn)):p("",!0)])],2))),128))])],64))),128)),we.value.length===0?(d(),u("div",xn,"没有符合条件的记录。")):p("",!0)])])])):p("",!0)}},Hn=lt(Un,[["__scopeId","data-v-b6240fdf"]]);export{Hn as default};
