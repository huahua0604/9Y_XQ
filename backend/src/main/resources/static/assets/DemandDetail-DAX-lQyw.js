import{_ as Ct,g as Nt,r as p,u as Ot,i as b,A as R,k as $t,B as St,c as i,b as f,a,t as d,F as w,d as q,v as ge,n as oe,f as Ke,p as Q,l as He,w as le,o as c}from"./index-zVoxIsoq.js";import{h as re}from"./axios-3glaY4tD.js";import{d as h,i as It}from"./isoWeek-D1M7nHiN.js";import{g as xt,b as Wt,u as Rt,d as Pt,r as Ut,e as Lt,f as Vt,h as Kt,m as Ht,i as Bt,j as Ft,k as jt,n as Jt,o as Yt,p as zt}from"./demand-C0tzFA0b.js";function Gt(P){return re.get(`/api/files/${P}/meta`).then($=>$.data)}function De(P,$="inline"){return re.get(`/api/files/${P}/${$}`,{responseType:"blob"})}function qt(P){return re.delete(`/api/files/${P}`).then($=>$.data)}const Qt={key:0,class:"container my-4"},Xt={class:"d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2"},Zt={class:"d-flex align-items-center gap-2 flex-wrap"},en={class:"d-flex align-items-center gap-2"},tn={key:0,class:"h5 mb-0"},nn={class:"text-body-secondary small"},sn=["disabled"],an={key:0,class:"d-flex align-items-center gap-1"},on=["disabled"],ln=["disabled"],rn={key:0,class:"text-body-secondary small"},cn={class:"card shadow-sm mb-3"},un={class:"card-body"},dn={class:"row g-3"},vn={class:"col-12 col-md-6"},mn={class:"badge text-bg-info"},fn={class:"col-12 col-md-6"},yn={class:"col-6 col-md-3"},bn={class:"col-6 col-md-3"},kn={class:"col-12 col-md-6"},pn={class:"col-12 col-md-6"},hn={class:"card shadow-sm mb-3"},wn={class:"card-body"},En={class:"mb-0 text-wrap",style:{"white-space":"pre-wrap"}},_n={class:"card shadow-sm mb-3"},gn={class:"card-body"},Dn={class:"input-group"},Tn=["disabled"],An={class:"card shadow-sm mb-3"},Mn={class:"card-header fw-semibold d-flex align-items-center justify-content-between"},Cn={key:0,class:"text-body-secondary"},Nn={class:"card-body"},On={class:"mb-2"},$n={class:"d-flex flex-wrap gap-2 align-items-center"},Sn=["disabled"],In={key:0,class:"text-muted"},xn={key:0,class:"mt-2"},Wn={class:"border rounded p-2"},Rn={class:"small text-muted mb-1"},Pn={class:"mt-2 d-flex gap-2"},Un=["disabled"],Ln=["disabled"],Vn={key:0,class:"alert alert-success py-1 mt-2 mb-0"},Kn={key:1,class:"alert alert-danger py-1 mt-2 mb-0"},Hn={class:"card shadow-sm"},Bn={class:"card-header fw-semibold d-flex align-items-center justify-content-between flex-wrap gap-2"},Fn={class:"d-flex align-items-center gap-2 flex-wrap"},jn={class:"btn-group btn-group-sm",role:"group","aria-label":"分组"},Jn=["onClick"],Yn={class:"form-check form-check-sm ms-1"},zn={class:"form-check form-check-sm ms-1"},Gn={class:"dropdown"},qn={class:"btn btn-sm btn-outline-primary dropdown-toggle",type:"button","data-bs-toggle":"dropdown"},Qn={class:"dropdown-menu dropdown-menu-end weeks-menu"},Xn=["onClick"],Zn={key:2,class:"btn btn-outline-secondary btn-sm",disabled:""},es={class:"dropdown"},ts={class:"btn btn-sm btn-outline-primary dropdown-toggle",type:"button","data-bs-toggle":"dropdown"},ns={class:"dropdown-menu dropdown-menu-end months-menu"},ss=["onClick"],as={key:2,class:"btn btn-outline-secondary btn-sm",disabled:""},os={class:"card-body"},ls={key:0,class:"small text-body-secondary fw-semibold mb-1 mt-2"},rs={class:"badge text-bg-light ms-1"},is={class:"list-group mb-2"},cs={class:"d-flex flex-wrap align-items-center gap-2"},us={class:"fw-semibold"},ds={class:"text-body-secondary small"},vs={class:"text-body-secondary small"},ms={key:0,class:"badge text-bg-secondary ms-2"},fs={class:"ms-2 d-flex gap-2"},ys=["onClick"],bs=["onClick"],ks=["onClick"],ps=["onClick"],hs={key:0,class:"text-body-secondary small"},Be="historyViewPrefs/v2",ws={__name:"DemandDetail",setup(P){h.extend(It);const $=Nt(),_=Number($.params.id),r=p(null),F=p(!1),X=p(""),U=p(!1),E=p(""),L=p([]),ie=p([]),Z=p(!1),ce=Ot(),T=b(()=>ce.user?.roles?.includes("ADMIN")),A=b(()=>ce.user?.roles?.includes("REVIEWER")),ee=b(()=>ce.employeeId),j=p(!1),S=b(()=>{const e=r.value?.category||"";return e.includes("周报")||e.includes("月报")}),ue=b(()=>(r.value?.category||"").includes("周报")),de=b(()=>(r.value?.category||"").includes("月报")),Te=b(()=>ue.value?[{key:"none",label:"不分组"},{key:"week",label:"按周"}]:de.value?[{key:"none",label:"不分组"},{key:"month",label:"按月"}]:[{key:"none",label:"不分组"},{key:"week",label:"按周"},{key:"month",label:"按月"}]),Fe=b(()=>!S.value&&r.value?.status==="REVIEW_APPROVED"),je=b(()=>!S.value&&r.value?.status==="COMPLETED"),y=p("week"),M=p("all"),I=p(!1);R(Te,e=>{e.map(n=>n.key).includes(y.value)||(y.value=e[0]?.key||"none")},{immediate:!0});const v=p(""),m=p(""),Ae=p(!1);function Je(){if(Ae.value)return;const e=(r.value?.category||"").toString();e.includes("周报")?(y.value="week",M.value="all"):e.includes("月报")&&(y.value="month",M.value="all"),Ae.value=!0}function Ye(e){const t=Array.from(e.target.files||[]);L.value=t.length?t:null}function ze(e){const t=String(e||"").trim();if(y.value==="week"&&m.value){const n=m.value,s=C(n);return JSON.stringify({key:n,label:s,filename:t})}if(y.value==="month"&&v.value){const n=v.value,s=C(n);return JSON.stringify({key:n,label:s,filename:t})}return t}function Ge(){if(y.value==="week"&&m.value){const e=V(m.value);if(e)return h().year(e.year).month(0).date(4).isoWeek(e.week).startOf("isoWeek").hour(12).minute(0).second(0).format("YYYY-MM-DDTHH:mm:ss")}if(y.value==="month"&&v.value){const e=K(v.value);if(e)return h().year(e.year).month(e.month-1).date(15).hour(12).minute(0).second(0).format("YYYY-MM-DDTHH:mm:ss")}return""}async function qe(){if(!(!L.value||L.value.length===0)){Z.value=!0;try{for(const e of L.value){const t=ze(e?.name),n=Ge();await Rt(_,e,{note:t,occurredAt:n})}await g()}catch(e){console.error("附件上传失败",e),alert(e?.response?.data?.message||e?.message||"附件上传失败")}finally{L.value=null,Z.value=!1,ve.value&&(ve.value.value="")}}}const ve=p(null);function me(e){return e?String(e).replace("T"," ").slice(0,19):""}function fe(){X.value=r.value?.title||""}function Qe(){fe(),F.value=!0}function Xe(){fe(),F.value=!1}async function Ze(){const e=X.value.trim();if(!e){alert("标题不能为空");return}U.value=!0;try{r.value=await Wt(_,e),F.value=!1}catch(t){alert(t?.response?.data?.message||"修改标题失败")}finally{U.value=!1}}function et(e){switch((e||"").toUpperCase()){case"DRAFT":return"text-bg-secondary";case"SUBMITTED":return"text-bg-info";case"ADMIN_APPROVED":case"IN_REVIEW":return"text-bg-primary";case"RETURNED":return"text-bg-warning";case"REJECTED":return"text-bg-danger";case"APPROVED":case"DONE":return"text-bg-success";case"COMPLETED":return"text-bg-success";case"WEEK_DONE":case"MONTH_DONE":return"text-bg-success";case"WEEK_NOT_DONE":case"MONTH_NOT_DONE":return"text-bg-secondary";default:return"text-bg-secondary"}}function ye(e){switch(e){case"DRAFT":return"草稿";case"SUBMITTED":return"待主任审批";case"ADMIN_APPROVED":return"主任同意";case"ADMIN_REJECTED":return"主任驳回";case"REVIEW_APPROVED":return"科室同意";case"REVIEW_REJECTED":return"科室驳回";case"COMPLETED":return"已完成";case"WEEK_DONE":return"上周已完成";case"WEEK_NOT_DONE":return"上周未完成";case"MONTH_DONE":return"上月已完成";case"MONTH_NOT_DONE":return"上月未完成";default:return e||"未知"}}async function Me(e){if(!E.value.trim()){alert("请填写审批意见");return}e==="admin"?await Pt(_,E.value.trim()):await Ut(_,E.value.trim()),E.value="",await g()}async function Ce(e){if(!E.value.trim()){alert("请填写驳回理由");return}e==="admin"?await Lt(_,E.value.trim()):await Vt(_,E.value.trim()),E.value="",await g()}function tt(e){const t=e.trim();if(!t)return"";if(S.value){if(y.value==="week"&&m.value){const n=m.value,s=C(n);return JSON.stringify({key:n,label:s,text:t})}if(y.value==="month"&&v.value){const n=v.value,s=C(n);return JSON.stringify({key:n,label:s,text:t})}}return t}async function Ne(){const e=E.value.trim();if(!e)return;const t=tt(e);await Kt(_,t),E.value="",await g()}async function nt(){await Ht(_,E.value.trim()||""),E.value="",await g()}async function st(){await Bt(_,E.value.trim()||""),E.value="",await g()}function be(){const e=h().subtract(1,"week"),t=`${e.isoWeekYear()}-W${String(e.isoWeek()).padStart(2,"0")}`,n=e.startOf("isoWeek"),s=e.endOf("isoWeek"),o=`${e.isoWeekYear()}年第${e.isoWeek()}周（${n.format("MM/DD")}~${s.format("MM/DD")}）`;return{key:t,label:o}}function ke(){if(m.value){const e=z.value.find(t=>t.key===m.value);return{key:m.value,label:e?.label||m.value}}return be()}function pe(){if(v.value){const s=Y.value.find(o=>o.key===v.value);return{key:v.value,label:s?.label||v.value}}const e=h().subtract(1,"month"),t=`${e.year()}-${String(e.month()+1).padStart(2,"0")}`,n=`${e.year()}年${String(e.month()+1).padStart(2,"0")}月`;return{key:t,label:n}}async function at(){const{key:e,label:t}=ke();await Ft(_,e,t),await g()}async function ot(){const{key:e,label:t}=ke();await jt(_,e,t),await g()}async function lt(){const{key:e,label:t}=pe();await Jt(_,e,t),await g()}async function rt(){const{key:e,label:t}=pe();await Yt(_,e,t),await g()}async function it(){for(const e of ie.value)try{URL.revokeObjectURL(e.src)}catch{}if(ie.value=[],!!r.value?.attachments?.length){for(const e of r.value.attachments)if(!we.value.has(Number(e.id))&&(e.contentType||"").startsWith("image/"))try{const t=await De(e.id,"inline"),n=t.headers?.["content-type"]||e.contentType,s=new Blob([t.data],{type:n}),o=URL.createObjectURL(s);ie.value.push({id:e.id,name:e.originalFilename,src:o})}catch(t){console.warn("跳过无效图片附件",e.id,t?.response?.status);continue}}}async function g(){r.value=await xt(_),fe(),await it()}const Oe=b(()=>{const e=new Set;for(const t of r.value?.history||[])t.action==="COMMENT_DELETED"&&t.commentId!=null&&e.add(`C:${t.commentId}`),t.action==="ATTACHMENT_DELETED"&&t.attachmentId!=null&&e.add(`A:${t.attachmentId}`);return e});function J(e){return e.action==="COMMENT_ADDED"&&e.commentId!=null?Oe.value.has(`C:${e.commentId}`):e.action==="ATTACHMENT_ADDED"&&e.attachmentId!=null?Oe.value.has(`A:${e.attachmentId}`):!1}function ct(e){return e?.action==="COMMENT_ADDED"&&e?.commentId!=null&&e?.actorEmpId===ee.value}function ut(e){return e?.action==="ATTACHMENT_ADDED"&&e?.attachmentId!=null&&e?.actorEmpId===ee.value}async function dt(e){if(confirm("确定删除该附件？"))try{await qt(e.attachmentId);try{we.value.add(Number(e.attachmentId))}catch{}await g()}catch(t){alert(t?.response?.data?.message||"删除失败")}}const he=b(()=>(r.value?.history||[]).filter(t=>!(t.action==="COMMENT_DELETED"||t.action==="ATTACHMENT_DELETED"||!j.value&&J(t))));async function vt(e){if(confirm("确定删除这条评论？"))try{await zt(e.commentId),await g()}catch(t){alert(t?.response?.data?.message||"删除失败")}}const we=b(()=>{const e=new Set,t=r.value?.history||[];for(const n of t)n.action==="ATTACHMENT_DELETED"&&n.attachmentId!=null&&e.add(Number(n.attachmentId));return e});function mt(e){return e?.action==="ATTACHMENT_ADDED"&&e?.attachmentId!=null&&!we.value.has(Number(e.attachmentId))}const te={};async function $e(e){if(!te[e])try{te[e]=await Gt(e)}catch{te[e]={}}return te[e]||{}}async function ft(e){const t=e.attachmentId,n=window.open("","_blank");try{const s=await $e(t),o=await De(t,"inline"),l=o.headers?.["content-type"]||s.contentType||"application/octet-stream",u=new Blob([o.data],{type:l}),k=URL.createObjectURL(u);n?n.location.href=k:window.open(k,"_blank"),setTimeout(()=>URL.revokeObjectURL(k),60*1e3)}catch(s){n&&n.close(),alert(s?.response?.data?.message||"预览失败或附件已被删除")}}async function yt(e){const t=e.attachmentId;try{const n=await $e(t),s=await De(t,"download"),o=new Blob([s.data],{type:s.headers?.["content-type"]||"application/octet-stream"}),l=URL.createObjectURL(o),u=document.createElement("a");u.href=l,u.download=n.name||`file-${t}`,document.body.appendChild(u),u.click(),u.remove(),setTimeout(()=>URL.revokeObjectURL(l),10*1e3)}catch(n){alert(n?.response?.data?.message||"下载失败或附件已被删除")}}function ne(e){const t=h(e);return{y:t.isoWeekYear(),w:t.isoWeek()}}const Y=b(()=>{const e=new Map;for(const t of he.value){if(I.value&&t.action!=="ATTACHMENT_ADDED")continue;const n=G(t);!n||!K(n.key)||e.has(n.key)||e.set(n.key,{key:n.key,label:n.label,sort:n.sort})}return[...e.values()].sort((t,n)=>n.sort-t.sort)}),z=b(()=>{const e=new Map;for(const t of he.value){if(I.value&&t.action!=="ATTACHMENT_ADDED")continue;const n=G(t);!n||!V(n.key)||e.has(n.key)||e.set(n.key,{key:n.key,label:n.label,sort:n.sort})}return[...e.values()].sort((t,n)=>n.sort-t.sort)}),bt=b(()=>v.value?`月份：${Y.value.find(e=>e.key===v.value)?.label||v.value}`:"选择月份"),kt=b(()=>m.value?`周次：${z.value.find(e=>e.key===m.value)?.label||m.value}`:"选择周");function Se(e){v.value=e,e&&(M.value="all"),m.value=""}function Ie(e){m.value=e,e&&(M.value="all"),v.value=""}function xe(){const e=z.value;if(!e.length)return"";const{key:t}=be(),n=V(t);if(!n)return e[0].key;const s=n.sort;let o=e[0],l=Math.abs((e[0].sort??0)-s);for(const u of e){const k=Math.abs((u.sort??0)-s);k<l&&(o=u,l=k)}return o.key}function We(){const e=Y.value;if(!e.length)return"";const t=h().subtract(1,"month"),n=`${t.year()}-${String(t.month()+1).padStart(2,"0")}`,s=K(n);if(!s)return e[0].key;const o=s.sort;let l=e[0],u=Math.abs((e[0].sort??0)-o);for(const k of e){const D=Math.abs((k.sort??0)-o);D<u&&(l=k,u=D)}return l.key}R(y,e=>{if(e==="none"){v.value="",m.value="";return}if(e==="week"&&(v.value="",!m.value)){const t=xe();t&&(m.value=t)}if(e==="month"&&(m.value="",!v.value)){const t=We();t&&(v.value=t)}});const Re=b(()=>{const e=he.value,t=h(),{y:n,w:s}=ne(t),{y:o,w:l}=ne(t.subtract(1,"week"));return e.filter(u=>{if(I.value&&u.action!=="ATTACHMENT_ADDED")return!1;const k=G(u);if(y.value==="week"&&m.value&&(!k||k.key!==m.value)||y.value==="month"&&v.value&&(!k||k.key!==v.value))return!1;const D=h(u.occurredAt);if(!D.isValid())return!1;switch(M.value){case"thisWeek":{const{y:B,w:_e}=ne(D);return B===n&&_e===s}case"lastWeek":{const{y:B,w:_e}=ne(D);return B===o&&_e===l}case"thisMonth":return D.year()===t.year()&&D.month()===t.month();case"lastMonth":{const B=t.subtract(1,"month");return D.year()===B.year()&&D.month()===B.month()}default:return!0}})}),pt=b(()=>{const e=Re.value;if(y.value==="week"){const n=new Map;for(const o of e){const l=G(o);l&&(n.has(l.key)||n.set(l.key,{key:l.key,label:l.label,sort:l.sort,items:[]}),n.get(l.key).items.push(o))}const s=[...n.values()].sort((o,l)=>l.sort-o.sort);return s.forEach(o=>o.items.sort((l,u)=>h(u.occurredAt).valueOf()-h(l.occurredAt).valueOf())),s}if(y.value==="month"){const n=new Map;for(const o of e){const l=G(o);l&&(n.has(l.key)||n.set(l.key,{...l,items:[]}),n.get(l.key).items.push(o))}const s=[...n.values()].sort((o,l)=>l.sort-o.sort);return s.forEach(o=>o.items.sort((l,u)=>h(u.occurredAt).valueOf()-h(l.occurredAt).valueOf())),s}return[{key:"all",label:"全部",items:e.slice().sort((n,s)=>h(s.occurredAt).valueOf()-h(n.occurredAt).valueOf())}]});$t(async()=>{try{const e=JSON.parse(localStorage.getItem(Be)||"{}");e.viewGrouping&&(y.value=e.viewGrouping),e.timeFilter&&(M.value=e.timeFilter),typeof e.onlyAttachments=="boolean"&&(I.value=e.onlyAttachments),typeof e.selectedMonthKey=="string"&&(v.value=e.selectedMonthKey),typeof e.selectedWeekKey=="string"&&(m.value=e.selectedWeekKey),typeof e.showDeleted=="boolean"&&(j.value=e.showDeleted)}catch{}await g(),await St(),Je()}),R([y,M,I,v,m,j],([e,t,n,s,o,l])=>{localStorage.setItem(Be,JSON.stringify({viewGrouping:e,timeFilter:t,onlyAttachments:n,selectedMonthKey:s,selectedWeekKey:o,showDeleted:l}))}),R(z,e=>{if(y.value==="week"){if(!m.value&&e.length){const t=xe();t&&(m.value=t);return}m.value&&(e.some(n=>n.key===m.value)||(m.value=""))}}),R(Y,e=>{if(y.value==="month"){if(!v.value&&e.length){const t=We();t&&(v.value=t);return}v.value&&(e.some(n=>n.key===v.value)||(v.value=""))}}),R(M,e=>{e!=="all"&&(v.value="",m.value="")});function Ee(e){if(!e||typeof e!="string")return null;try{const t=JSON.parse(e);return t&&typeof t=="object"?t:null}catch{return null}}function ht(e){const t=Ee(e);if(t?.label)return String(t.label);const n=/"label"\s*:\s*"([^"]+)"/.exec(e||"");return n?n[1]:(e||"").trim()}function se(e){const t=String(e||"").toUpperCase(),n=/(UNMARK|UNDO|UNSET|CANCEL|REVOKE|ROLLBACK)/.test(t)||/^UN/.test(t),s=/WEEK/.test(t)||/W(\d{1,2})/.test(t),o=/MONTH/.test(t)||/-?\d{4}-\d{1,2}/.test(t),l=!s&&!o&&/(COMPLETE|COMPLETED|DONE|FINISH|FINISHED)/.test(t);return{raw:t,isUndo:n,isWeek:s,isMonth:o,isOverall:l}}function wt(e){const t=se(e?.action,e?.note),n=t.isOverall||t.isWeek||t.isMonth;return n&&t.isUndo?"text-danger fw-semibold":n&&!t.isUndo?"text-success fw-semibold":""}function Et(e){return(r.value?.attachments||[]).find(n=>String(n.id)===String(e))?.originalFilename||`附件 #${e}`}function _t(e){const t=se(e?.action),n=(e?.note||"").trim(),s=ht(n)||e?.key||"";if(t.isWeek)return t.isUndo?`撤销${s?`${s}`:""}已完成`:`确认${s?`${s}`:""}已完成`;if(t.isMonth)return t.isUndo?`撤销${s?`${s}`:""}已完成`:`确认${s?`${s}`:""}已完成`;if(t.isOverall)return t.isUndo?`撤销完成${s?`：${s}`:""}`:`确认完成${s?`：${s}`:""}`;switch(t.raw){case"CREATE_DRAFT":return"保存草稿";case"SUBMIT":return"用户提交";case"ADMIN_APPROVE":return n?`主任同意：${n}`:"主任同意";case"ADMIN_REJECT":return n?`主任驳回：${n}`:"主任驳回";case"REVIEW_APPROVE":return n?`科室同意：${n}`:"科室同意";case"REVIEW_REJECT":return n?`科室驳回：${n}`:"科室驳回";case"COMMENT_ADDED":{const l=Ee(n);return l&&l.text?l.text:n?`${n}`:"发表意见"}case"ATTACHMENT_ADDED":{const l=Ee(n),u=l?.filename||(e?.attachmentId?Et(e.attachmentId):"")||"附件";return l?.label&&`${l.label}`,`上传附件：${u}`}}return/(APPROVE)/.test(t.raw)&&/(ADMIN|DIRECTOR)/.test(t.raw)?n?`主任同意：${n}`:"主任同意":/(REJECT)/.test(t.raw)&&/(ADMIN|DIRECTOR)/.test(t.raw)?n?`主任驳回：${n}`:"主任驳回":/(APPROVE|PASS)/.test(t.raw)&&/(REVIEW|DEPT|SECTION)/.test(t.raw)?n?`科室同意：${n}`:"科室同意":/(REJECT)/.test(t.raw)&&/(REVIEW|DEPT|SECTION)/.test(t.raw)?n?`科室驳回：${n}`:"科室驳回":s||n||"（系统记录）"}function Pe(e){const t=String(e??"").trim();if(!t)return null;if(t.startsWith("{"))try{const o=JSON.parse(t);if(o&&typeof o.key=="string"&&o.key)return o.key}catch{}const n=t.match(/\b(\d{4})-W(\d{1,2})\b/);if(n)return`${n[1]}-W${String(n[2]).padStart(2,"0")}`;const s=t.match(/\b(\d{4})-(\d{1,2})\b/);return s?`${s[1]}-${String(s[2]).padStart(2,"0")}`:null}function C(e){const t=V(e);if(t){const o=h().year(t.year).month(0).date(4).isoWeek(t.week).startOf("isoWeek"),l=o.endOf("isoWeek");return`${t.year}年第${t.week}周（${o.format("MM/DD")}~${l.format("MM/DD")}）`}const n=K(e);return n?`${n.year}年${String(n.month).padStart(2,"0")}月`:e}function G(e){const t=se(e?.action),n=Pe(e?.note)||(typeof e?.key=="string"?e.key.trim():"");if(n){const o=V(n);if(o)return{key:n,label:C(n),sort:o.sort};const l=K(n);if(l)return{key:n,label:C(n),sort:l.sort}}if(t.isWeek||t.isMonth)return null;const s=h(e?.occurredAt);if(!s.isValid())return null;if(y.value==="week"){const o=s.isoWeekYear(),l=s.isoWeek(),u=`${o}-W${String(l).padStart(2,"0")}`,k=V(u);return k?{key:u,label:C(u),sort:k.sort}:null}if(y.value==="month"){const o=s.year(),l=s.month()+1,u=`${o}-${String(l).padStart(2,"0")}`,k=K(u);return k?{key:u,label:C(u),sort:k.sort}:null}return null}const ae=b(()=>{const t=[...Array.isArray(r.value?.history)?r.value.history:[]].sort((o,l)=>{const u=h(o?.occurredAt).valueOf()||0,k=h(l?.occurredAt).valueOf()||0;return u-k}),n=new Map,s=new Map;for(const o of t){const l=se(o?.action);if(!l.isWeek&&!l.isMonth)continue;const u=Pe(o?.note)||(typeof o?.key=="string"?o.key:null);u&&(l.isWeek&&n.set(u,!l.isUndo),l.isMonth&&s.set(u,!l.isUndo))}return{weekState:n,monthState:s}});function V(e){const t=/^(\d{4})-W(\d{1,2})$/.exec(e||"");if(!t)return null;const n=Number(t[1]),s=Number(t[2]);return{year:n,week:s,sort:n*100+s}}function K(e){const t=/^(\d{4})-(\d{1,2})$/.exec(e||"");if(!t)return null;const n=Number(t[1]),s=Number(t[2]);return{year:n,month:s,sort:n*100+s}}const gt=b(()=>{const e=ae.value.weekState;if(!e||e.size===0)return!1;const{key:t}=be();return!!e.get(t)}),Dt=b(()=>{const e=ae.value.monthState;if(!e||e.size===0)return!1;const t=h().subtract(1,"month"),n=`${t.year()}-${String(t.month()+1).padStart(2,"0")}`;return!!e.get(n)}),Ue=b(()=>{const e=String(r.value?.status||"");return!S.value||["DRAFT","SUBMITTED","ADMIN_APPROVED","ADMIN_REJECTED","REVIEW_REJECTED","RETURNED"].includes(e)?e:ue.value?gt.value?"WEEK_DONE":"WEEK_NOT_DONE":de.value?Dt.value?"MONTH_DONE":"MONTH_NOT_DONE":e}),Le=b(()=>{const e=ke().key;return!!ae.value.weekState.get(e)}),Ve=b(()=>{const e=pe().key;return!!ae.value.monthState.get(e)}),N=p(!1),x=p(""),W=p(!1),H=p(""),O=p(""),Tt=b(()=>{const e=r.value?.contactPhone;return!!e&&e.trim().length>0});function At(){N.value=!N.value,H.value="",O.value="",N.value&&!x.value&&(x.value=`需求提醒：${r.value?.title||""}，当前状态：${ye(r.value?.status)}`)}async function Mt(){if(H.value="",O.value="",!Tt.value){O.value="联系电话为空，无法发送短信";return}const e=(x.value||"").trim();if(!e){O.value="短信内容不能为空";return}try{W.value=!0,await re.post(`/api/demands/${r.value.id}/sms/notify`,{content:e}),H.value="短信已提交发送",N.value=!1}catch(t){O.value=t?.response?.data?.message||t?.message||"短信发送失败"}finally{W.value=!1}}return R(()=>r.value?.id,()=>{N.value=!1,x.value="",H.value="",O.value="",W.value=!1}),(e,t)=>r.value?(c(),i("div",Qt,[a("div",Xt,[a("div",Zt,[a("div",en,[F.value?(c(),i(w,{key:1},[a("span",nn,"#"+d(r.value.id),1),q(a("input",{"onUpdate:modelValue":t[0]||(t[0]=n=>X.value=n),class:"form-control form-control-sm",style:{"min-width":"240px"},disabled:U.value},null,8,sn),[[ge,X.value]])],64)):(c(),i("h2",tn,"#"+d(r.value.id)+" "+d(r.value.title),1)),a("span",{class:oe(["badge",et(Ue.value)])},d(ye(Ue.value)),3)]),T.value?(c(),i("div",an,[F.value?(c(),i(w,{key:1},[a("button",{class:"btn btn-primary btn-sm",onClick:Ze,disabled:U.value},d(U.value?"保存中…":"保存"),9,on),a("button",{class:"btn btn-outline-secondary btn-sm",onClick:Xe,disabled:U.value}," 取消 ",8,ln)],64)):(c(),i("button",{key:0,class:"btn btn-outline-secondary btn-sm",onClick:Qe}," 修改标题 "))])):f("",!0)]),r.value.submittedAt||r.value.createdAt?(c(),i("div",rn," 最近更新："+d(me(r.value.submittedAt||r.value.createdAt)),1)):f("",!0)]),a("div",cn,[t[18]||(t[18]=a("div",{class:"card-header fw-semibold"},"基本信息",-1)),a("div",un,[a("div",dn,[a("div",vn,[t[12]||(t[12]=a("div",{class:"text-body-secondary small mb-1"},"申请类型",-1)),a("div",null,[a("span",mn,d(r.value.category||"未分类"),1)])]),a("div",fn,[t[13]||(t[13]=a("div",{class:"text-body-secondary small mb-1"},"影响范围",-1)),a("div",null,d(r.value.impactScope||"-"),1)]),a("div",yn,[t[14]||(t[14]=a("div",{class:"text-body-secondary small mb-1"},"联系电话",-1)),a("div",null,d(r.value.contactPhone||"-"),1)]),a("div",bn,[t[15]||(t[15]=a("div",{class:"text-body-secondary small mb-1"},"地点/科室",-1)),a("div",null,d(r.value.location||"-"),1)]),a("div",kn,[t[16]||(t[16]=a("div",{class:"text-body-secondary small mb-1"},"提交人",-1)),a("div",null,d(r.value.createdByName)+"("+d(r.value.createdByDept)+"/"+d(r.value.createdByEmpId)+")",1)]),a("div",pn,[t[17]||(t[17]=a("div",{class:"text-body-secondary small mb-1"},"提交时间",-1)),a("div",null,d(me(r.value.submittedAt||r.value.createdAt)),1)])])])]),a("div",hn,[t[19]||(t[19]=a("div",{class:"card-header fw-semibold"},"需求详情",-1)),a("div",wn,[a("pre",En,d(r.value.description),1)])]),a("div",_n,[t[21]||(t[21]=a("div",{class:"card-header fw-semibold"},"附件",-1)),a("div",gn,[t[20]||(t[20]=a("div",{class:"alert alert-light border py-2 mb-3",role:"alert"},[Ke(" 新上传的附件会出现在下方流转历史，"),a("b",null,"（周报或月报注意时间选取，默认为最新一周或最新一月）")],-1)),a("div",Dn,[a("input",{type:"file",class:"form-control",ref_key:"fileInput",ref:ve,multiple:"",onChange:Ye},null,544),a("button",{class:"btn btn-primary",onClick:qe,disabled:!L.value||Z.value},d(Z.value?"上传中…":"上传附件"),9,Tn)])])]),a("div",An,[a("div",Mn,[t[22]||(t[22]=a("span",null,"意见与审批",-1)),T.value||A.value?(c(),i("small",Cn," 当前状态："+d(ye(r.value.status)),1)):f("",!0)]),a("div",Nn,[a("div",On,[q(a("textarea",{class:"form-control",rows:"4","onUpdate:modelValue":t[1]||(t[1]=n=>E.value=n),placeholder:"填写意见（周报或月报需要注意时间选取，默认为最新一周或最新一月）"},null,512),[[ge,E.value]])]),a("div",$n,[T.value?(c(),i(w,{key:0},[r.value.status==="SUBMITTED"?(c(),i("button",{key:0,class:"btn btn-success btn-sm",onClick:t[2]||(t[2]=n=>Me("admin"))},"主任同意")):f("",!0),r.value.status==="SUBMITTED"?(c(),i("button",{key:1,class:"btn btn-danger btn-sm",onClick:t[3]||(t[3]=n=>Ce("admin"))},"主任驳回")):f("",!0)],64)):f("",!0),A.value?(c(),i(w,{key:1},[r.value.status==="ADMIN_APPROVED"?(c(),i("button",{key:0,class:"btn btn-success btn-sm",onClick:t[4]||(t[4]=n=>Me("reviewer"))},"科室同意")):f("",!0),r.value.status==="ADMIN_APPROVED"?(c(),i("button",{key:1,class:"btn btn-danger btn-sm",onClick:t[5]||(t[5]=n=>Ce("reviewer"))},"科室驳回")):f("",!0)],64)):f("",!0),T.value||A.value?(c(),i("button",{key:2,class:"btn btn-outline-secondary btn-sm",onClick:Ne},"仅发表意见")):(c(),i("button",{key:3,class:"btn btn-primary btn-sm",onClick:Ne},"发布")),T.value||A.value?(c(),i(w,{key:4},[a("button",{class:"btn btn-outline-primary btn-sm",disabled:W.value||!r.value?.contactPhone,onClick:At},d(N.value?"收起短信":"短信通知"),9,Sn),r.value?.contactPhone?f("",!0):(c(),i("small",In," 联系电话为空 "))],64)):f("",!0),t[23]||(t[23]=a("div",{class:"vr mx-2 d-none d-sm-block"},null,-1)),!S.value&&(T.value||A.value)?(c(),i(w,{key:5},[Fe.value?(c(),i("button",{key:0,class:"btn btn-success btn-sm",onClick:nt},"标记为已完成")):f("",!0),je.value?(c(),i("button",{key:1,class:"btn btn-danger btn-sm",onClick:st},"撤销已完成")):f("",!0)],64)):f("",!0)]),N.value&&(T.value||A.value)?(c(),i("div",xn,[a("div",Wn,[a("div",Rn," 发送到："+d(r.value?.contactPhone),1),q(a("textarea",{class:"form-control form-control-sm",rows:"2","onUpdate:modelValue":t[6]||(t[6]=n=>x.value=n),placeholder:"短信内容（按模板规则：这里只填变量值，不要带{}）"},null,512),[[ge,x.value]]),a("div",Pn,[a("button",{class:"btn btn-primary btn-sm",onClick:Mt,disabled:W.value||!x.value.trim()},d(W.value?"发送中…":"发送短信"),9,Un),a("button",{class:"btn btn-outline-secondary btn-sm",onClick:t[7]||(t[7]=n=>N.value=!1),disabled:W.value}," 取消 ",8,Ln)]),H.value?(c(),i("div",Vn,d(H.value),1)):f("",!0),O.value?(c(),i("div",Kn,d(O.value),1)):f("",!0)])])):f("",!0)])]),a("div",Hn,[a("div",Bn,[t[28]||(t[28]=a("span",null,"流转历史",-1)),a("div",Fn,[a("div",jn,[(c(!0),i(w,null,Q(Te.value,n=>(c(),i("button",{key:n.key,type:"button",class:oe(["btn btn-outline-secondary",{active:y.value===n.key}]),onClick:s=>y.value=n.key},d(n.label),11,Jn))),128))]),a("div",Yn,[q(a("input",{class:"form-check-input",type:"checkbox",id:"onlyAtt","onUpdate:modelValue":t[8]||(t[8]=n=>I.value=n)},null,512),[[He,I.value]]),t[24]||(t[24]=a("label",{class:"form-check-label small",for:"onlyAtt"},"仅附件",-1))]),a("div",zn,[q(a("input",{class:"form-check-input",type:"checkbox",id:"showDeleted","onUpdate:modelValue":t[9]||(t[9]=n=>j.value=n)},null,512),[[He,j.value]]),t[25]||(t[25]=a("label",{class:"form-check-label small",for:"showDeleted"},"包含已删除",-1))]),y.value==="week"?(c(),i(w,{key:0},[a("div",Gn,[a("button",qn,d(kt.value),1),a("ul",Qn,[a("li",null,[a("a",{class:"dropdown-item",href:"#",onClick:t[10]||(t[10]=le(n=>Ie(""),["prevent"]))},"（全部周）")]),t[26]||(t[26]=a("li",null,[a("hr",{class:"dropdown-divider"})],-1)),(c(!0),i(w,null,Q(z.value,n=>(c(),i("li",{key:n.key},[a("a",{class:"dropdown-item",href:"#",onClick:le(s=>Ie(n.key),["prevent"])},d(n.label),9,Xn)]))),128))])]),S.value&&ue.value&&(T.value||A.value||ee.value===r.value.createdByEmpId)?(c(),i(w,{key:0},[m.value&&!Le.value?(c(),i("button",{key:0,class:"btn btn-success btn-sm",onClick:at}," 确认该周完成 ")):m.value&&Le.value?(c(),i("button",{key:1,class:"btn btn-danger btn-sm",onClick:ot}," 撤销该周完成 ")):(c(),i("button",Zn," 请先选择周次 "))],64)):f("",!0)],64)):f("",!0),y.value==="month"?(c(),i(w,{key:1},[a("div",es,[a("button",ts,d(bt.value),1),a("ul",ns,[a("li",null,[a("a",{class:"dropdown-item",href:"#",onClick:t[11]||(t[11]=le(n=>Se(""),["prevent"]))},"（全部月份）")]),t[27]||(t[27]=a("li",null,[a("hr",{class:"dropdown-divider"})],-1)),(c(!0),i(w,null,Q(Y.value,n=>(c(),i("li",{key:n.key},[a("a",{class:"dropdown-item",href:"#",onClick:le(s=>Se(n.key),["prevent"])},d(n.label),9,ss)]))),128))])]),S.value&&de.value&&(T.value||A.value||ee.value===r.value.createdByEmpId)?(c(),i(w,{key:0},[v.value&&!Ve.value?(c(),i("button",{key:0,class:"btn btn-success btn-sm",onClick:lt}," 确认该月完成 ")):v.value&&Ve.value?(c(),i("button",{key:1,class:"btn btn-danger btn-sm",onClick:rt}," 撤销该月完成 ")):(c(),i("button",as," 请先选择月份 "))],64)):f("",!0)],64)):f("",!0)])]),a("div",os,[(c(!0),i(w,null,Q(pt.value,n=>(c(),i(w,{key:n.key},[y.value!=="none"?(c(),i("div",ls,[Ke(d(n.label)+" ",1),a("span",rs,d(n.items.length),1)])):f("",!0),a("ul",is,[(c(!0),i(w,null,Q(n.items,s=>(c(),i("li",{key:s.id??s.occurredAt+"-"+s.action,class:oe(["list-group-item d-flex justify-content-between align-items-start",{"text-decoration-line-through opacity-75":J(s)}])},[a("div",null,[a("div",cs,[a("span",us,d(s.actorName),1),a("span",ds,"("+d(s.actorEmpId)+")",1),a("span",vs," @ "+d(me(s.occurredAt)),1),J(s)?(c(),i("span",ms,"已删除")):f("",!0)]),a("div",{class:oe(["mt-1",wt(s)])},d(_t(s)),3)]),a("div",fs,[mt(s)?(c(),i(w,{key:0},[a("button",{class:"btn btn-sm btn-outline-primary",onClick:o=>ft(s)},"预览",8,ys),a("button",{class:"btn btn-sm btn-outline-secondary",onClick:o=>yt(s)},"下载",8,bs)],64)):f("",!0),ct(s)&&!J(s)?(c(),i("button",{key:1,class:"btn btn-sm btn-outline-danger",onClick:o=>vt(s)},"删除",8,ks)):ut(s)&&!J(s)?(c(),i("button",{key:2,class:"btn btn-sm btn-outline-danger",onClick:o=>dt(s)},"删除",8,ps)):f("",!0)])],2))),128))])],64))),128)),Re.value.length===0?(c(),i("div",hs,"没有符合条件的记录。")):f("",!0)])])])):f("",!0)}},Ts=Ct(ws,[["__scopeId","data-v-866f26d5"]]);export{Ts as default};
